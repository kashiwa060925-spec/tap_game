
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ハクスラ・タップRPG（統合・軽量版）</title>
<meta name="theme-color" content="#0f1220">


  <link rel="stylesheet" href="./assets/css/styles.css" />
</head>
<body>
<!-- ============ Start ============ -->
<div id="startOverlay">
  <div class="start-bg" style="position:absolute;inset:0;background:linear-gradient(180deg,#0c1224,#090e1a 60%,#0b0f1f)"></div>
  <div class="start-wrap" style="position:relative;display:flex;align-items:center;justify-content:center;width:100%;min-height:100dvh;padding:28px">
    <div class="start-box" style="width:min(720px,92vw);display:grid;gap:1rem;justify-items:center;text-align:center;background:#151a2eaa;border:1px solid rgba(42,47,102,.95);border-radius:14px;backdrop-filter:blur(6px);box-shadow:0 16px 48px #0008;padding:20px">
      <div class="game-title" id="startTitle" style="font-size:28px;font-weight:800;letter-spacing:.02em;line-height:1.15">ハクスラ・タップRPG（統合・軽量版）</div>
      <div class="title-logo" id="titleLogo" style="font-size:26px">⚔️ 🛡️ 💎</div>
      <div class="hint">バージョン：<span id="verText">1.1</span> ／ セーブ検出：<span id="saveDetect" class="badge" style="display:inline-block;background:#0f1536;border:1px solid #2a2f66;padding:.2rem .5rem;border-radius:10px;color:#cfe0ff">…</span></div>
      <div class="start-actions" style="display:grid;gap:.6rem;width:min(580px,92vw)">
        <div class="row" style="gap:.6rem;justify-content:center">
          <button id="btnPrimary" class="bigbtn" data-mode="local" style="padding:.9rem 1.1rem;border-radius:14px;background:#121639;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer;min-width:180px">コンティニュー</button>
          <button id="btnStartImportFile" class="bigbtn" style="padding:.9rem 1.1rem;border-radius:14px;background:#0b122e;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer;min-width:180px">ファイルから読み込み</button>
        </div>
        <input id="fileOpenStart" type="file" accept="application/json" hidden>
        <div id="newWrap" style="display:block">
          <div class="divider" style="height:1px;background:#2a2f66;width:100%;opacity:.6;margin:.3rem 0"></div>
          <div class="inline" style="display:flex;gap:.5rem;align-items:center;justify-content:center"><label for="startName" style="font-weight:700;line-height:1.2">ユーザーネーム</label><input id="startName" class="input" maxlength="20" placeholder="未入力なら『旅人』で開始" style="background:#0b0f25;color:#cfe0ff;border:1px solid #2a2f66;border-radius:8px;padding:.55rem"></div>
          <div class="inline" style="display:flex;gap:.5rem;align-items:center;justify-content:center"><button id="btnBegin" class="btn">はじめる</button></div>
          <div class="small" id="startNote" style="opacity:.9"></div>
          <div class="small" id="startError"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 転生結果モーダル -->
<div id="ascModal"><div id="ascBox">
  <div class="t">転生完了！</div>
  <div class="small">獲得ソウル：<b id="ascSoulGained">0</b></div>
  <div class="small">今ラウンド到達：<b id="ascRoundReached">1</b> 階</div>
  <div class="s">通算最高到達：<b id="ascBestReached">1</b> 階</div>
  <div class="row" style="margin-top:.6rem;justify-content:flex-end"><button class="btn" id="ascClose">閉じる</button></div>
</div></div>

<header>
  <div class="topbar">
    <div class="wrap" id="top-collapsed">
      <div class="pill">所持 <span class="gold"><b id="c-gold">0</b> G</span></div>
      <div class="pill">Lv <b id="c-level">1</b></div>
      <div class="pill">EXP <b id="c-exp">0/20</b></div>
    </div>
    <button id="toggleInfo" class="toggle" aria-expanded="false" aria-controls="top-expanded">▼ 詳細</button>
    <div class="wrap" id="top-expanded" hidden>
      <div class="pill">階層 <b id="x-floor">1</b></div>
      <div class="pill">Lv <b id="x-level">1</b></div>
      <div class="pill">EXP <b id="x-exp">0/20</b></div>
      <div class="pill">HP <span class="bar"><span id="x-hpbar" style="width:100%"></span></span> <span class="small" id="x-hptext">10/10</span></div>
      <div class="pill">ATK <b id="x-atk">1</b></div>
      <div class="pill">所持 <span class="gold"><b id="x-gold">0</b> G</span></div>
      <div class="pill">ソウル <b id="x-souls">0</b></div>
      <div class="pill">クリ率 <b id="x-crit">5%</b></div>
      <div class="pill"><span class="small" id="timerAll"></span></div>
    </div>
  </div>
</header>
<div id="flavorBar"><div id="flavorText">—</div></div>

<main>
  <div class="layout">
    <!-- ===== Left: Monster & Floor ===== -->
    <section class="panel">
      <div id="monster" class="monster" aria-label="モンスターを攻撃">
        <div class="floor-badge" id="floorBadge">階層 1 —</div>
        <button id="floorMenuBtn" title="階層移動">↕ 階層</button>
        <div id="floorMenu" hidden>
          <div class="row" style="justify-content:flex-start">
            <button class="btn mini" id="fmPrev">1階戻る</button>
            <button class="btn mini gold" id="fmNext">次へ</button>
          </div>
          <label class="small"><input type="checkbox" id="fmStay"> この階層に留まる</label>
          <div class="row" style="justify-content:flex-start">
            <input id="fmJumpInput" type="number" min="1" step="1" placeholder="階層" style="width:120px">
            <button class="btn mini" id="fmJumpGo">移動</button>
          </div>
          <div class="small muted" id="fmHint"></div>
        </div>
        <div class="monster-emoji" id="monsterFace" aria-hidden="true">👁️</div>
        <div class="hpbar" aria-label="モンスターHP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info"><span id="monsterName">Lv1 ゴブリン</span><span id="monsterHPText">10 / 10</span></div>
        <div id="logbox" aria-live="polite" aria-atomic="false">
          <div class="logrow" id="log0"></div>
          <div class="logrow" id="log1"></div>
          <div class="logrow" id="log2"></div>
        </div>
        <div class="actions"><button class="btn" id="attackBtn">戦闘開始！</button></div>
      </div>
      <div class="footnote small" id="footnoteBoss">10階ごとにボス（<span class="warn">制限30秒</span>）。<br>30階ごとに<strong>特別ボス</strong>（<span class="warn">制限60秒</span>）。</div>
    </section>

    <!-- ===== Right: Tabs ===== -->
    <section class="panel">
      <!-- 強化 -->
      <div id="tab-upg" class="grid">
        <div class="tab-row"><div class="small muted">強化メニュー</div><div class="small">所持 <b id="upgGold">0</b> G</div></div>
        <div class="card"><div class="row"><div><b>攻撃力強化</b><div class="small muted" id="countAtk">購入回数：0</div><div class="small muted">クリック与ダメを増加</div></div><div class="gold"><b id="costAtk">10</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyAtk">購入 (+1 ATK) / Lv <b id="lvAtk">0</b></button>
            <button class="btn mini" data-bulk="atk-10">×10</button>
            <button class="btn mini" data-bulk="atk-100">×100</button>
            <button class="btn mini" data-bulk="atk-max">MAX</button>
          </div>
        </div>
        <div class="card"><div class="row"><div><b>最大HP強化</b><div class="small muted" id="countHP">購入回数：0</div><div class="small muted">耐久を増加</div></div><div class="gold"><b id="costHP">10</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyHP">購入 (+5 HP) / Lv <b id="lvHP">0</b></button>
            <button class="btn mini" data-bulk="hp-10">×10</button>
            <button class="btn mini" data-bulk="hp-100">×100</button>
            <button class="btn mini" data-bulk="hp-max">MAX</button>
          </div>
        </div>
        <div class="card"><div class="row"><div><b>自動タップ</b><div class="small muted" id="countAuto">購入回数：0</div><div class="small muted">毎秒自動攻撃（ATKに依存）</div></div><div class="gold"><b id="costAuto">25</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyAuto">購入 (+0.2 タップ/秒) / Lv <b id="lvAuto">0</b></button>
            <button class="btn mini" data-bulk="auto-10">×10</button>
            <button class="btn mini" data-bulk="auto-100">×100</button>
            <button class="btn mini" data-bulk="auto-max">MAX</button>
          </div>
          <div class="small muted">現在：<b id="autoRate">0.0</b> タップ/秒</div>
        </div>
      </div>

      <!-- 装備 -->
      <div id="tab-inv" class="grid" hidden>
        <div class="card">
          <div class="tabline">
            <button class="subtab active" data-eqtab="eq-manage">編成</button>
            <button class="subtab" data-eqtab="eq-enhance">強化</button>
          </div>
          <div id="eq-manage">
            <div class="equip-grid" style="margin-top:.4rem">
              <div class="row"><div>武器：<span id="fm-weapon">なし</span></div><div class="wrap" style="gap:.4rem"><button class="btn mini" data-change="weapon">変更</button><button class="btn mini" data-unequip="weapon">外す</button></div></div>
              <div class="row"><div>鎧　：<span id="fm-armor">なし</span></div><div class="wrap" style="gap:.4rem"><button class="btn mini" data-change="armor">変更</button><button class="btn mini" data-unequip="armor">外す</button></div></div>
              <div class="row"><div>装飾品：<span id="fm-ring">なし</span></div><div class="wrap" style="gap:.4rem"><button class="btn mini" data-change="ring">変更</button><button class="btn mini" data-unequip="ring">外す</button></div></div>
            </div>
          </div>
          <div class="card" id="chooserCard" hidden style="margin-top:.6rem">
            <div class="section-title" id="chooserTitle">選択</div>
            <div class="chooser" id="chooserList"></div>
          </div>
          <div class="card" style="margin-top:.6rem">
            <div class="tabline">
              <button class="subtab active" data-uniqtab="uniq-list">ユニーク装備一覧</button>
              <button class="subtab" data-uniqtab="uniq-forge">神器錬成</button>
            </div>
            <div id="uniq-list"><div class="small" id="uniqListBox">（一覧を生成中…）</div></div>
            <div id="uniq-forge" hidden>
              <div class="row" style="gap:.6rem;align-items:center;margin:.2rem 0 .6rem">
                <button class="btn danger" id="bulkForgeBtn">一括錬成（ささげる）</button>
                <div class="small warn" id="bulkForgeNote">装備中＋レジェンド以下を<b>全て</b>消費（<b id="bulkCount">0</b>件）。ユニーク/永続は除外。</div>
              </div>
              <div class="small" id="relicSwordInfo">—</div>
              <div class="chooser" id="demonList" style="margin-top:.4rem"></div>
            </div>
          </div>
        </div>
        <div id="eq-enhance" hidden>
          <div class="card">
            <div class="section-title">武器の強化</div>
            <div class="small" id="enhWInfo">武器未装備</div>
            <div class="row" style="gap:.6rem"><button class="btn" id="enhWBtn" disabled>強化（きら石 x <b id="enhWCost">0</b>）</button></div>
          </div>
          <div class="card">
            <div class="section-title">鎧の強化</div>
            <div class="small" id="enhAInfo">鎧未装備</div>
            <div class="row" style="gap:.6rem"><button class="btn" id="enhABtn" disabled>強化（きら石 x <b id="enhACost">0</b>）</button></div>
          </div>
          <div class="card">
            <div class="section-title">装飾品の強化</div>
            <div class="small" id="enhRInfo">装飾品未装備</div>
            <div class="row" style="gap:.6rem"><button class="btn" id="enhRBtn" disabled>強化（きら石 x <b id="enhRCost">0</b>）</button></div>
          </div>
        </div>
        <div class="card">
          <div class="row"><b>所持品（閲覧のみ）</b><label class="small"><input type="checkbox" id="autoEquip" /> 強い装備を自動装備</label></div>
          <div class="inv-list" id="invList"></div>
        </div>
      </div>

      <!-- 統計 -->
      <div id="tab-sta" class="grid" hidden>
        <div class="card"><div class="section-title">スコア</div><div class="small">いろんな数字を適当に足し込んだ目安値：<b id="sta-score">0</b></div></div>
        <div class="card"><div class="section-title">ラウンド記録</div>
          <div class="small">ラウンド最高到達：<b id="sta-roundmax">1</b></div>
          <div class="small">討伐数（今ラウンド）：<b id="sta-kills">0</b></div>
          <div class="small">死亡数（今ラウンド）：<b id="sta-deaths">0</b></div>
        </div>
        <div class="card"><div class="section-title">通算記録</div>
          <div class="small">通算最高到達：<b id="sta-bestmax">1</b></div>
          <div class="small">転生回数：<b id="sta-asc">0</b></div>
        </div>
        <div class="card"><div class="section-title">能力・その他</div>
          <div class="small">ATK：<b id="sta-atk">1</b>／最大HP：<b id="sta-hp">10</b>／防御：<b id="sta-def">0</b></div>
          <div class="small">クリ率：<b id="sta-crit">5%</b>／自動タップ：<b id="sta-autotap">0.0</b> /秒</div>
          <div class="small">ゴールドボーナス：<b id="sta-goldb">0%</b></div>
          <div class="small">ドロップ：装備<b id="sta-itemdrop">20%</b>／ミミック<b id="sta-mimic">3.00%</b>／Sミミック<b id="sta-supermimic">1.20%</b></div>
          <div class="small">石ころ：<b id="sta-stonedrop">5%</b>（一度に<b id="sta-stoneamt">0</b>個）</div>
          <div class="small">所持：ゴールド<b id="bag-gold">0</b>G／ソウル<b id="bag-soul">0</b>（累計消費<b id="bag-soulspent">0</b>）／魔石<b id="bag-gem">0</b>／きら石<b id="bag-peb">0</b>／装備<b id="bag-eq">0</b></div>
        </div>
      </div>

      <!-- 転生/聖遺物 -->
      <div id="tab-adv" class="grid" hidden>
        <div class="card">
          <div class="adv-subtabs">
            <button class="advtab active" data-advtab="adv-asc">転生 / ソウル強化</button>
            <button class="advtab" data-advtab="adv-relic">聖遺物（通常）</button>
            <button class="advtab" data-advtab="adv-relic-test">聖遺物（テスト用）</button>
          </div>
          <div id="adv-asc">
            <div class="section-title">転生（パーマネント強化）</div>
            <div class="small" id="ascDesc">転生で <b>レベル</b> / <b>強化メニュー</b> / <b>通常装備</b> を<b>完全リセット</b>。<br>ラウンド最高到達はリセット、<b>通算最高到達</b>は保持。転生回数をカウントし、<b>ソウル</b>を獲得。</div>
            <div class="row"><div>獲得見込み：<b id="soulGain">0</b> ソウル</div><button class="btn danger" id="ascendBtn">転生する</button></div>
            <div class="divider-thin"></div>
            <div class="section-title">ソウル強化（恒久）</div>
            <div class="small">所持ソウル：<b id="soulRemain">0</b> ／ 累計消費：<b id="soulSpent">0</b></div>
            <div class="grid" style="margin-top:.4rem">
              <div class="card"><div class="row"><div><b>永続・攻撃力</b><div class="small muted">+2% / Lv（乗算）</div></div><div class="small">Lv <b id="soulLvAtk">0</b> ／ 次の必要ソウル：<b id="soulCostAtk">1</b></div></div><div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyAtk">強化する</button></div></div>
              <div class="card"><div class="row"><div><b>永続・最大HP</b><div class="small muted">+2% / Lv（乗算）</div></div><div class="small">Lv <b id="soulLvHP">0</b> ／ 次の必要ソウル：<b id="soulCostHP">1</b></div></div><div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyHP">強化する</button></div></div>
              <div class="card"><div class="row"><div><b>永続・ゴールド</b><div class="small muted">+2% / Lv（加算）</div></div><div class="small">Lv <b id="soulLvGold">0</b> ／ 次の必要ソウル：<b id="soulCostGold">1</b></div></div><div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyGold">強化する</button></div></div>
            </div>
          </div>
        </div>
        <div id="adv-relic" hidden>
          <div class="card">
            <div class="row"><b>聖遺物ショップ</b><div class="small">購入のたび<b>ランダム解除</b>（コストは徐々に増加）</div></div>
            <div class="row"><div class="small">次コスト：<b id="relicShopCost">5</b> ソウル</div><button class="btn" id="relicShopBuy">購入（ランダム解除）</button></div>
          </div>
          <div class="card" id="relicJarCard" hidden>
            <div class="row"><b>強欲の壺</b><div class="small">Lv <b id="jarLv">0</b> ／ 次コスト：<b id="jarCost">2</b> ソウル</div></div>
            <div class="small">効果：獲得ゴールド +20% / Lv（累積）</div>
            <div class="row" style="gap:.6rem"><button class="btn" id="jarUpgrade">強化</button></div>
          </div>
          <div class="card" id="relicKnifeCard" hidden>
            <div class="row"><b>ほんもののナイフ</b><div class="small">Lv <b id="knifeLv">0</b> ／ 次コスト：<b id="knifeCost">3</b> ソウル</div></div>
            <div class="small">効果：攻撃力 +99 / Lv（実数値加算）</div>
            <div class="row" style="gap:.6rem"><button class="btn" id="knifeUpgrade">強化</button></div>
          </div>
        </div>
        <div id="adv-relic-test" hidden>
          <div class="card"><b>聖遺物（テスト用）</b><div class="small">※今だけコード掲示：<b>kashiwa060925</b>（柏の加護）, <b>kashiwa77</b>（ツヨスギテ=クサハエル）</div></div>
          <div class="card" id="relicKashiwaCard" hidden>
            <div class="row"><b>柏の加護（コード特典）</b><label class="small"><input type="checkbox" id="relicKashiwa"> 有効化</label></div>
            <div class="small">オーバーキル分だけ連続討伐。まとめて倒したときはGMが反応する。</div>
          </div>
          <div class="card" id="relicStrongSwordCard" hidden>
            <div class="row"><b>ツヨスギテ=クサハエル（コード特典）</b><label class="small"><input type="checkbox" id="relicStrongSword"> 有効化</label></div>
            <div class="small">攻撃力を<b>99倍</b>にする</div>
          </div>
        </div>
      </div>

      <!-- 設定/セーブ -->
      <div id="tab-settings" class="grid" hidden>
        <div class="card"><b>セーブ</b>
          <div class="row" style="gap:.4rem;align-items:center"><input id="exportName" class="input" placeholder="保存ファイル名（省略時：save-ユーザー名-YYYYMMDD-HHMMSS.json)" style="flex:1"/><button class="btn" id="downloadBtn">今すぐダウンロード</button></div>
          <div class="small muted">※現在の状態を<b>直接JSON</b>として保存（localStorageにも同時保存）。</div>
        </div>
        <div class="card"><b>インポート</b>
          <div class="row" style="gap:.6rem;align-items:center"><button class="btn" id="importFileBtn">ファイルから読み込み</button><input id="fileOpenSettings" type="file" accept="application/json" hidden></div>
        </div>
        <div class="card"><b>サウンド / バイブ設定</b>
          <div class="row" style="gap:.6rem;align-items:center">
            <label><input type="checkbox" id="audioEnabled"> サウンド有効</label>
            <label><input type="checkbox" id="hapticEnabled"> バイブ</label>
            <label><input type="checkbox" id="bgmBoss"> 30階ボスBGM</label>
          </div>
          <div class="row" style="gap:.6rem;align-items:center">
            <label style="flex:1">SE 音量 <input id="seVol" class="range" type="range" min="0" max="100" value="80"></label>
          </div>
        </div>
        <div class="card"><b>その他</b>
          <div class="row" style="gap:.6rem"><button class="btn danger" id="wipeBtn">全削除/更新</button></div>
          <div class="small warn">※削除前に必ずバックアップを保存してください</div>
        </div>
        <div class="card"><b>コード引き換え</b>
          <div class="row"><input id="codeInput" placeholder="コードを入力" class="input" style="flex:1;min-width:160px"/><button class="btn" id="codeBtn">引き換え</button></div>
          <div class="small muted" id="codeStatus"></div>
        </div>
        <div class="card"><b>ユーザーネーム</b>
          <div class="row" style="gap:.6rem;align-items:center"><input id="nameEdit" class="input" maxlength="20" placeholder="ユーザーネーム" style="flex:1"><button class="btn" id="nameSave">保存</button></div>
        </div>
      </div>

    </section>
  </div>
</main>

<footer id="mainFooter" role="navigation" aria-label="メインメニュー">
  <div class="footer-wrap">
    <button class="ftab active" data-tab="tab-upg" aria-controls="tab-upg" aria-label="強化">強化</button>
    <button class="ftab" data-tab="tab-inv" aria-controls="tab-inv" aria-label="装備">装備</button>
    <button class="ftab" data-tab="tab-sta" aria-controls="tab-sta" aria-label="統計">統計</button>
    <button class="ftab" data-tab="tab-adv" aria-controls="tab-adv" aria-label="転生/聖遺物">転生</button>
    <button class="ftab" data-tab="tab-settings" aria-controls="tab-settings" aria-label="設定/セーブ">設定</button>
  </div>
</footer>



// ====== ループ＆初期化 ======
let last=performance.now(), _loopStarted=false;
function loop(nowTs){ const dt=Math.min(0.1,(nowTs-last)/1000); last=nowTs; autoTapTick(dt); enemyTick(dt); regenTick(dt); timersTick(dt); updateUI(); requestAnimationFrame(loop); }
function startLoop(){ if(_loopStarted) return; _loopStarted=true; requestAnimationFrame(loop); }
function hasSave(){ try{ return !!localStorage.getItem(SAVE_KEY) }catch(e){ return false } }
function setPrimaryButton(){ if(!ui.btnPrimary) return; if(hasSave()){ ui.btnPrimary.setAttribute('data-mode','local'); ui.btnPrimary.textContent='コンティニュー'; } else { ui.btnPrimary.setAttribute('data-mode','new'); ui.btnPrimary.textContent='ニューゲーム'; } }
window.addEventListener('error',(e)=>{ if(ui.startError) ui.startError.textContent='初期化エラー：'+(e?.error?.message||e.message||'不明'); });
function applyCollapsed(col){ if(!ui.toggleInfo) return; if(col){ ui.topCollapsed&&ui.topCollapsed.removeAttribute('hidden'); ui.topExpanded&&ui.topExpanded.setAttribute('hidden',''); ui.toggleInfo.setAttribute('aria-expanded','false'); ui.toggleInfo.textContent='▼ 詳細'; } else { ui.topCollapsed&&ui.topCollapsed.setAttribute('hidden',''); ui.topExpanded&&ui.topExpanded.removeAttribute('hidden'); ui.toggleInfo.setAttribute('aria-expanded','true'); ui.toggleInfo.textContent='▲ 閉じる'; } localStorage.setItem(UI_KEY,col?'1':'0'); }
function safeInit(){ try{ ui.verText&&(ui.verText.textContent=GAME_VERSION); loadAudioSettings(); switchMainTab('tab-upg'); const saved=localStorage.getItem(UI_KEY); applyCollapsed(saved!=='0'); ui.saveDetect&&(ui.saveDetect.textContent=hasSave()?'OK':'—'); setPrimaryButton(); window.addEventListener('beforeunload',()=>save(false)); }catch(e){ console.error(e); if(ui.startError) ui.startError.textContent='初期化失敗：'+e.message; } }
function beginGame(uname){ if(!uname) uname='旅人'; state.username=uname; state.playerHP=recalcMaxHP(); ensureUniqueSwordItem(); spawnMonster(); renderInventory(); updateUI(); save(false); if(ui.startOverlay) ui.startOverlay.hidden=true; startLoop(); Sound.play('ui'); }

// ユーザー操作でAudio起動
function onAnyStartAction(){ seInitOnUserGesture(); }
['click','pointerdown','touchstart','keydown'].forEach(ev=>{ on(ui.btnPrimary,ev,onAnyStartAction,{passive:true}); on(ui.btnBegin,ev,onAnyStartAction,{passive:true}); on(ui.btnStartImportFile,ev,onAnyStartAction,{passive:true}); document.addEventListener(ev,onAnyStartAction,{once:true,passive:true}); });

// Startボタン
on(ui.btnPrimary,'click',()=>{ const mode=ui.btnPrimary.getAttribute('data-mode'); if(mode==='local'){ if(load(false)){ beginGame(state.username||'旅人'); } else { if(ui.startNote) ui.startNote.textContent='セーブが見つかりません → ニューゲームを開始できます'; setPrimaryButton(); } } else if(mode==='new'){ const nm=(ui.startName?.value||'').trim(); beginGame(nm); } });

on(ui.btnStartImportFile,'click',()=>{ if(!ui.fileOpenStart) return; ui.fileOpenStart.value=''; ui.fileOpenStart.click(); });
on(ui.fileOpenStart,'change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const txt=await readFileAsText(f); if(importSaveFromText(txt)){ beginGame(state.username||'旅人'); } } catch(_){ if(ui.startNote) ui.startNote.textContent='読込エラー'; } });

on(ui.btnBegin,'click',()=>{ const nm=(ui.startName?.value||'').trim(); beginGame(nm); });

// 上部詳細の折りたたみ
on(ui.toggleInfo,'click',()=>{ const col=ui.toggleInfo.getAttribute('aria-expanded')==='true'; applyCollapsed(col) });

// 攻撃入力のバインド
bindInput(ui.attackBtn); bindInput($('#monster'));
['click','pointerup','pointerdown','touchstart','touchend'].forEach(ev=>{ on(ui.floorMenu,ev,stopTap); on(ui.floorMenuBtn,ev,stopTap); on(ui.fmJumpInput,ev,stopTap); });

// 起動
safeInit();
</script>

  <script src="./assets/js/app.js"></script>
</body>
</html>
