<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPGï¼ˆHTMLä¸€æšï¼ã‚¿ãƒƒãƒ—å°‚ç”¨ï¼‰</title>
<style>
  :root{
    --c-bg:#0f1220; --c-panel:#171a2b; --c-accent:#7cd2ff; --c-accent2:#9eff7c;
    --c-text:#e8eefc; --c-sub:#aab6d6; --c-danger:#ff6b6b; --c-gold:#ffd76a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0d1120,#0b1021 50%,#0e0f1a);color:var(--c-text);-webkit-tap-highlight-color:transparent}
  /* hidden ã‚’ç¢ºå®Ÿã«éš ã™ */
  [hidden]{display:none !important}

  header{position:sticky;top:0;z-index:3;background:#0d1120cc;backdrop-filter:blur(6px);border-bottom:1px solid #1f2440;padding:.6rem .8rem}
  .topbar{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .pill{background:var(--c-panel);border:1px solid #232742;border-radius:12px;padding:.45rem .6rem;font-size:.92rem;color:var(--c-sub)}
  .bar{width:160px;height:12px;border-radius:8px;background:#101425;border:1px solid #283055;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2ddf7f,#67e3a3);width:100%}
  .small{font-size:.85rem;color:var(--c-sub)}
  .toggle{justify-self:end;background:#121639;border:1px solid #2a2f66;color:#c9d6ff;padding:.45rem .6rem;border-radius:10px;touch-action:manipulation}
  .toggle[aria-expanded='true']{background:#1a2053}

  main{max-width:1200px;margin:0 auto;padding:1rem}
  .layout{display:grid;grid-template-columns:1.2fr .9fr;gap:1rem}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:#171a2b;border:1px solid #222647;border-radius:14px;padding:1rem;box-shadow:0 8px 24px #00000045,inset 0 1px #2b3159}
  .monster{display:grid;gap:.6rem;justify-items:center;text-align:center;padding:1rem;border-radius:12px;background:radial-gradient(80% 80% at 50% 30%, #141937, #101635);border:1px solid #202554;cursor:pointer;user-select:none;touch-action:manipulation}
  .monster-emoji{font-size:76px;line-height:1}
  .hpbar{width:100%;height:18px;background:#0c1026;border:1px solid #2a2f5a;border-radius:10px;overflow:hidden}
  .hpbar>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ff9f6b);width:100%;transition:width .12s ease}
  .monster-info{display:flex;justify-content:space-between;width:100%;color:#aab6d6;font-weight:600}
  .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center}
  .btn{background:#0f1536;color:#cfe0ff;border:1px solid #2a2f66;padding:.8rem 1.1rem;border-radius:12px;cursor:pointer;touch-action:manipulation;min-width:44px;min-height:44px}
  .btn:hover{background:#121a43}
  .btn.gold{border-color:#6e5a25;background:#221b08;color:#ffd76a}
  .btn.danger{border-color:#6b2833;background:#2a0d14;color:#ffb0b0}
  .btn:disabled{opacity:.5;filter:grayscale(40%);cursor:not-allowed}
  .grid{display:grid;gap:.6rem}
  .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem}
  .tab{background:#121639;border:1px solid #2a2f66;padding:.7rem 1rem;border-radius:12px;cursor:pointer;color:#c9d6ff;touch-action:manipulation}
  .tab.active{background:#1a2053;outline:2px solid #6888ff66}
  .inv-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.6rem}
  .card{background:#0f1433;border:1px solid #2a2f66;border-radius:10px;padding:.7rem;display:grid;gap:.35rem}
  .row{display:flex;justify-content:space-between;gap:.6rem;align-items:center;flex-wrap:wrap}
  .rar-Common{color:#e0e6ff}.rar-Uncommon{color:#9eff7c}.rar-Rare{color:#58c7ff}.rar-Epic{color:#c58cff}.rar-Legendary{color:#ffb36a}
  .muted{color:#aab6d6}.warn{color:#ff6b6b}.gold{color:#ffd76a}
  .footnote{margin-top:.8rem;color:#98a2c9;font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <!-- ãƒ—ãƒ©ã‚¤ãƒãƒªï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ï¼šéšå±¤ / HP / ATK / Lv -->
    <div class="wrap" id="top-primary">
      <div class="pill">éšå±¤ <b id="floor">1</b></div>
      <div class="pill">HP <span class="bar" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP"><span id="hpbar" style="width:100%"></span></span> <span class="small" id="hptext">10/10</span></div>
      <div class="pill">ATK <b id="atk">1</b></div>
      <div class="pill">Lv <b id="level">1</b></div>
    </div>
    <!-- æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ« -->
    <button id="toggleInfo" class="toggle" aria-expanded="false" aria-controls="top-extra">â–¼ è©³ç´°</button>
    <!-- ã‚»ã‚«ãƒ³ãƒ€ãƒªï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ï¼šGold / EXP / ã‚¯ãƒªç‡ / ã‚½ã‚¦ãƒ« / ã‚¿ã‚¤ãƒãƒ¼ -->
    <div class="wrap" id="top-extra" hidden>
      <div class="pill">æ‰€æŒ <span class="gold"><b id="gold">0</b> G</span></div>
      <div class="pill">EXP <b id="exp">0/20</b></div>
      <div class="pill">ã‚¯ãƒªç‡ <b id="crit">5%</b></div>
      <div class="pill">ã‚½ã‚¦ãƒ« <b id="souls">0</b></div>
      <div class="pill"><span class="small" id="bossTimer"></span></div>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <section class="panel">
      <div id="monster" class="monster" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ”»æ’ƒ">
        <div class="monster-emoji" id="monsterFace" aria-hidden="true">ğŸ‘¹</div>
        <div class="hpbar" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info">
          <span id="monsterName">Lv1 ã‚´ãƒ–ãƒªãƒ³</span>
          <span id="monsterHPText">10 / 10</span>
        </div>
        <div class="actions">
          <button class="btn" id="attackBtn">æˆ¦é—˜é–‹å§‹ï¼</button>
          <button class="btn gold" id="nextBtn" title="è¨ä¼ã™ã‚‹ã¨é€²ã‚ã‚‹" disabled>æ¬¡ã®éšå±¤ã¸</button>
          <button class="btn danger" id="fleeBtn">1éšæˆ»ã‚‹</button>
        </div>
        <div class="small" id="logline" aria-live="polite"></div>
      </div>
      <div class="footnote">10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™æ™‚é–“30ç§’</span>ï¼‰ã€‚æœªäº¤æˆ¦ã®é–“ã¯æ•µã¯å‹•ãã¾ã›ã‚“ã€‚æ­»äº¡ã™ã‚‹ã¨5ç§’ã§è‡ªå‹•å¾©æ´»ï¼ˆå¾©æ´»å¾Œã¯ä¸€åº¦åœæ­¢ï¼‰ã€‚</div>
    </section>

    <section class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="tab-upg">å¼·åŒ–</button>
        <button class="tab" data-tab="tab-inv">è£…å‚™</button>
        <button class="tab" data-tab="tab-sta">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
        <button class="tab" data-tab="tab-sys">è¨­å®š/è»¢ç”Ÿ</button>
      </div>

      <div id="tab-upg" class="grid">
        <div class="card">
          <div class="row"><div><b>æ”»æ’ƒåŠ›å¼·åŒ–</b><div class="small muted">ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ </div></div><div class="gold"><b id="costAtk">10</b> G</div></div>
          <button class="btn" id="buyAtk">è³¼å…¥ (+1 ATK)</button>
        </div>
        <div class="card">
          <div class="row"><div><b>æœ€å¤§HPå¼·åŒ–</b><div class="small muted">è€ä¹…ã‚’å¢—åŠ </div></div><div class="gold"><b id="costHP">10</b> G</div></div>
          <button class="btn" id="buyHP">è³¼å…¥ (+5 HP)</button>
        </div>
        <div class="card">
          <div class="row"><div><b>è‡ªå‹•ã‚¿ãƒƒãƒ—</b><div class="small muted">æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰</div></div><div class="gold"><b id="costAuto">25</b> G</div></div>
          <button class="btn" id="buyAuto">è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’)</button>
          <div class="small muted">ç¾åœ¨ï¼š<b id="autoRate">0.0</b> ã‚¿ãƒƒãƒ—/ç§’</div>
        </div>
      </div>

      <div id="tab-inv" class="grid" hidden>
        <div class="card">
          <div><b>è£…å‚™ä¸­</b></div>
          <div class="small">æ­¦å™¨ï¼š<span id="eq-weapon">ãªã—</span></div>
          <div class="small">é§ã€€ï¼š<span id="eq-armor">ãªã—</span></div>
          <div class="small">æŒ‡è¼ªï¼š<span id="eq-ring">ãªã—</span></div>
        </div>
        <div class="card">
          <div class="row"><b>æ‰€æŒå“</b><label class="small"><input type="checkbox" id="autoEquip" /> å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™</label></div>
          <div class="inv-list" id="invList"></div>
        </div>
      </div>

      <div id="tab-sta" class="grid" hidden>
        <div class="card">
          <b>åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</b>
          <div class="small">ATKï¼š<b id="sta-atk">1</b></div>
          <div class="small">æœ€å¤§HPï¼š<b id="sta-hp">10</b></div>
          <div class="small">é˜²å¾¡ï¼š<b id="sta-def">0</b></div>
          <div class="small">ã‚¯ãƒªç‡ï¼š<b id="sta-crit">5%</b></div>
          <div class="small">ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š<b id="sta-goldb">0%</b></div>
          <div class="small">ã‚½ã‚¦ãƒ«è£œæ­£ï¼ˆæ’ä¹…ï¼‰ï¼š<b id="sta-soulb">0%</b></div>
        </div>
        <div class="card">
          <b>æˆ¦ç¸¾</b>
          <div class="small">æœ€é«˜åˆ°é”éšå±¤ï¼š<b id="sta-maxfloor">1</b></div>
          <div class="small">è¨ä¼æ•°ï¼š<b id="sta-kills">0</b></div>
          <div class="small">æ­»äº¡æ•°ï¼š<b id="sta-deaths">0</b></div>
        </div>
      </div>

      <div id="tab-sys" class="grid" hidden>
        <div class="card">
          <b>ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰</b>
          <div class="row">
            <button class="btn" id="saveBtn">ä¿å­˜</button>
            <button class="btn" id="loadBtn">èª­è¾¼</button>
            <button class="btn" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn" id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button class="btn danger" id="wipeBtn">å…¨å‰Šé™¤</button>
          </div>
          <textarea id="ioArea" rows="4" style="width:100%; background:#0b0f25; color:#cfe0ff; border:1px solid #2a2f66; border-radius:8px; margin-top:.5rem" placeholder="ã“ã“ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™ï¼ˆæ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰"></textarea>
        </div>
        <div class="card">
          <b>è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰</b>
          <div class="small">è»¢ç”Ÿã™ã‚‹ã¨éšå±¤/è£…å‚™/æ‰€æŒé‡‘ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ãŒã€<b>ã‚½ã‚¦ãƒ«</b>ã‚’ç²å¾—ã—ã€ä¸ãƒ€ãƒ¡ï¼†ç²å¾—Goldã«æ’ä¹…ãƒœãƒ¼ãƒŠã‚¹ï¼ˆã‚½ã‚¦ãƒ«1ã¤ã‚ãŸã‚Š +2%ï¼‰</div>
          <div class="row"><div>ç²å¾—è¦‹è¾¼ã¿ï¼š<b id="soulGain">0</b> ã‚½ã‚¦ãƒ«</div><button class="btn danger" id="ascendBtn">è»¢ç”Ÿã™ã‚‹</button></div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
const $ = s=>document.querySelector(s), $$ = s=>document.querySelectorAll(s);
const RARITIES=[{name:'Common',color:'rar-Common',weight:60,mult:1},{name:'Uncommon',color:'rar-Uncommon',weight:25,mult:1.4},{name:'Rare',color:'rar-Rare',weight:10,mult:2},{name:'Epic',color:'rar-Epic',weight:4,mult:3},{name:'Legendary',color:'rar-Legendary',weight:1,mult:4.5}];
const MONSTER_POOL=[{name:'ã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸ‘¹'},{name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',emoji:'ğŸ’€'},{name:'ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸ¦‡'},{name:'ã‚ªã‚ªã‚«ãƒŸ',emoji:'ğŸº'},{name:'ã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸ«§'},{name:'ãƒŸã‚¤ãƒ©',emoji:'ğŸ§»'},{name:'é­”å°æ›¸',emoji:'ğŸ“•'},{name:'ç›®ç‰',emoji:'ğŸ‘ï¸'},{name:'ã‚µã‚½ãƒª',emoji:'ğŸ¦‚'}];
const BOSS_POOL=[{name:'ã‚ªãƒ¼ã‚¬',emoji:'ğŸ‘º'},{name:'ãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ²'},{name:'ãƒªãƒƒãƒ',emoji:'ğŸª¦'},{name:'ã‚±ãƒ«ãƒ™ãƒ­ã‚¹',emoji:'ğŸ¶'}];
const SAVE_KEY='tap_hns_save_v1', UI_TOP='ui_top_extra_v1';
const state={gold:0,level:1,exp:0,expToNext:20,floor:1,maxFloor:1,kills:0,deaths:0,baseATK:1,baseHP:10,baseDEF:0,baseCRIT:5,autoTap:0,eq:{weapon:null,armor:null,ring:null},inv:[],autoEquip:false,monster:null,playerHP:10,bossEndsAt:0,souls:0,bestMaxFloor:1,isDown:false,engaged:false};
const prices={atk:10,hp:10,auto:25};
const ui={floor:$('#floor'),gold:$('#gold'),level:$('#level'),exp:$('#exp'),hpbar:$('#hpbar'),hptext:$('#hptext'),atk:$('#atk'),crit:$('#crit'),souls:$('#souls'),monsterFace:$('#monsterFace'),monsterHP:$('#monsterHP'),monsterHPText:$('#monsterHPText'),monsterName:$('#monsterName'),bossTimer:$('#bossTimer'),logline:$('#logline'),nextBtn:$('#nextBtn'),fleeBtn:$('#fleeBtn'),attackBtn:$('#attackBtn'),tabs:$$('.tab'),tabUpg:$('#tab-upg'),tabInv:$('#tab-inv'),tabSta:$('#tab-sta'),tabSys:$('#tab-sys'),costAtk:$('#costAtk'),costHP:$('#costHP'),costAuto:$('#costAuto'),buyAtk:$('#buyAtk'),buyHP:$('#buyHP'),buyAuto:$('#buyAuto'),autoRate:$('#autoRate'),invList:$('#invList'),eqWeapon:$('#eq-weapon'),eqArmor:$('#eq-armor'),eqRing:$('#eq-ring'),autoEquip:$('#autoEquip'),staAtk:$('#sta-atk'),staHP:$('#sta-hp'),staDef:$('#sta-def'),staCrit:$('#sta-crit'),staGoldB:$('#sta-goldb'),staSoulB:$('#sta-soulb'),staMaxFloor:$('#sta-maxfloor'),staKills:$('#sta-kills'),staDeaths:$('#sta-deaths'),saveBtn:$('#saveBtn'),loadBtn:$('#loadBtn'),exportBtn:$('#exportBtn'),importBtn:$('#importBtn'),wipeBtn:$('#wipeBtn'),ioArea:$('#ioArea'),soulGain:$('#soulGain'),ascendBtn:$('#ascendBtn'),topExtra:$('#top-extra'),toggleInfo:$('#toggleInfo')};
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function choice(a){return a[randInt(0,a.length-1)]}
function weightedPick(items){const t=items.reduce((s,i)=>s+i.weight,0);let r=Math.random()*t;for(const it of items){r-=it.weight;if(r<=0)return it}return items[items.length-1]}
function soulMG(){return 1+state.souls*0.02}
function recalcMaxHP(){const armorHP=state.eq.armor?.hp??0;return Math.max(1,state.baseHP+armorHP)}
function playerATK(){const w=state.eq.weapon?.atk??0,r=state.eq.ring?.atk??0;return Math.max(1,Math.floor((state.baseATK+w+r)*soulMG()))}
function playerDEF(){return state.baseDEF+(state.eq.armor?.def??0)}
function playerCRIT(){return clamp(state.baseCRIT+(state.eq.ring?.crit??0),0,100)}
function goldBPercent(){const rg=state.eq.ring?.goldB??0;return rg+(soulMG()-1)*100}
function clickDamage(){const c=Math.random()*100<playerCRIT();let d=playerATK();if(c)d=Math.floor(d*1.8);return{dmg:d,isCrit:c}}
function eHP(f,b){return Math.floor((14*Math.pow(f,1.18)+6)*(b?6:1))}
function eGold(f,b){return Math.floor((4*Math.pow(f,1.10)+2)*(b?4:1))}
function eATK(f,b){return Math.floor((1.2*Math.pow(f,1.05)+0.6)*(b?2:1))}
function makeItem(f){const kinds=['weapon','armor','ring'];const k=choice(kinds);const rar=weightedPick(RARITIES);const mult=rar.mult;const bp=Math.max(1,Math.floor((Math.pow(f,1.12)+randInt(0,f))*0.5*mult));const it={id:cryptoId(),name:'',slot:k,rarity:rar.name,color:rar.color,lvl:f,value:Math.max(1,Math.floor(bp*1.2))};if(k==='weapon'){it.atk=Math.max(1,Math.floor(bp));if(rar.name!=='Common'&&Math.random()<0.35)it.crit=2+Math.floor(mult*2);it.name=`æ­¦å™¨ +${it.atk}`}else if(k==='armor'){it.hp=4*Math.max(1,Math.floor(bp*0.9));if(rar.name!=='Common'&&Math.random()<0.3)it.def=Math.floor(mult*1.2);it.name=`é§ +${it.hp}HP`}else{const r=Math.random();if(r<0.45){it.crit=3+Math.floor(mult*2);it.name=`æŒ‡è¼ª ã‚¯ãƒª+${it.crit}%`}else if(r<0.9){it.atk=Math.max(1,Math.floor(bp*0.6));it.name=`æŒ‡è¼ª ATK+${it.atk}`}else{it.goldB=5+Math.floor(mult*4);it.name=`æŒ‡è¼ª Gold+${it.goldB}%`}}it.name+=` (${rar.name})`;return it}
function cryptoId(){const a=new Uint32Array(2);(window.crypto||window.msCrypto).getRandomValues?.(a);return [...a].map(x=>x.toString(16)).join('')}
function spawnMonster(){const f=state.floor,b=(f%10===0),p=b?BOSS_POOL:MONSTER_POOL,pk=choice(p),hp=eHP(f,b),g=eGold(f,b),atk=eATK(f,b);state.monster={name:(b?'ã€BOSSã€‘':'')+`Lv${f} ${pk.name}`,emoji:pk.emoji,hp,maxHP:hp,gold:g,atk,isBoss:b};state.engaged=false;state.isDown=false;ui.monsterFace.textContent=pk.emoji;ui.monsterName.textContent=state.monster.name;ui.monsterHPText.textContent=`${state.monster.hp} / ${state.monster.maxHP}`;ui.monsterHP.style.width='100%';ui.logline.textContent=b?'ãƒœã‚¹å‡ºç¾ï¼æœ€åˆã®ä¸€æ’ƒã§æˆ¦é—˜é–‹å§‹':'ã‚¿ãƒƒãƒ—ã§æˆ¦é—˜é–‹å§‹';state.bossEndsAt=0;updateAttackBtn();refreshNextBtn()}
function awardKill(){const m=state.monster;const gb=1+goldBPercent()/100;const gain=Math.floor(m.gold*gb);state.gold+=gain;state.kills+=1;state.exp+=Math.max(1,Math.floor(3+state.floor*0.6));while(state.exp>=state.expToNext){state.exp-=state.expToNext;state.level+=1;state.expToNext=Math.floor(state.expToNext*1.25+8);state.baseATK+=1;state.baseHP+=2;ui.logline.textContent='ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ATK+1 / HP+2'}const luck=(state.eq.ring?.goldB??0)*0.2;const drop=0.20+luck/100;if(Math.random()<drop){const it=makeItem(state.floor);state.inv.push(it);if(state.autoEquip) tryAutoEquip(it);toast(`ãƒ‰ãƒ­ãƒƒãƒ—ï¼š${renderItemText(it)}`)}else{toast(`+${gain}G`)}if(state.floor>state.maxFloor)state.maxFloor=state.floor;if(state.maxFloor>state.bestMaxFloor)state.bestMaxFloor=state.maxFloor}
function renderItemText(it){const p=[];if(it.atk)p.push(`ATK+${it.atk}`);if(it.hp)p.push(`HP+${it.hp}`);if(it.def)p.push(`é˜²å¾¡+${it.def}`);if(it.crit)p.push(`ã‚¯ãƒª+${it.crit}%`);if(it.goldB)p.push(`Gold+${it.goldB}%`);return `${it.name} [${p.join(', ')}]`}
function tryAutoEquip(it){const s=it.slot,cur=state.eq[s];if(scoreItem(it)>scoreItem(cur)){state.eq[s]=it;toast(`è‡ªå‹•è£…å‚™ï¼š${renderItemText(it)}`);updateAttackBtn()}}
function scoreItem(it){if(!it)return-1e9;let s=0;s+=(it.atk??0)*3+(it.hp??0)*0.4+(it.def??0)*2+(it.crit??0)*1.5+(it.goldB??0)*0.8;s+=(it.lvl??0)*0.2;const rar=RARITIES.find(r=>r.name===it.rarity);s*=rar?.mult??1;return s}
function updateAttackBtn(){const m=state.monster;if(!m){ui.attackBtn.textContent='æ”»æ’ƒ';return}const expected=playerATK();if(!state.engaged){ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æˆ¦é—˜é–‹å§‹ï¼';return}ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰'}
function refreshNextBtn(){ui.nextBtn.disabled=!(state.monster&&state.monster.hp<=0)}
function attack(){if(!state.monster)return;if(state.playerHP<=0){toast('æ°—çµ¶ä¸­â€¦');return}const first=!state.engaged;if(first){state.engaged=true;if(state.monster.isBoss&&state.bossEndsAt===0){state.bossEndsAt=Date.now()+30000}}const m=state.monster;if(m.hp<=0)return;const {dmg,isCrit}=clickDamage();const dealt=Math.min(m.hp,dmg);m.hp-=dealt;ui.monsterHP.style.width=`${(m.hp/m.maxHP)*100}%`;ui.monsterHPText.textContent=`${m.hp} / ${m.maxHP}`;ui.logline.textContent=isCrit?`ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ -${dealt}`:`-${dealt}`;if(m.hp<=0){awardKill();state.floor+=1;if(state.floor%10===0)toast('ãƒœã‚¹ãƒ•ãƒ­ã‚¢ã«åˆ°é”ï¼');spawnMonster()}updateAttackBtn();refreshNextBtn()}
function enemyTick(dt){if(!state.monster||!state.engaged||state.isDown)return;const m=state.monster;if(m.hp<=0)return;const dps=Math.max(0,m.atk-playerDEF()*0.6);const dmg=dps*dt;if(dmg<=0)return;state.playerHP-=dmg;if(state.playerHP<=0&&!state.isDown){state.playerHP=0;state.isDown=true;state.deaths+=1;ui.logline.textContent='æ°—çµ¶ã—ã¾ã—ãŸâ€¦5ç§’å¾Œã«å¾©æ´»';setTimeout(()=>{state.playerHP=recalcMaxHP();state.isDown=false;state.engaged=false; // â˜… å¾©æ´»å¾Œã¯æ­¢ã‚ã‚‹
ui.logline.textContent='å¾©æ´»ï¼';updateAttackBtn();},5000)}}
function regenTick(dt){if(state.playerHP>0){const mx=recalcMaxHP();state.playerHP=clamp(state.playerHP+dt*(0.8+state.level*0.02),0,mx)}}
function autoTapTick(dt){if(state.autoTap<=0||!state.engaged||state.isDown)return;autoTapTick._acc=(autoTapTick._acc||0)+state.autoTap*dt;while(autoTapTick._acc>=1){autoTapTick._acc-=1;attack()}}
function bossTimerTick(){if(state.bossEndsAt>0){const left=Math.max(0,state.bossEndsAt-Date.now());if(left<=0){state.bossEndsAt=0;toast('ãƒœã‚¹è¨ä¼å¤±æ•—â€¦1éšæˆ»ã‚‹');state.floor=Math.max(1,state.floor-1);spawnMonster()}ui.bossTimer.textContent=`ï¼ˆãƒœã‚¹æ®‹ã‚Š ${Math.ceil(left/1000)}sï¼‰`}else{ui.bossTimer.textContent=''}}
function toast(m){ui.logline.textContent=m}
function updateUI(){ui.floor.textContent=state.floor;ui.gold.textContent=Math.floor(state.gold);ui.level.textContent=state.level;ui.exp.textContent=`${state.exp}/${state.expToNext}`;ui.atk.textContent=playerATK();ui.crit.textContent=`${Math.floor(playerCRIT())}%`;ui.souls.textContent=state.souls;const mx=recalcMaxHP();const pct=clamp(state.playerHP/mx*100,0,100);ui.hpbar.style.width=`${pct}%`;ui.hptext.textContent=`${Math.floor(state.playerHP)}/${mx}`;ui.costAtk.textContent=prices.atk;ui.costHP.textContent=prices.hp;ui.costAuto.textContent=prices.auto;ui.autoRate.textContent=state.autoTap.toFixed(1);if(ui.staAtk){ui.staAtk.textContent=playerATK();ui.staHP.textContent=recalcMaxHP();ui.staDef.textContent=playerDEF();ui.staCrit.textContent=`${Math.floor(playerCRIT())}%`;ui.staGoldB.textContent=`${Math.floor(goldBPercent())}%`;ui.staSoulB.textContent=`${Math.floor((soulMG()-1)*100)}%`;ui.staMaxFloor.textContent=state.maxFloor;ui.staKills.textContent=state.kills;ui.staDeaths.textContent=state.deaths}const gain=Math.floor(state.maxFloor/30);ui.soulGain&&(ui.soulGain.textContent=gain);updateAttackBtn();refreshNextBtn()}
function renderInventory(){const box=ui.invList;if(!box)return;box.innerHTML='';for(const it of state.inv){const div=document.createElement('div');div.className='card';const title=document.createElement('div');title.innerHTML=`<b class="${it.color}">${it.name}</b>`;const stats=document.createElement('div');stats.className='small';stats.textContent=renderItemText(it);const row=document.createElement('div');row.className='row';const equipBtn=document.createElement('button');equipBtn.className='btn';equipBtn.textContent='è£…å‚™';equipBtn.onclick=()=>{state.eq[it.slot]=it;toast(`è£…å‚™ï¼š${renderItemText(it)}`);updateUI()};const sellBtn=document.createElement('button');sellBtn.className='btn gold';sellBtn.textContent=`å£²å´ (+${Math.floor(it.value)}G)`;sellBtn.onclick=()=>{state.gold+=Math.floor(it.value);state.inv=state.inv.filter(x=>x!==it);renderInventory();updateUI()};row.appendChild(equipBtn);row.appendChild(sellBtn);div.appendChild(title);div.appendChild(stats);div.appendChild(row);box.appendChild(div)}}
function buy(key,cb){const c=prices[key];if(state.gold<c){toast('ãŠé‡‘ãŒè¶³ã‚Šãªã„â€¦');return}state.gold-=c;cb();prices[key]=Math.floor(prices[key]*1.35+2);updateUI()}
function save(manual=false){const data=JSON.stringify({state:{...state,bossEndsAt:0},prices});localStorage.setItem(SAVE_KEY,data);if(manual)toast('ä¿å­˜ã—ã¾ã—ãŸ');ui.ioArea&&(ui.ioArea.value=data)}
function load(manual=false){const raw=localStorage.getItem(SAVE_KEY);if(!raw){if(manual)toast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return}try{const o=JSON.parse(raw);Object.assign(state,o.state);Object.assign(prices,o.prices||{});state.playerHP=clamp(state.playerHP,0,recalcMaxHP());ui.autoEquip&&(ui.autoEquip.checked=!!state.autoEquip);spawnMonster();renderInventory();updateUI();if(manual)toast('èª­è¾¼ã—ã¾ã—ãŸ')}catch(e){console.error(e);toast('èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ')}}
function exportSave(){save(false);const raw=localStorage.getItem(SAVE_KEY);ui.ioArea&&(ui.ioArea.value=raw||'');toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ¬„ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ')}
function importSave(){const raw=ui.ioArea?.value.trim();if(!raw){toast('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');return}try{JSON.parse(raw);localStorage.setItem(SAVE_KEY,raw);load(false);toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼†èª­è¾¼ã—ã¾ã—ãŸ')}catch(e){toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONãŒä¸æ­£ã§ã™')}}
function wipeAll(){if(!confirm('æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰'))return;localStorage.removeItem(SAVE_KEY);location.reload()}
function ascend(){const g=Math.floor(state.maxFloor/30);if(g<=0){toast('è»¢ç”Ÿã§ãã‚‹ã»ã©é€²ã‚“ã§ã„ã¾ã›ã‚“');return}if(!confirm(`è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿç²å¾—ã‚½ã‚¦ãƒ«ï¼š${g}`))return;state.souls+=g;const keepBest=Math.max(state.bestMaxFloor,state.maxFloor);const keepSouls=state.souls;Object.assign(state,{gold:0,level:1,exp:0,expToNext:20,floor:1,maxFloor:1,kills:0,deaths:0,baseATK:1,baseHP:10,baseDEF:0,baseCRIT:5,autoTap:0,eq:{weapon:null,armor:null,ring:null},inv:[],autoEquip:state.autoEquip,monster:null,playerHP:10,bossEndsAt:0,souls:keepSouls,bestMaxFloor:keepBest,isDown:false,engaged:false});prices.atk=10;prices.hp=10;prices.auto=25;spawnMonster();updateUI();renderInventory();toast('è»¢ç”Ÿï¼æ’ä¹…ãƒœãƒ¼ãƒŠã‚¹ãŒå¼·åŒ–ã•ã‚Œã¾ã—ãŸ')}

/* é•·æŠ¼ã—é€£æ‰“é˜²æ­¢ï¼ˆpointerä¸€ç™ºã®ã¿ï¼‰ */
let _pressing=false,_lock=false;function singleFire(){if(_pressing||_lock)return;_pressing=true;_lock=true;attack();setTimeout(()=>_lock=false,250)}
function bindSingle(el){el.addEventListener('pointerdown',e=>{e.preventDefault();singleFire()},{passive:false});el.addEventListener('pointerup',()=>{_pressing=false});el.addEventListener('pointercancel',()=>{_pressing=false});el.addEventListener('pointerleave',()=>{_pressing=false});el.addEventListener('click',()=>{singleFire()})}

/* äº‹ä»¶ */
bindSingle(ui.attackBtn);bindSingle(document.getElementById('monster'));
ui.nextBtn.addEventListener('click',()=>{if(!state.monster||state.monster.hp>0){toast('ã¾ã è¨ä¼ã—ã¦ã„ãªã„ï¼');return}state.floor+=1;spawnMonster();updateUI()});
ui.fleeBtn.addEventListener('click',()=>{state.floor=Math.max(1,state.floor-1);spawnMonster();updateUI()});
ui.buyAtk.addEventListener('click',()=>buy('atk',()=>{state.baseATK+=1;updateAttackBtn()}));
ui.buyHP.addEventListener('click',()=>buy('hp',()=>{state.baseHP+=5;state.playerHP=recalcMaxHP()}));
ui.buyAuto.addEventListener('click',()=>buy('auto',()=>{state.autoTap=parseFloat((state.autoTap+0.2).toFixed(1))}));
ui.autoEquip&&ui.autoEquip.addEventListener('change',e=>{state.autoEquip=e.target.checked});
ui.saveBtn&&ui.saveBtn.addEventListener('click',()=>save(true));
ui.loadBtn&&ui.loadBtn.addEventListener('click',()=>load(true));
ui.exportBtn&&ui.exportBtn.addEventListener('click',exportSave);
ui.importBtn&&ui.importBtn.addEventListener('click',importSave);
ui.wipeBtn&&ui.wipeBtn.addEventListener('click',wipeAll);
ui.ascendBtn&&ui.ascendBtn.addEventListener('click',ascend);
ui.tabs.forEach(t=>{t.addEventListener('click',()=>{ui.tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');const id=t.dataset.tab;[ui.tabUpg,ui.tabInv,ui.tabSta,ui.tabSys].forEach(el=>el.setAttribute('hidden',''));document.getElementById(id).removeAttribute('hidden')})});

/* ãƒˆãƒƒãƒ—ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ */
function applyTopbarCollapsed(collapsed){if(collapsed){ui.topExtra.setAttribute('hidden','');ui.toggleInfo.setAttribute('aria-expanded','false');ui.toggleInfo.textContent='â–¼ è©³ç´°'}else{ui.topExtra.removeAttribute('hidden');ui.toggleInfo.setAttribute('aria-expanded','true');ui.toggleInfo.textContent='â–² é–‰ã˜ã‚‹'}localStorage.setItem(UI_TOP, collapsed?'1':'0')}
ui.toggleInfo.addEventListener('click',()=>{const col=ui.toggleInfo.getAttribute('aria-expanded')==='true';applyTopbarCollapsed(col)});

/* ãƒ«ãƒ¼ãƒ— */
let last=performance.now();
function loop(now){const dt=Math.min(0.1,(now-last)/1000);last=now;autoTapTick(dt);enemyTick(dt);regenTick(dt);bossTimerTick();updateUI();requestAnimationFrame(loop)}

/* èµ·å‹• */
(function init(){const pref=localStorage.getItem(UI_TOP);applyTopbarCollapsed(pref!=='0');load(false);if(!state.monster)spawnMonster();renderInventory();updateUI();requestAnimationFrame(loop);setInterval(()=>save(false),10000);window.addEventListener('beforeunload',()=>save(false))})();
</script>
</body>
</html>