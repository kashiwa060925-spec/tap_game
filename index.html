<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG</title>
<meta name="theme-color" content="#0f1220">
<style>
  :root{
    --c-bg:#0b0f1f;--c-panel:#171a2b;--c-text:#e8eefc;--c-sub:#aab6d6;--c-danger:#ff6b6b;--c-gold:#ffd76a;--c-accent:#6eb6ff;
    --bg1:#0b0f1f; --bg2:#0a0d1a;           /* page background */
    --monster1:#141937; --monster2:#101635; /* monster card gradient */
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%;touch-action:manipulation}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--c-text);-webkit-tap-highlight-color:transparent;padding-bottom:calc(128px + 28px + env(safe-area-inset-bottom));transition:background .3s ease}
  [hidden]{display:none !important}
  header{position:sticky;top:0;z-index:30;background:#0d1120cc;backdrop-filter:blur(6px);border-bottom:1px solid #1f2440;padding:.6rem .8rem}
  .topbar{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .pill{background:#171a2b;border:1px solid #232742;border-radius:12px;padding:.45rem .6rem;font-size:.92rem;color:var(--c-sub)}
  .bar{width:160px;height:12px;border-radius:8px;background:#101425;border:1px solid #283055;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2ddf7f,#67e3a3);width:100%}
  .small{font-size:.85rem;color:var(--c-sub)}
  .toggle{justify-self:end;background:#121639;border:1px solid #2a2f66;color:#c9d6ff;padding:.45rem .6rem;border-radius:10px}
  .toggle[aria-expanded='true']{background:#1a2053}
  main{max-width:1200px;margin:0 auto;padding:1rem}
  .layout{display:grid;grid-template-columns:1.2fr .9fr;gap:1rem}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:#171a2b;border:1px solid #222647;border-radius:14px;padding:1rem;box-shadow:0 8px 24px #00000045,inset 0 1px #2b3159}
  .monster{position:relative;display:grid;gap:.6rem;justify-items:center;text-align:center;padding:1rem;border-radius:12px;background:radial-gradient(80% 80% at 50% 30%, var(--monster1), var(--monster2));border:1px solid #202554;user-select:none;transition:background .3s ease}
  .floor-badge{position:absolute;left:.6rem;top:.6rem;background:#0f1536;border:1px solid #2a2f66;border-radius:10px;padding:.2rem .5rem;font-size:.85rem;color:#cfe0ff}
  .monster-emoji{font-size:76px;line-height:1}
  .hpbar{width:100%;height:18px;background:#0c1026;border:1px solid #2a2f5a;border-radius:10px;overflow:hidden}
  .hpbar>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ff9f6b);width:100%;transition:width .12s ease}
  .monster-info{display:flex;justify-content:space-between;width:100%;color:#aab6d6;font-weight:600}
  .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center}
  .btn{background:#0f1536;color:#cfe0ff;border:1px solid #2a2f66;padding:.8rem 1.1rem;border-radius:12px;cursor:pointer;min-width:44px;min-height:44px}
  .btn:hover{background:#121a43}
  .btn.gold{border-color:#6e5a25;background:#221b08;color:#ffd76a}
  .btn.danger{border-color:#6b2833;background:#2a0d14;color:#ffb0b0}
  .btn:disabled{opacity:.5;filter:grayscale(40%);cursor:not-allowed}
  .btn.mini{padding:.4rem .6rem;border-radius:10px;font-size:.85rem}
  .grid{display:grid;gap:.6rem}
  .inv-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.6rem}
  .card{background:#0f1433;border:1px solid #2a2f66;border-radius:10px;padding:.7rem;display:grid;gap:.35rem}
  .row{display:flex;justify-content:space-between;gap:.6rem;align-items:center;flex-wrap:wrap}
  .muted{color:var(--c-sub)}.warn{color:var(--c-danger)}.gold{color:var(--c-gold)}
  .section-title{font-weight:700;margin:.2rem 0}

  /* Flavor bar (header collapsed only) */
  #flavorBar{background:#0d1120cc;border-bottom:1px solid #1f2440;backdrop-filter:blur(6px);padding:.4rem .8rem}
  #flavorText{font-weight:700;text-align:center;color:#dbe6ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  #mainFooter{position:fixed;left:0;right:0;bottom:0;z-index:20;background:#0d1120f0;backdrop-filter:blur(8px);border-top:1px solid #1f2440;box-shadow:0 -8px 24px rgba(0,0,0,.35);padding-bottom:max(10px, env(safe-area-inset-bottom))}
  #mainFooter .footer-wrap{display:grid;grid-template-columns:repeat(5,1fr);gap:.4rem;max-width:1200px;margin:0 auto;padding:.6rem .6rem .30rem}
  .ftab{background:#121639;border:1px solid #2a2f66;color:#cfe0ff;padding:.65rem .6rem;border-radius:10px;font-weight:700;cursor:pointer}
  .ftab.active{background:#1a2053;outline:2px solid #6888ff66}
  .ftab:focus-visible{outline:2px solid #9dbcff}

  /* Start overlay */
  #startOverlay{position:fixed;inset:0;z-index:9999}
  #startOverlay:not([hidden]) ~ #flavorBar{display:none}
  #startOverlay:not([hidden]) ~ footer{display:none}

  /* Archboss UI bits */
  .archbar{position:absolute;right:.6rem;top:2rem;background:#2a1030;border:1px solid #5a2f66;color:#ffd6ff;border-radius:10px;padding:.2rem .45rem;font-size:.82rem}
</style>
</head>
<body>

<!-- ===== Start Overlay ===== -->
<div id="startOverlay">
  <div class="start-bg" style="position:absolute;inset:0;background:linear-gradient(180deg,#0c1224,#090e1a 60%,#0b0f1f)"></div>
  <div class="start-wrap" style="position:relative;display:flex;align-items:center;justify-content:center;width:100%;min-height:100dvh;padding:28px">
    <div class="start-box" style="width:min(720px,92vw);display:grid;gap:1rem;justify-items:center;text-align:center;background:#151a2eaa;border:1px solid rgba(42,47,102,.95);border-radius:14px;backdrop-filter:blur(6px);box-shadow:0 16px 48px #0008;padding:20px">
      <div class="game-title" id="startTitle" style="font-size:28px;font-weight:800;letter-spacing:.02em;line-height:1.15">ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG</div>
      <div class="title-logo" id="titleLogo" style="font-size:26px">âš”ï¸ ğŸ›¡ï¸ ğŸ’</div>
      <div class="hint">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š<span id="verText">0.9.0</span> ï¼ ã‚»ãƒ¼ãƒ–æ¤œå‡ºï¼š<span id="saveDetect" class="badge" style="display:inline-block;background:#0f1536;border:1px solid #2a2f66;padding:.2rem .5rem;border-radius:10px;color:#cfe0ff">â€¦</span></div>

      <div class="start-actions" style="display:grid;gap:.6rem;width:min(580px,92vw)">
        <div class="row" style="gap:.6rem;justify-content:center">
          <button id="btnPrimary" class="bigbtn" data-mode="local" style="padding:.9rem 1.1rem;border-radius:14px;background:#121639;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer;min-width:180px">ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼</button>
          <button id="btnStartImportFile" class="bigbtn" style="padding:.9rem 1.1rem;border-radius:14px;background:#0b122e;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer;min-width:180px">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
        </div>

        <input id="fileOpenStart" type="file" accept="application/json" hidden>

        <div id="newWrap" style="display:block">
          <div class="divider" style="height:1px;background:#2a2f66;width:100%;opacity:.6;margin:.3rem 0"></div>
          <div class="inline" style="display:flex;gap:.5rem;align-items:center;justify-content:center"><label for="startName" style="font-weight:700;line-height:1.2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label><input id="startName" class="input" maxlength="20" placeholder="æœªå…¥åŠ›ãªã‚‰ã€æ—…äººã€ã§é–‹å§‹" style="background:#0b0f25;color:#cfe0ff;border:1px solid #2a2f66;border-radius:8px;padding:.55rem"></div>
          <div class="inline" style="display:flex;gap:.5rem;align-items:center;justify-content:center"><button id="btnBegin" class="btn">ã¯ã˜ã‚ã‚‹</button></div>
          <div class="small" id="startNote" style="opacity:.9"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="wrap" id="top-collapsed">
      <div class="pill">æ‰€æŒ <span class="gold"><b id="c-gold">0</b> G</span></div>
      <div class="pill">Lv <b id="c-level">1</b></div>
      <div class="pill">EXP <b id="c-exp">0/20</b></div>
    </div>
    <button id="toggleInfo" class="toggle" aria-expanded="false" aria-controls="top-expanded">â–¼ è©³ç´°</button>
    <div class="wrap" id="top-expanded" hidden>
      <div class="pill">éšå±¤ <b id="x-floor">1</b></div>
      <div class="pill">Lv <b id="x-level">1</b></div>
      <div class="pill">EXP <b id="x-exp">0/20</b></div>
      <div class="pill">HP <span class="bar"><span id="x-hpbar" style="width:100%"></span></span> <span class="small" id="x-hptext">10/10</span></div>
      <div class="pill">ATK <b id="x-atk">1</b></div>
      <div class="pill">æ‰€æŒ <span class="gold"><b id="x-gold">0</b> G</span></div>
      <div class="pill">ã‚½ã‚¦ãƒ« <b id="x-souls">0</b></div>
      <div class="pill">ã‚¯ãƒªç‡ <b id="x-crit">5%</b></div>
      <div class="pill"><span class="small" id="timerAll"></span></div>
    </div>
  </div>
</header>

<!-- â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ç¸®å°æ™‚ã®ã¿è¡¨ç¤ºã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ãƒãƒ¼ -->
<div id="flavorBar" hidden>
  <div id="flavorText">â€¦â€¦</div>
</div>

<main>
  <div class="layout">

    <!-- ===== Left: Monster & Floor ===== -->
    <section class="panel">
      <div id="monster" class="monster" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ”»æ’ƒ">
        <div class="floor-badge" id="floorBadge">éšå±¤ 1 <span class="theme-badge" id="themeBadge">â€”</span></div>
        <div id="archBadge" class="archbar" hidden>éšœå£ 0/0</div>
        <div class="monster-emoji" id="monsterFace" aria-hidden="true">ğŸ‘ï¸</div>
        <div class="hpbar" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info"><span id="monsterName">Lv1 ã‚´ãƒ–ãƒªãƒ³</span><span id="monsterHPText">10 / 10</span></div>

        <!-- ä¸Šéƒ¨ãƒ­ã‚°ï¼ˆæœ€æ–°3ä»¶ï¼‰ -->
        <div id="logbox" aria-live="polite" aria-atomic="false">
          <div class="logrow" id="log0"></div>
          <div class="logrow" id="log1"></div>
          <div class="logrow" id="log2"></div>
        </div>

        <div class="actions"><button class="btn" id="attackBtn">æˆ¦é—˜é–‹å§‹ï¼</button></div>
      </div>

      <div class="footnote" id="footnoteBoss">10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™30ç§’</span>ï¼‰ã€‚<br>30éšã”ã¨ã«<strong>ç‰¹åˆ¥ãƒœã‚¹</strong>ï¼ˆ<span class="warn">åˆ¶é™60ç§’ï¼‹éšœå£ã‚®ãƒŸãƒƒã‚¯</span>ï¼‰ã€‚</div>
    </section>

    <section class="panel" id="panel-floor">
      <div class="grid">
        <div class="row"><b>éšå±¤ç§»å‹•</b><label class="small"><input type="checkbox" id="stayCb"> ã“ã®éšå±¤ã«ç•™ã¾ã‚‹</label></div>
        <div class="row" style="gap:.5rem;align-items:center">
          <button class="btn danger" id="fleeBtn">1éšæˆ»ã‚‹</button>
          <!-- ç›´æ¥å…¥åŠ›ã§ç§»å‹• -->
          <input id="jumpInput" type="number" min="1" step="1" placeholder="éšå±¤" class="input" style="width:120px;background:#0b0f25;color:#cfe0ff;border:1px solid #2a2f66;border-radius:8px;padding:.5rem" />
          <button class="btn" id="jumpBtn">ç§»å‹•</button>
          <button class="btn gold" id="nextBtn" title="">æ¬¡ã®éšå±¤ã¸</button>
        </div>
        <div class="divider-thin"></div>
        <div class="small muted" id="floorHint"></div>
      </div>
    </section>

    <!-- ===== Right: Tabs content (panels) ===== -->
    <section class="panel">

      <!-- å¼·åŒ– -->
      <div id="tab-upg" class="grid">
        <div class="tab-row"><div class="small muted">å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div><div class="small">æ‰€æŒ <b id="upgGold">0</b> G</div></div>

        <div class="card">
          <div class="row"><div><b>æ”»æ’ƒåŠ›å¼·åŒ–</b><div class="small muted" id="countAtk">è³¼å…¥å›æ•°ï¼š0</div><div class="small muted">ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ </div></div><div class="gold"><b id="costAtk">10</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyAtk">è³¼å…¥ (+1 ATK) / Lv <b id="lvAtk">0</b></button>
            <button class="btn mini" data-bulk="atk-10">Ã—10</button>
            <button class="btn mini" data-bulk="atk-100">Ã—100</button>
            <button class="btn mini" data-bulk="atk-max">MAX</button>
          </div>
        </div>

        <div class="card">
          <div class="row"><div><b>æœ€å¤§HPå¼·åŒ–</b><div class="small muted" id="countHP">è³¼å…¥å›æ•°ï¼š0</div><div class="small muted">è€ä¹…ã‚’å¢—åŠ </div></div><div class="gold"><b id="costHP">10</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyHP">è³¼å…¥ (+5 HP) / Lv <b id="lvHP">0</b></button>
            <button class="btn mini" data-bulk="hp-10">Ã—10</button>
            <button class="btn mini" data-bulk="hp-100">Ã—100</button>
            <button class="btn mini" data-bulk="hp-max">MAX</button>
          </div>
        </div>

        <div class="card">
          <div class="row"><div><b>è‡ªå‹•ã‚¿ãƒƒãƒ—</b><div class="small muted" id="countAuto">è³¼å…¥å›æ•°ï¼š0</div><div class="small muted">æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰</div></div><div class="gold"><b id="costAuto">25</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyAuto">è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’) / Lv <b id="lvAuto">0</b></button>
            <button class="btn mini" data-bulk="auto-10">Ã—10</button>
            <button class="btn mini" data-bulk="auto-100">Ã—100</button>
            <button class="btn mini" data-bulk="auto-max">MAX</button>
          </div>
          <div class="small muted">ç¾åœ¨ï¼š<b id="autoRate">0.0</b> ã‚¿ãƒƒãƒ—/ç§’</div>
        </div>
      </div>

      <!-- è£…å‚™ï¼ˆã‚µãƒ–ã‚¿ãƒ–ä»˜ãï¼‰ -->
      <div id="tab-inv" class="grid" hidden>
        <div class="row" id="inv-subtabs">
          <div class="wrap" style="gap:.4rem;flex-wrap:wrap">
            <button class="subtab active" data-invtab="all">ã™ã¹ã¦</button>
            <button class="subtab" data-invtab="weapon">æ­¦å™¨</button>
            <button class="subtab" data-invtab="armor">é§</button>
            <button class="subtab" data-invtab="ring">æŒ‡è¼ª</button>
          </div>
          <div class="small muted" id="inv-filter-info"></div>
        </div>

        <div class="card"><div><b>è£…å‚™ä¸­</b></div><div class="small">æ­¦å™¨ï¼š<span id="eq-weapon">ãªã—</span></div><div class="small">é§ã€€ï¼š<span id="eq-armor">ãªã—</span></div><div class="small">æŒ‡è¼ªï¼š<span id="eq-ring">ãªã—</span></div></div>
        <div class="card"><div class="row"><b>æ‰€æŒå“</b><label class="small"><input type="checkbox" id="autoEquip" /> å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™</label></div><div class="inv-list" id="invList"></div></div>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
      <div id="tab-sta" class="grid" hidden>
        <div class="card">
          <div class="section-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div class="small">ATKï¼š<b id="sta-atk">1</b></div>
          <div class="small">æœ€å¤§HPï¼š<b id="sta-hp">10</b></div>
          <div class="small">é˜²å¾¡ï¼š<b id="sta-def">0</b></div>
          <div class="small">ã‚¯ãƒªç‡ï¼ˆãƒ©ãƒƒã‚¯ï¼‰ï¼š<b id="sta-crit">5%</b></div>
          <div class="small">ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š<b id="sta-goldb">0%</b></div>
          <div class="small">ã‚½ã‚¦ãƒ«è£œæ­£ï¼ˆæ’ä¹…ï¼‰ï¼š<b id="sta-soulb">ATK <span id="sta-satk">0</span>% / HP <span id="sta-shp">0</span>% / Gold <span id="sta-sgold">0</span>%</b></div>
          <div class="small">è‡ªå‹•ã‚¿ãƒƒãƒ—ï¼š<b id="sta-autotap">0.0</b> /ç§’</div>
          <div class="small">è£…å‚™ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼š<b id="sta-itemdrop">20%</b></div>
          <div class="small">ãƒŸãƒŸãƒƒã‚¯å‡ºç¾ç‡ï¼š<b id="sta-mimic">3.00%</b></div>
          <div class="small">ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒŸãƒŸãƒƒã‚¯å‡ºç¾ç‡ï¼š<b id="sta-supermimic">1.20%</b></div>
          <div class="small">çŸ³ã“ã‚ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼š<b id="sta-stonedrop">5%</b>ï¼ˆ1å›ã‚ãŸã‚Š<b id="sta-stoneamt">0</b>å€‹ï¼‰</div>
        </div>
        <div class="card">
          <div class="section-title">æˆ¦ç¸¾</div>
          <div class="small">æœ€é«˜åˆ°é”éšå±¤ï¼š<b id="sta-maxfloor">1</b></div>
          <div class="small">è¨ä¼æ•°ï¼š<b id="sta-kills">0</b></div>
          <div class="small">æ­»äº¡æ•°ï¼š<b id="sta-deaths">0</b></div>
        </div>
        <div class="card">
          <div class="section-title">æ‰€æŒç‰©</div>
          <div class="small">ã‚´ãƒ¼ãƒ«ãƒ‰ï¼š<b id="bag-gold">0</b> G</div>
          <div class="small">ã‚½ã‚¦ãƒ«ï¼š<b id="bag-soul">0</b>ï¼ˆç´¯è¨ˆæ¶ˆè²»ï¼š<b id="bag-soulspent">0</b>ï¼‰</div>
          <div class="small">é­”çŸ³ï¼š<b id="bag-gem">0</b></div>
          <div class="small">è¼ãçŸ³ã“ã‚ï¼š<b id="bag-peb">0</b></div>
          <div class="small">è£…å‚™æ‰€æŒæ•°ï¼š<b id="bag-eq">0</b></div>
        </div>
      </div>

      <!-- è»¢ç”Ÿ/è–éºç‰©ï¼ˆåˆ†å‰²ï¼‰ -->
      <div id="tab-adv" class="grid" hidden>
        <div class="card">
          <div class="adv-subtabs">
            <button class="advtab active" data-advtab="adv-asc">è»¢ç”Ÿ / ã‚½ã‚¦ãƒ«å¼·åŒ–</button>
            <button class="advtab" data-advtab="adv-relic">è–éºç‰©</button>
          </div>
          <div id="adv-asc">
            <div class="section-title">è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰</div>
            <div class="small" id="ascDesc">è»¢ç”Ÿã§ <b>ã‚½ã‚¦ãƒ«</b> ã‚’ç²å¾—ã€‚ã‚½ã‚¦ãƒ«ã¯æ’ä¹…çš„ã«<span class="gold">ç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰</span>ã¨<b>æ”»æ’ƒåŠ›</b>ã‚’ä¸Šã’ã¾ã™ã€‚</div>
            <div class="row"><div>ç²å¾—è¦‹è¾¼ã¿ï¼š<b id="soulGain">0</b> ã‚½ã‚¦ãƒ«</div><button class="btn danger" id="ascendBtn">è»¢ç”Ÿã™ã‚‹</button></div>
            <div class="divider-thin"></div>
            <div class="section-title">ã‚½ã‚¦ãƒ«å¼·åŒ–ï¼ˆæ’ä¹…ï¼‰</div>
            <div class="small">æ‰€æŒã‚½ã‚¦ãƒ«ï¼š<b id="soulRemain">0</b> ï¼ ç´¯è¨ˆæ¶ˆè²»ï¼š<b id="soulSpent">0</b></div>
            <div class="grid" style="margin-top:.4rem">
              <div class="card">
                <div class="row"><div><b>æ°¸ç¶šãƒ»æ”»æ’ƒåŠ›</b><div class="small muted">+2% / Lvï¼ˆä¹—ç®—ï¼‰</div></div><div class="small">Lv <b id="soulLvAtk">0</b> ï¼ æ¬¡ã®å¿…è¦ã‚½ã‚¦ãƒ«ï¼š<b id="soulCostAtk">1</b></div></div>
                <div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyAtk">å¼·åŒ–ã™ã‚‹</button></div>
              </div>
              <div class="card">
                <div class="row"><div><b>æ°¸ç¶šãƒ»æœ€å¤§HP</b><div class="small muted">+2% / Lvï¼ˆä¹—ç®—ï¼‰</div></div><div class="small">Lv <b id="soulLvHP">0</b> ï¼ æ¬¡ã®å¿…è¦ã‚½ã‚¦ãƒ«ï¼š<b id="soulCostHP">1</b></div></div>
                <div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyHP">å¼·åŒ–ã™ã‚‹</button></div>
              </div>
              <div class="card">
                <div class="row"><div><b>æ°¸ç¶šãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰</b><div class="small muted">+2% / Lvï¼ˆåŠ ç®—ï¼‰</div></div><div class="small">Lv <b id="soulLvGold">0</b> ï¼ æ¬¡ã®å¿…è¦ã‚½ã‚¦ãƒ«ï¼š<b id="soulCostGold">1</b></div></div>
                <div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyGold">å¼·åŒ–ã™ã‚‹</button></div>
              </div>
            </div>
          </div>

          <div id="adv-relic" hidden>
            <div class="card" id="relicKashiwaCard" hidden>
              <div class="row"><b>æŸã®åŠ è­·</b><label class="small"><input type="checkbox" id="relicKashiwa"> æœ‰åŠ¹åŒ–</label></div>
              <div class="small">åŠ¹æœï¼šã‚¿ãƒƒãƒ—æ™‚ã€ä¸ãˆãŸä¸€æ’ƒãŒæ•µHPã‚’è¶…ãˆãŸåˆ†ã ã‘è¤‡æ•°ä½“è¨ä¼ï¼ˆATKåŸºæº–ï¼‰ã€‚2ä½“ä»¥ä¸Šå€’ã™ã¨ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
            </div>
            <div class="card" id="relicLockedCard">
              <b>è–éºç‰©ï¼ˆæœªè§£æ”¾ï¼‰</b>
              <div class="small">è¨­å®šã‚¿ãƒ–ã®ã€Œã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆã€ã§å…¥æ‰‹ã§ãã¾ã™</div>
            </div>

            <div class="card" id="relicStrongSwordLocked">
              <b>è–éºç‰©ï¼ˆæœªè§£æ”¾ï¼‰</b>
              <div class="small muted">ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆã§å…¥æ‰‹ã§ãã¾ã™ï¼ˆã‚³ãƒ¼ãƒ‰ï¼š<b>kashiwa77</b>ï¼‰</div>
            </div>
            <div class="card" id="relicStrongSwordCard" hidden>
              <div class="row"><b>ãƒ„ãƒ¨ã‚¹ã‚®ãƒ†=ã‚¯ã‚µãƒã‚¨ãƒ«</b><label class="small"><input type="checkbox" id="relicStrongSword"> æœ‰åŠ¹åŒ–</label></div>
              <div class="small">ãªã‚“ã§ã‚‚æ­¦å™¨ã«ã§ãã‚‹ã‚²ãƒ¼ãƒ ã«ç™»å ´ã—ãŸæœ€å¼·ï¼Ÿã®å‰£ã€‚æ”»æ’ƒåŠ›ã‚’<b>99å€</b>ã«ã™ã‚‹</div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¨­å®š/ã‚»ãƒ¼ãƒ– -->
      <div id="tab-settings" class="grid" hidden>
        <div class="card">
          <b>ã‚»ãƒ¼ãƒ–</b>
          <div class="row" style="gap:.4rem;align-items:center">
            <input id="exportName" class="input" placeholder="ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ã¯è‡ªå‹•ã§ .jsonï¼‰" style="flex:1" />
            <button class="btn" id="downloadBtn">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
          <div class="small muted" style="margin-top:.3rem">â€»ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã¯å†…éƒ¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚</div>
        </div>
        <div class="card">
          <b>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>
          <div class="row" style="gap:.6rem;align-items:center">
            <button class="btn" id="importFileBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
            <input id="fileOpenSettings" type="file" accept="application/json" hidden>
          </div>
          <div class="small muted">JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®å†…å®¹ã‚’ã‚»ãƒ¼ãƒ–ã¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚</div>
        </div>
        <div class="card">
          <b>ãã®ä»–</b>
          <div class="row" style="gap:.6rem"><button class="btn danger" id="wipeBtn">å…¨å‰Šé™¤</button></div>
        </div>
        <div class="card">
          <b>ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆ</b>
          <div class="row"><input id="codeInput" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="input" style="flex:1;min-width:160px"/><button class="btn" id="codeBtn">å¼•ãæ›ãˆ</button></div>
          <div class="small muted" id="codeStatus"></div>
        </div>
        <div class="card">
          <b>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </b>
          <div class="row" style="gap:.6rem;align-items:center">
            <input id="nameEdit" class="input" maxlength="20" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ " style="flex:1">
            <button class="btn" id="nameSave">ä¿å­˜</button>
          </div>
        </div>
      </div>

    </section>
  </div>
</main>

<!-- ===== å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ï¼‰ ===== -->
<footer id="mainFooter" role="navigation" aria-label="ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <div class="footer-wrap">
    <button class="ftab active" data-tab="tab-upg" aria-controls="tab-upg" aria-label="å¼·åŒ–">å¼·åŒ–</button>
    <button class="ftab" data-tab="tab-inv" aria-controls="tab-inv" aria-label="è£…å‚™">è£…å‚™</button>
    <button class="ftab" data-tab="tab-sta" aria-controls="tab-sta" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
    <button class="ftab" data-tab="tab-adv" aria-controls="tab-adv" aria-label="è»¢ç”Ÿ/è–éºç‰©">è»¢ç”Ÿ</button>
    <button class="ftab" data-tab="tab-settings" aria-controls="tab-settings" aria-label="è¨­å®š/ã‚»ãƒ¼ãƒ–">è¨­å®š</button>
  </div>
</footer>

<script>
const GAME_VERSION='0.9.0';
const SAVE_KEY='tap_hns_save_v5', UI_MODE='ui_top_mode_v7', AUDIO_KEY='tap_hns_audio_v1';
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

// ====== Game State (full)
const state={
  gold:0, level:1, exp:0, expToNext:20,
  floor:1, maxFloor:1, bestMaxFloor:1,
  kills:0, deaths:0,
  baseATK:1, baseHP:10, baseDEF:0, baseCRIT:5,
  autoTap:0,
  eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:false,
  monster:null, playerHP:10, bossEndsAt:0,
  souls:0, soulsSpent:0,
  soulUp:{atk:0,hp:0,gold:0},
  isDown:false, engaged:false, reviveAt:0, stay:false,
  pebbles:0, magicStones:0,
  upg:{atk:0,hp:0,auto:0},
  unlocks:{kashiwa:false, strongsword:false},
  relicActive:{kashiwa:false, strongsword:false},
  flavorIdx:0,
  invFilter:'all',
  themes:{},
  username:'', lastSeenVersion:GAME_VERSION
};
const prices={atk:10,hp:10,auto:25};

// ====== UI refs
const ui={
  startOverlay:$('#startOverlay'), verText:$('#verText'), saveDetect:$('#saveDetect'),
  btnPrimary:$('#btnPrimary'), btnStartImportFile:$('#btnStartImportFile'), fileOpenStart:$('#fileOpenStart'),
  startName:$('#startName'), btnBegin:$('#btnBegin'), startNote:$('#startNote'),
  c_gold:$('#c-gold'), c_level:$('#c-level'), c_exp:$('#c-exp'), x_floor:$('#x-floor'), x_level:$('#x-level'), x_exp:$('#x-exp'), x_hpbar:$('#x-hpbar'), x_hptxt:$('#x-hptext'), x_atk:$('#x-atk'), x_gold:$('#x-gold'), x_souls:$('#x-souls'), x_crit:$('#x-crit'), timerAll:$('#timerAll'), toggleInfo:$('#toggleInfo'), topCollapsed:$('#top-collapsed'), topExpanded:$('#top-expanded'),
  flavorBar:$('#flavorBar'), flavorText:$('#flavorText'),
  floorBadge:$('#floorBadge'), themeBadge:$('#themeBadge'), monsterFace:$('#monsterFace'), monsterHP:$('#monsterHP'), monsterHPText:$('#monsterHPText'), monsterName:$('#monsterName'), attackBtn:$('#attackBtn'),
  nextBtn:$('#nextBtn'), fleeBtn:$('#fleeBtn'), floorHint:$('#floorHint'), stayCb:$('#stayCb'), jumpInput:$('#jumpInput'), jumpBtn:$('#jumpBtn'),
  tabUpg:$('#tab-upg'), tabInv:$('#tab-inv'), tabSta:$('#tab-sta'), tabAdv:$('#tab-adv'), tabSettings:$('#tab-settings'),
  costAtk:$('#costAtk'), costHP:$('#costHP'), costAuto:$('#costAuto'), buyAtk:$('#buyAtk'), buyHP:$('#buyHP'), buyAuto:$('#buyAuto'), autoRate:$('#autoRate'), upgGold:$('#upgGold'), lvAtk:$('#lvAtk'), lvHP:$('#lvHP'), lvAuto:$('#lvAuto'),
  countAtk:$('#countAtk'), countHP:$('#countHP'), countAuto:$('#countAuto'),
  invList:$('#invList'), eqWeapon:$('#eq-weapon'), eqArmor:$('#eq-armor'), eqRing:$('#eq-ring'), autoEquip:$('#autoEquip'),
  invSubtabs:$('#inv-subtabs')?document.querySelectorAll('#inv-subtabs .subtab'):[], invFilterInfo:$('#inv-filter-info'),
  staAtk:$('#sta-atk'), staHP:$('#sta-hp'), staDef:$('#sta-def'), staCrit:$('#sta-crit'), staGoldB:$('#sta-goldb'), staSoulB:$('#sta-soulb'), staSatk:$('#sta-satk'), staShp:$('#sta-shp'), staSgold:$('#sta-sgold'), staMaxFloor:$('#sta-maxfloor'), staKills:$('#sta-kills'), staDeaths:$('#sta-deaths'), staAutoTap:$('#sta-autotap'), staItemDrop:$('#sta-itemdrop'), staMimic:$('#sta-mimic'), staSuperMimic:$('#sta-supermimic'), staStoneDrop:$('#sta-stonedrop'), staStoneAmt:$('#sta-stoneamt'),
  bagGold:$('#bag-gold'), bagSoul:$('#bag-soul'), bagSoulSpent:$('#bag-soulspent'), bagGem:$('#bag-gem'), bagPeb:$('#bag-peb'), bagEq:$('#bag-eq'),
  relicLockedCard:$('#relicLockedCard'), relicKashiwaCard:$('#relicKashiwaCard'), relicKashiwa:$('#relicKashiwa'),
  relicStrongSwordCard:$('#relicStrongSwordCard'), relicStrongSwordLocked:$('#relicStrongSwordLocked'), relicStrongSword:$('#relicStrongSword'),
  ascendBtn:$('#ascendBtn'), soulGain:$('#soulGain'),
  advTabs:$$('.advtab'), advAsc:$('#adv-asc'), advRelic:$('#adv-relic'),
  soulRemain:$('#soulRemain'), soulSpent:$('#soulSpent'),
  soulLvAtk:$('#soulLvAtk'), soulLvHP:$('#soulLvHP'), soulLvGold:$('#soulLvGold'),
  soulCostAtk:$('#soulCostAtk'), soulCostHP:$('#soulCostHP'), soulCostGold:$('#soulCostGold'),
  soulBuyAtk:$('#soulBuyAtk'), soulBuyHP:$('#soulBuyHP'), soulBuyGold:$('#soulBuyGold'),
  codeInput:$('#codeInput'), codeBtn:$('#codeBtn'), codeStatus:$('#codeStatus'),
  exportName:$('#exportName'), downloadBtn:$('#downloadBtn'),
  importFileBtn:$('#importFileBtn'), fileOpenSettings:$('#fileOpenSettings'),
  wipeBtn:$('#wipeBtn'), nameEdit:$('#nameEdit'), nameSave:$('#nameSave'),
  archBadge:$('#archBadge')
};

// ===== Utils & helpers
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function choice(a){return a[randInt(0,a.length-1)]}

// ===== Theme assignment per 30-floor block
const THEMES=[{key:'plains',label:'è‰åŸ'},{key:'forest',label:'æ£®'},{key:'desert',label:'ç ‚æ¼ '},{key:'undead',label:'ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰'},{key:'cave',label:'æ´çªŸ'},{key:'arcane',label:'ç§˜è¡“'}];
function currentBlockIdx(){ return Math.floor((state.floor-1)/30) }
function ensureThemeForBlock(bi){ if(state.themes[bi]) return state.themes[bi]; const prev=state.themes[bi-1]; const keys=THEMES.map(t=>t.key); const pool=prev?keys.filter(k=>k!==prev):keys; const pick=choice(pool); state.themes[bi]=pick; save(false); return pick }
function themeLabel(key){ return (THEMES.find(t=>t.key===key)?.label)||'â€”' }

const THEME_SKIN={
  plains:{bg1:'#0d1c14',bg2:'#08140e', monster1:'#10251a', monster2:'#0b1a13'},
  forest:{bg1:'#0d2014',bg2:'#08160f', monster1:'#0f2a18', monster2:'#0a1d12'},
  desert:{bg1:'#1f1a0d',bg2:'#161107', monster1:'#2e2410', monster2:'#211a0b'},
  undead:{bg1:'#1a1420',bg2:'#130f19', monster1:'#21172e', monster2:'#180f26'},
  cave:{  bg1:'#0d121a',bg2:'#090e14', monster1:'#121b28', monster2:'#0c131d'},
  arcane:{bg1:'#151631',bg2:'#0f1024', monster1:'#1e2150', monster2:'#14173a'}
};
function applyThemeSkin(themeKey){ const s=THEME_SKIN[themeKey]||THEME_SKIN.plains; const root=document.documentElement.style; root.setProperty('--bg1',s.bg1); root.setProperty('--bg2',s.bg2); root.setProperty('--monster1',s.monster1); root.setProperty('--monster2',s.monster2); }

// ===== Stats calc
function soulAtkMult(){ return 1 + state.soulUp.atk * 0.02 }
function soulHPMult(){ return 1 + state.soulUp.hp  * 0.02 }
function soulGoldBonus(){ return state.soulUp.gold * 2 }
function recalcMaxHP(){ const armorHP=state.eq.armor?.hp??0; const base=state.baseHP+armorHP; return Math.max(1,Math.floor(base*soulHPMult())) }
function playerATK(){ const w=state.eq.weapon?.atk??0, r=state.eq.ring?.atk??0; let base=Math.max(1,Math.floor((state.baseATK+w+r)*soulAtkMult())); if(state.relicActive.strongsword) base*=99; return base }
function playerDEF(){ return state.baseDEF+(state.eq.armor?.def??0) }
function playerCRIT(){ return clamp(state.baseCRIT+(state.eq.ring?.crit??0),0,100) }
function goldB(){ const rg=state.eq.ring?.goldB??0; return rg + soulGoldBonus() }

// ===== Enemy scaling
function clickDamage(){ const c=Math.random()*100<playerCRIT(); let d=playerATK(); if(c)d=Math.floor(d*1.8); return {dmg:d,isCrit:c} }
function eHP(f,b){ return Math.floor((14*Math.pow(f,1.18)+6)*(b?6:1)) }
function eGold(f,b){ return Math.floor((4*Math.pow(f,1.10)+2)*(b?4:1)) }
function eATK(f,b){ return Math.floor((1.2*Math.pow(f,1.05)+0.6)*(b?2:1)) }

// ===== Log helpers
const _logBuf=[]; function renderLog(){ for(let i=0;i<3;i++){ const el=document.getElementById(`log${i}`); if(el) el.innerHTML=_logBuf[i]||''; } }
function pushLog(html){ _logBuf.unshift(html); if(_logBuf.length>3)_logBuf.length=3; renderLog(); }
function toast(m){ const t=typeof m==='string'?m.replace(/</g,'&lt;').replace(/>/g,'&gt;'):String(m); pushLog(t); }

// ===== Pools
const MONSTER_POOL=[
  {name:'é‡ã†ã•ã',emoji:'ğŸ‡',tags:['plains']}, {name:'é‡ãƒã‚ºãƒŸ',emoji:'ğŸ­',tags:['plains']}, {name:'ã‚ªã‚ªã‚«ãƒŸ',emoji:'ğŸº',tags:['plains','forest']}, {name:'èœ‚ã®ç¾¤ã‚Œ',emoji:'ğŸ',tags:['plains','forest']}, {name:'ã‚«ã‚¨ãƒ«',emoji:'ğŸ¸',tags:['plains']}, {name:'å¤§ã‚¤ãƒã‚·ã‚·',emoji:'ğŸ—',tags:['plains','forest']}, {name:'å¦–ç²¾',emoji:'ğŸ§š',tags:['plains','arcane']}, {name:'ãƒˆãƒ¬ãƒ³ãƒˆã®æ',emoji:'ğŸŒ¿',tags:['plains','forest']},
  {name:'ã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸ‘¹',tags:['forest','cave']}, {name:'æ£®ã®ç²¾',emoji:'ğŸŒ²',tags:['forest','plains']}, {name:'å¤§ã‚³ã‚¬ãƒãƒ ã‚·',emoji:'ğŸ',tags:['forest','plains']}, {name:'ã‚¯ãƒ',emoji:'ğŸ»',tags:['forest']},
  {name:'ã‚µã‚½ãƒª',emoji:'ğŸ¦‚',tags:['desert']}, {name:'ã‚³ãƒ–ãƒ©',emoji:'ğŸ',tags:['desert']}, {name:'ãƒ©ã‚¯ãƒ€ãƒã‚°',emoji:'ğŸ«',tags:['desert']}, {name:'ç ‚ã®ç²¾',emoji:'ğŸŸ¨',tags:['desert','arcane']},
  {name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',emoji:'ğŸ’€',tags:['undead','cave']}, {name:'ã‚¾ãƒ³ãƒ“',emoji:'ğŸ§Ÿ',tags:['undead']}, {name:'ã‚´ãƒ¼ã‚¹ãƒˆ',emoji:'ğŸ‘»',tags:['undead','arcane']}, {name:'ãƒŸã‚¤ãƒ©',emoji:'ğŸ§»',tags:['desert','undead']},
  {name:'ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸ¦‡',tags:['cave','undead']}, {name:'å·¨å¤§ã‚°ãƒ¢',emoji:'ğŸ•·ï¸',tags:['cave']}, {name:'å²©ã‚´ãƒ¼ãƒ¬ãƒ ',emoji:'ğŸª¨',tags:['cave']}, {name:'ç›®ç‰',emoji:'ğŸ‘ï¸',tags:['arcane','cave']},
  {name:'é­”å°æ›¸',emoji:'ğŸ“•',tags:['arcane']}, {name:'æ°´æ™¶ä½“',emoji:'ğŸ’ ',tags:['arcane','cave']}, {name:'é­”æ³•ä½¿ã„ã®æ‰‹',emoji:'ğŸ–ï¸',tags:['arcane']}
];
const BOSS_POOL=[
  {name:'ã‚¨ãƒ³ãƒˆ',emoji:'ğŸŒ³',tags:['plains','forest']}, {name:'å¤§çŒªç‹',emoji:'ğŸ—',tags:['plains','forest']}, {name:'ç ‚ç«œ',emoji:'ğŸ²',tags:['desert']}, {name:'ã‚¹ãƒ•ã‚£ãƒ³ã‚¯ã‚¹',emoji:'ğŸ—¿',tags:['desert','arcane']}, {name:'ãƒªãƒƒãƒ',emoji:'ğŸª¦',tags:['undead','arcane']}, {name:'ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ',emoji:'ğŸ—¡ï¸',tags:['undead']}, {name:'ã‚±ã‚¤ãƒ–ãƒˆãƒ­ãƒ¼ãƒ«',emoji:'ğŸ‘¹',tags:['cave']}, {name:'å·¨å²©ç‹',emoji:'ğŸª¨',tags:['cave']}, {name:'ã‚¢ãƒ¼ã‚¯ãƒ¡ã‚¤ã‚¸',emoji:'ğŸ§™',tags:['arcane']}, {name:'è™šã‚ãªçœ¼',emoji:'ğŸ‘ï¸',tags:['arcane','cave']}
];
const ARCHBOSS_POOL=[
  {name:'é»æ˜ã®å®ˆè­·è€…',emoji:'ğŸŒ…',tags:['plains','coast']},
  {name:'æ·±ç·‘ã®ç²¾éœŠç‹',emoji:'ğŸŒ¿',tags:['forest']},
  {name:'ç ‚ä¸Šã®æš´å›',emoji:'ğŸœï¸',tags:['desert']},
  {name:'å†¥åºœã®ç‹',emoji:'ğŸ•±',tags:['undead']},
  {name:'åœ°åº•ã®è¦‡è€…',emoji:'â›ï¸',tags:['cave']},
  {name:'ç§˜è¡“ã®å¯©å•å®˜',emoji:'ğŸ”®',tags:['arcane']}
];
const SPECIAL_POOL=[
  {name:'ãƒŸãƒŸãƒƒã‚¯',emoji:'ğŸ§°', kind:'mimic', mult:1.05, goldMult:10, minRarity:'Rare'},
  {name:'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒŸãƒŸãƒƒã‚¯',emoji:'âœ¨ğŸ§°', kind:'supermimic', mult:1.20, goldMult:100, minRarity:'Epic'}
];

function poolByTheme(pool, theme){ const list=pool.filter(x=> (x.tags||[]).includes(theme)); return list.length?list:pool }

// ===== Items
const RARITIES=[{name:'Common',weight:60,mult:1},{name:'Uncommon',weight:25,mult:1.4},{name:'Rare',weight:10,mult:2},{name:'Epic',weight:4,mult:3},{name:'Legendary',weight:1,mult:4.5}];
function weightedPick(arr){ const t=arr.reduce((s,i)=>s+i.weight,0); let r=Math.random()*t; for(const it of arr){ r-=it.weight; if(r<=0) return it; } return arr[arr.length-1] }
function cryptoId(){ const a=new Uint32Array(2); (window.crypto||window.msCrypto)?.getRandomValues?.(a); return [...a].map(x=>x.toString(16)).join('') }
function makeItem(f, minRarity){ const kinds=['weapon','armor','ring']; const k=choice(kinds); const rar=weightedPick(RARITIES); const order={'Common':0,'Uncommon':1,'Rare':2,'Epic':3,'Legendary':4}; let rarName=rar.name; if(minRarity && order[rarName]<order[minRarity]) rarName=minRarity; const mult=RARITIES.find(r=>r.name===rarName).mult; const bp=Math.max(1,Math.floor((Math.pow(f,1.12)+randInt(0,f))*0.5*mult)); const it={id:cryptoId(),name:'',slot:k,rarity:rarName,lvl:f,value:Math.max(1,Math.floor(bp*1.2))}; if(k==='weapon'){it.atk=Math.max(1,Math.floor(bp)); if(rarName!=='Common'&&Math.random()<0.35) it.crit=2+Math.floor(mult*2); it.name=`æ­¦å™¨ +${it.atk}`} else if(k==='armor'){it.hp=4*Math.max(1,Math.floor(bp*0.9)); if(rarName!=='Common'&&Math.random()<0.3) it.def=Math.floor(mult*1.2); it.name=`é§ +${it.hp}HP`} else{const r=Math.random(); if(r<0.45){it.crit=3+Math.floor(mult*2); it.name=`æŒ‡è¼ª ã‚¯ãƒª+${it.crit}%`} else if(r<0.9){it.atk=Math.max(1,Math.floor(bp*0.6)); it.name=`æŒ‡è¼ª ATK+${it.atk}`} else{it.goldB=5+Math.floor(mult*4); it.name=`æŒ‡è¼ª Gold+${it.goldB}%`}} it.name+=` (${rarName})`; return it; }
function renderItemText(it){ const p=[]; if(it.atk)p.push(`ATK+${it.atk}`); if(it.hp)p.push(`HP+${it.hp}`); if(it.def)p.push(`é˜²å¾¡+${it.def}`); if(it.crit)p.push(`ã‚¯ãƒª+${it.crit}%`); if(it.goldB)p.push(`Gold+${it.goldB}%`); return `${it.name} [${p.join(', ')}]` }
function scoreItem(it){ if(!it) return -1e9; let s=0; s+=(it.atk??0)*3+(it.hp??0)*0.4+(it.def??0)*2+(it.crit??0)*1.5+(it.goldB??0)*0.8; s+=(it.lvl??0)*0.2; const rar=RARITIES.find(r=>r.name===it.rarity); s*=rar?.mult??1; return s }
function tryAutoEquip(it){ const s=it.slot,cur=state.eq[s]; if(scoreItem(it)>scoreItem(cur)){ state.eq[s]=it; toast(`è£…å‚™ï¼š${renderItemText(it)}`) } }

// ===== Flavor system (unchanged core)
const TOWNS=['ã‚¢ã‚ºãƒ','ãƒ™ãƒ¬ã‚¯','ã‚³ãƒãƒ','ãƒ‰ãƒ¼ãƒ©ãƒ³','ã‚¨ãƒˆãƒŠ','ãƒ•ã‚§ãƒ³ãƒ†','ã‚¬ãƒ¬ã‚ª','ãƒ’ãƒ¼ã‚¹','ã‚¤ã‚¹ãƒˆ','ã‚¸ãƒ¥ãƒ©','ã‚«ã‚¶ãƒ³','ãƒ«ãƒŸãƒŠ','ã‚µãƒ•ã‚£ãƒ¼ãƒ«','ãƒ¢ãƒ©ãƒ³','ãƒ­ãƒƒã‚·ãƒ¥','ã‚¿ãƒªãƒ '];
const COUNTRIES=['ã‚¦ã‚§ã‚¹ã‚¿ãƒªã‚¢','ã‚½ãƒ©ãƒªã‚¹','ã‚¢ãƒ¡ã‚·ã‚¢','ãƒãƒ¼ã‚¹ãƒ™ãƒ«ã‚¯','ã‚ªãƒªã‚¨ãƒ³ãƒ†','ãƒ´ã‚¡ãƒ«ãƒ‡ã‚£ã‚¢','ã‚¢ãƒ«ã‚«ãƒ‹ã‚¢','ãƒãƒãƒ«ãƒ¼ãƒ³','ãƒŸãƒ©ãƒ‡ã‚£ãƒŠ','ã‚«ã‚¹ãƒˆãƒ¼ãƒ«'];
const THEME_FLAVORS={
  plains:[ 'è‰åŸã«æœã‚‚ã‚„ãŒç«‹ã¡ã“ã‚ã‚‹ã€‚æ—…äººãŸã¡ã¯å°å£°ã§å™‚ã—ã¦ã„ã‚‹ã€‚','ç©ã‚„ã‹ãªé¢¨ã€‚ã ãŒç£é“ã®è¶³è·¡ã¯ã©ã“ã‹è½ã¡ç€ã‹ãªã„ã€‚','é ãã§ç¾Šé£¼ã„ã®ç¬›ã€‚ç¾¤ã‚ŒãŒã–ã‚ã¤ã„ã¦ã„ã‚‹ã€‚','èŠ±ã®é¦™ã‚Šã«ç´›ã‚Œã¦ã€é‰„ã®åŒ‚ã„ãŒå¾®ã‹ã«ã™ã‚‹ã€‚','è‰ã®ç©‚å…ˆãŒæºã‚Œã¦ã„ã‚‹ã€‚ä½•ã‹ãŒæ½œã‚“ã§ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚','å°å·ã®ã›ã›ã‚‰ããŒæ€¥ã«æ­¢ã‚“ã ã€‚é™ã‘ã•ãŒè€³ã«ç—›ã„ã€‚'],
  forest:[ 'æ£®ã€è¿‘é ƒã§ã¯å‹•ç‰©ãŒã‚ã£ãã‚Šæ¸›ã£ãŸã‚ˆã†ã ã€‚åŸå› ã‚’æ¢ã‚ã†ã€‚','æœ¨ã€…ãŒã–ã‚ã‚ãã€‚æã®ä¸Šã‹ã‚‰ç›£è¦–ã•ã‚Œã¦ã„ã‚‹æ°—é…ã€‚','è‹”ã‚€ã—ãŸå€’æœ¨ã«æ–°ã—ã„çˆªç—•ã€‚å¥¥ã¸ç¶šã„ã¦ã„ã‚‹ã€‚','é³¥ã®é³´ãå£°ãŒä¸€æ–‰ã«æ­¢ã‚“ã ã€‚ä½•ã‹ãŒæ¥ã‚‹ã€‚','å¤ã„ç¥­å£‡ã«æ§ã’ç‰©ã®è·¡ã€‚æ£®ã¯ä½•ã‚’æ±‚ã‚ã¦ã„ã‚‹ï¼Ÿ'],
  desert:[ 'ç ‚ã®é¢¨ãŒç†±ã„ã€‚å¤ã„éºè·¡ãŒé¡”ã‚’å‡ºã—ãŸã€‚','èœƒæ°—æ¥¼ã®å‘ã“ã†ã§æ——ãŒæºã‚Œã‚‹ã€‚èª°ã‹ãŒã‚­ãƒ£ãƒ³ãƒ—ã—ã¦ã„ã‚‹ã€‚','ç ‚ã®ä¸‹ã‚’ä½•ã‹ãŒèµ°ã£ãŸã€‚å½±ãŒå††ã‚’æãã€‚','ä¹¾ã„ãŸé˜ã®éŸ³ã€‚ç”ºã¯è¿‘ã„ã®ã«ã€äººå½±ãŒè–„ã„ã€‚'],
  undead:[ 'å¢“æ¨™ã®å½±ãŒä¼¸ã³ã‚‹ã€‚åã‚’å‘¼ã¶å£°ã¯é¢¨ã‹ã€ãã‚Œã¨ã‚‚ã€‚','ç¯ã‚Šã®æ¶ˆãˆãŸç¤¼æ‹å ‚ã€‚ç°ãŒèˆã„ä¸ŠãŒã‚‹ã€‚','ç¬‘ã„å£°ãŒã—ãŸã€‚ã ãŒèª°ã‚‚ã„ãªã„ã€‚','å¤ã„é§ã«æ–°ã—ã„è¡€ã€‚ã“ã“ã§ä½•ãŒèµ·ããŸï¼Ÿ'],
  cave:[ 'æ´çªŸã®æ¯ã¯æ¹¿ã£ã¦å†·ãŸã„ã€‚æ»´ã‚‹éŸ³ãŒå¦™ã«è¿‘ã„ã€‚','å£ã«åˆ»ã¾ã‚ŒãŸè¨˜å·ã€‚èª°ã‹ã®å¸°é‚„ã‚’å¾…ã¤å°ã‹ã€‚','é»’ã„å·ãŒæµã‚Œã¦ã„ã‚‹ã€‚åº•ãŒè¦‹ãˆãªã„ã€‚','å¥¥ã‹ã‚‰åœŸç ‚ã®å´©ã‚Œã‚‹éŸ³ã€‚é“ãŒå¤‰ã‚ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€‚'],
  arcane:[ 'ç§˜è¡“ã®å…‰ãŒæºã‚‰ã‚ãã€‚ç©ºæ°—ãŒå°‘ã—ç”˜ã„ã€‚','å¤æ›¸ã®ãƒšãƒ¼ã‚¸ãŒå‹æ‰‹ã«æ²ã‚ŒãŸã€‚èª°ã‹ãŒèª­ã‚“ã§ã„ã‚‹ã€‚','åºŠã«æã‹ã‚ŒãŸé™£ãŒæ–°ã—ã„ã€‚ã“ã“ã¯ã¾ã ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚','å¡”ã®ä¸Šã§é˜ãŒé³´ã£ãŸã€‚åˆå›³ã¯èª°ã¸ï¼Ÿ']
};
function countryName(){ return choice(COUNTRIES) }
function stageNameForTheme(theme){ const town=choice(TOWNS); const suf={plains:'è‰åŸ',forest:'ã®æ£®',desert:'ç ‚æ¼ ',undead:'å¢“åœ°',cave:'æ´çªŸ',arcane:'ç§˜è¡“å¡”'}[theme]||''; return town + suf }
function pickFlavor(theme){ const uname=(state.username||'æ—…äºº'); const stage=stageNameForTheme(theme); const themed=THEME_FLAVORS[theme]||[]; const generics=[ `${stage} ã®é­”ç‰©ãŒæ¸›ã£ã¦ã„ã‚‹ã‚‰ã—ã„ã€‚`, `${stage} ã§ã¯è¡Œå•†äººãŒé“ã‚’æ€¥ã„ã§ã„ã‚‹ã€‚`, `${stage} ã«å¦™ãªè¶³è·¡ã€‚è¿½ã†ã¹ãã‹ï¼Ÿ`, `${countryName()} ã§ã¯ ${uname} ãŒå™‚ã«ãªã£ã¦ã‚‹ã‚ˆã†ã ã€‚`, `${countryName()} ã®åœ°å›³ã«æ–°ã—ã„å°ã€‚èª°ãŒã¤ã‘ãŸï¼Ÿ`, `${stage} ã§ç¯ã‚ŠãŒã²ã¨ã¤ã€ã¾ãŸã²ã¨ã¤æ¶ˆãˆãŸã€‚` ]; const bag=[...themed, ...generics, ...generics]; return choice(bag) }
function bossFlavor(theme){ const stage=stageNameForTheme(theme); const enders={ plains:[`ã“ã‚Œã§ ${stage} ã¯å¤§ä¸ˆå¤«ã ã‚ã†ã€‚`, `${stage} ã«é™ã‘ã•ãŒæˆ»ã‚‹ã€‚`], forest:[`ã“ã‚Œã§æ£®ã¯å¤§ä¸ˆå¤«ã ã‚ã†ã€‚`, `${stage} ã®æ¨¹ã€…ãŒæ·±ãæ¯ã‚’ã¤ã„ãŸã€‚`], desert:[`åµã¯å»ã£ãŸã€‚${stage} ã«å½±ãŒæˆ»ã‚‹ã€‚`], undead:[`${stage} ã®ç¯ãŒã²ã¨ã¤ç¯ã£ãŸã€‚`], cave:[`${stage} ã®è½ŸããŒé ã®ã„ãŸã€‚`], arcane:[`${stage} ã®å‘ªã¯è§£ã‘ãŸã€‚`]}; return choice(enders[theme]||[`ã“ã‚Œã§ ${stage} ã¯å¤§ä¸ˆå¤«ã ã‚ã†ã€‚`]) }
let _flavorNextAt=0; function updateFlavor(reason='timer'){ const bi=currentBlockIdx(); const theme=ensureThemeForBlock(bi); const msg=(reason==='boss30')?bossFlavor(theme):pickFlavor(theme); ui.flavorText.textContent=msg; _flavorNextAt=Date.now()+20000 }

// ===== GM reactions when multi-kill (overflow)
function gmReact(kills){ const uname=(state.username||'å›'); if(kills<=1) return ''; if(kills<=3) return choice([`ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œã„ã„ã­ï¼ä¸€æ°—ã«${kills}ä½“ã€æ°—æŒã¡ã„ã„ã ã‚ï¼Ÿã€`,`ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œè»½ãæµã—ã¦${kills}ä½“ã€ä¸Šã€…ã ã€‚ã€`]); if(kills<=6) return choice([`ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œè¦‹äº‹ï¼${kills}ä½“ã‚’ä¸€ç¬ã§è–™ã„ã ï¼ã€`,`ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œã‚„ã‚‹ã˜ã‚ƒãªã„ã‹ã€${uname}ã€‚${kills}ä½“ã ã€‚ã€`]); if(kills<=10) return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œãƒ•ãƒ•â€¦${kills}ä½“ã‹ã€‚é¢ç™½ããªã£ã¦ããŸã€‚ã€`; if(kills<=15) return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œãªã‚“ã ãã®é€Ÿåº¦ã¯ï¼${kills}ä½“â€¦ï¼ã€`; if(kills<=25) return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œçš†ã®è¦–ç·šãŒãŠå‰ã«é›†ã¾ã£ã¦ã„ã‚‹ã€‚${kills}ä½“ã ã¨â€¦ã€‚ã€`; if(kills<=40) return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œå–é‡‡ãŒæ­¢ã¾ã‚‰ãªã„ï¼${kills}ä½“æ’ƒç ´ï¼ã€`; if(kills<=70) return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œã‚‚ã£ã¨è¡Œã‘ã€${uname}ï¼ä»Šã®ã§${kills}ä½“ï¼ã€`; if(kills<=120) return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€ŒèƒŒç­‹ãŒå‡ã£ãŸâ€¦${kills}ä½“ã‚’ä¸€æ¯ã§â€¦ã€‚ã€`; return `ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã€Œå¼•ãã‚â€¦${kills}ä½“ã£ã¦ã€å¸¸è­˜å£Šã—ã¦ã‚‹ã€‚ã€`; }

// ===== WebAudio (SE)
let audioCtx=null; let _audioReady=false; const AudioStore={enabled:true, volume:0.8};
function loadAudioSettings(){ try{ const raw=localStorage.getItem(AUDIO_KEY); if(raw){ const o=JSON.parse(raw); AudioStore.enabled=!!o.enabled; AudioStore.volume=typeof o.volume==='number'?o.volume:0.8; } }catch(e){} }
function saveAudioSettings(){ try{ localStorage.setItem(AUDIO_KEY, JSON.stringify({enabled:AudioStore.enabled, volume:AudioStore.volume})); }catch(e){} }
function audioEnsure(){ if(!audioCtx){ const C=window.AudioContext||window.webkitAudioContext; if(!C) return false; audioCtx=new C(); } return true }
function audioResume(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }
function seInitOnUserGesture(){ if(_audioReady) return; if(!audioEnsure()) return; audioResume(); _audioReady=true; }
function now(){ return audioCtx?audioCtx.currentTime:0 }
function tone(freq=440, dur=0.1, type='sine', gain=0.2, attack=0.005, release=0.03, pan=0){ if(!audioCtx||!AudioStore.enabled) return; const t0=now(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); let p; if(audioCtx.createStereoPanner){ p=audioCtx.createStereoPanner(); p.pan.value=pan; o.connect(g).connect(p).connect(audioCtx.destination); } else { o.connect(g).connect(audioCtx.destination); }
  o.type=type; o.frequency.setValueAtTime(freq, t0);
  const v=Math.max(0,Math.min(1, AudioStore.volume))*gain; g.gain.setValueAtTime(0, t0); g.gain.linearRampToValueAtTime(v, t0+attack); g.gain.linearRampToValueAtTime(0, t0+attack+Math.max(0,dur-release)); o.start(t0); o.stop(t0+attack+dur); }
function blipUp(){ tone(420,0.06,'square',0.25); tone(600,0.06,'square',0.22,0.003,0.03,0.1); }
function sparkle(){ tone(800,0.05,'triangle',0.18); setTimeout(()=>tone(1200,0.06,'triangle',0.16),40); setTimeout(()=>tone(1600,0.07,'triangle',0.14),90); }
function levelUp(){ tone(500,0.08,'sine',0.18); setTimeout(()=>tone(700,0.08,'sine',0.18),90); setTimeout(()=>tone(900,0.12,'sine',0.18),180); }
function errorBeep(){ tone(200,0.12,'sawtooth',0.22); }
function deathLow(){ tone(140,0.18,'square',0.25); setTimeout(()=>tone(90,0.22,'square',0.20),120); }
function reviveRise(){ tone(300,0.08,'sine',0.15); setTimeout(()=>tone(520,0.08,'sine',0.15),90); setTimeout(()=>tone(760,0.10,'sine',0.15),180); }
function bossTick(){ tone(900,0.04,'square',0.18); }
function archOn(){ tone(300,0.08,'sawtooth',0.22); setTimeout(()=>tone(180,0.10,'sawtooth',0.24),70); }
function archBreak(){ tone(760,0.06,'square',0.22); setTimeout(()=>tone(980,0.06,'square',0.20),50); setTimeout(()=>tone(1220,0.08,'square',0.18),100); }
function archSpawn(){ tone(340,0.12,'square',0.24); setTimeout(()=>tone(520,0.10,'square',0.22),110); setTimeout(()=>tone(260,0.12,'square',0.24),220); }
function archKill(){ tone(480,0.10,'triangle',0.22); setTimeout(()=>tone(700,0.12,'triangle',0.20),100); setTimeout(()=>tone(980,0.16,'triangle',0.18),220); }
const Sound={
  play(name){ if(!_audioReady||!audioCtx||!AudioStore.enabled) return; switch(name){
    case 'ui': blipUp(); break;
    case 'hit': tone(320,0.035,'square',0.22); break;
    case 'crit': tone(520,0.06,'triangle',0.22); setTimeout(()=>tone(740,0.05,'triangle',0.18),40); break;
    case 'kill': blipUp(); break;
    case 'level': levelUp(); break;
    case 'buy': blipUp(); break;
    case 'drop': sparkle(); break;
    case 'error': errorBeep(); break;
    case 'death': deathLow(); break;
    case 'revive': reviveRise(); break;
    case 'multi': for(let i=0;i<4;i++) setTimeout(()=>tone(420+i*60,0.03,'square',0.18), i*35); break;
    case 'bossTick': bossTick(); break;
    case 'archOn': archOn(); break;
    case 'archBreak': archBreak(); break;
    case 'archSpawn': archSpawn(); break;
    case 'archKill': archKill(); break;
  } },
  setEnabled(v){ AudioStore.enabled=!!v; saveAudioSettings(); },
  setVolume(v){ AudioStore.volume=Math.max(0,Math.min(1, v)); saveAudioSettings(); }
};

// Early load settings
loadAudioSettings();

// ===== Spawn / combat / rewards (with Archboss)
function spawnMonster(){ const f=state.floor; const isArch=(f%30===0); const isBoss10=(!isArch && f%10===0); const bi=currentBlockIdx(); const theme=ensureThemeForBlock(bi); applyThemeSkin(theme); ui.themeBadge.textContent=themeLabel(theme);
  let base=null,type='normal'; if(isArch){ base=choice(poolByTheme(ARCHBOSS_POOL,theme)); type='archboss'; } else if(isBoss10){ base=choice(poolByTheme(BOSS_POOL,theme)); type='boss'; } else { const r=Math.random(); if(r<0.012){ base=SPECIAL_POOL[1]; type='supermimic'; } else if(r<0.042){ base=SPECIAL_POOL[0]; type='mimic'; } else { base=choice(poolByTheme(MONSTER_POOL,theme)); } }
  const hp0=eHP(f,isBoss10||isArch), gold0=eGold(f,isBoss10||isArch), atk0=eATK(f,isBoss10||isArch);
  let hp=hp0, gold=gold0, atk=atk0, limit=0; if(type==='archboss'){ hp=Math.floor(hp0*3.0); gold=Math.floor(gold0*2.2); atk=Math.floor(atk0*1.6); limit=60000; } else if(type==='boss'){ hp=Math.floor(hp0*1.2); gold=Math.floor(gold0*1.1); atk=Math.floor(atk0*1.1); limit=30000; }
  state.monster={name:`Lv${f} ${base.name}`,emoji:base.emoji,hp,maxHP:hp,gold,atk,isBoss:(type==='boss'||type==='archboss'),type,
    barrierActive:false, barrierHits:0, barrierNeed: Math.max(6, Math.floor(4+f/6)), barrierNextAt:0, barrierEndsAt:0};
  state.engaged=false; state.isDown=false; state.reviveAt=0; state.bossEndsAt=0; ui.monsterFace.textContent=base.emoji; ui.monsterName.textContent=state.monster.name; ui.monsterHPText.textContent=`${hp} / ${hp}`; ui.monsterHP.style.width='100%'; ui.floorBadge.innerHTML=`éšå±¤ ${state.floor} <span class="theme-badge" id="themeBadge">${themeLabel(theme)}</span>`; ui.themeBadge=document.getElementById('themeBadge'); refreshFloorButtons(); updateAttackBtn(); ui.archBadge.hidden=true; if(type==='archboss'){ Sound.play('archSpawn'); }
}

function awardKill(){ const m=state.monster; // pebbles small chance
  if(Math.random()<0.05){ const k=Math.floor(state.floor/10); if(k>0){ state.pebbles+=k; toast(`+${k}`); }} const goldMult=(m.type==='mimic')?10:(m.type==='supermimic')?100:1; const expBase=Math.max(1,Math.floor(3+state.floor*0.6)); const expGain=expBase*goldMult; const goldGain=Math.floor(m.gold*goldMult*(1+goldB()/100)); state.gold+=goldGain; state.kills+=1; state.exp+=expGain; while(state.exp>=state.expToNext){ state.exp-=state.expToNext; state.level+=1; state.expToNext=Math.floor(state.expToNext*1.25+8); state.baseATK+=1; state.baseHP+=2; state.playerHP=recalcMaxHP(); toast('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ATK+1 / HP+2'); Sound.play('level'); }
  if(m.type==='mimic'||m.type==='supermimic'){ const minR=(m.type==='mimic')?'Rare':'Epic'; const it=makeItem(state.floor,minR); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); toast(`ç‰¹åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ï¼š${renderItemText(it)}`); Sound.play('drop'); }
  else if(m.type==='archboss'){
    // Guaranteed high rarity drop and gem bonus
    const lr = Math.random()<0.25?'Legendary':'Epic'; const it=makeItem(state.floor, lr); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); const gemGain=Math.max(1,Math.floor(state.floor/30)); state.magicStones+=gemGain; toast(`ç‰¹åˆ¥ãƒœã‚¹æ’ƒç ´ï¼ ${renderItemText(it)} / é­”çŸ³ +${gemGain}`); Sound.play('archKill');
  } else {
    const luck=(state.eq.ring?.goldB??0)*0.2; const drop=0.20+luck/100; if(Math.random()<drop){ const it=makeItem(state.floor); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); toast(`ãƒ‰ãƒ­ãƒƒãƒ—ï¼š${renderItemText(it)}`); Sound.play('drop'); } else { toast(`+${goldGain}G / +${expGain}EXP`); }
  }
  if(state.floor>state.maxFloor)state.maxFloor=state.floor; if(state.maxFloor>state.bestMaxFloor)state.bestMaxFloor=state.maxFloor; }

function updateAttackBtn(){ const m=state.monster; if(!m) return; const expected=playerATK(); if(!state.engaged){ ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æˆ¦é—˜é–‹å§‹ï¼'; return } ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰'; }
function refreshFloorButtons(){ const canUpByBest=state.floor<state.bestMaxFloor; const dead=state.monster&&state.monster.hp<=0; ui.nextBtn.disabled=!(dead||canUpByBest); const bi=currentBlockIdx(); const t=state.themes[bi]?themeLabel(state.themes[bi]):'â€”'; ui.floorHint.textContent=`æœ€é«˜åˆ°é”ï¼š${state.bestMaxFloor} éš / ãƒ†ãƒ¼ãƒï¼š${t}`; }
function beginEngage(){ if(!state.engaged){ state.engaged=true; if(state.monster.isBoss&&state.bossEndsAt===0){ const isArch=state.monster.type==='archboss'; state.bossEndsAt=Date.now()+(isArch?60000:30000); if(isArch){ // schedule first barrier after short delay
        state.monster.barrierNextAt=Date.now()+6000; state.monster.barrierEndsAt=0; }
    } } }

function doSingleKillAndAdvance(){ const wasFloor=state.floor; const wasBoss=!!state.monster?.isBoss; const wasArch=state.monster?.type==='archboss'; awardKill(); if(state.stay){ spawnMonster(); } else { state.floor+=1; spawnMonster(); } if(wasBoss && wasFloor%30===0){ updateFlavor('boss30'); } if(wasArch){ ui.archBadge.hidden=true; } }

function attack(){ if(!state.monster) return; if(state.playerHP<=0){ toast('â€¦'); return; } beginEngage(); const m=state.monster; if(m.hp<=0) return; // Relic: Kashiwa multi-kill
  if(state.relicActive.kashiwa){ const atk=playerATK(); if(atk>m.hp && !(m.type==='archboss')){ let remaining=atk, kills=0, safety=0; while(remaining>=state.monster.hp && safety<300){ remaining-=state.monster.hp; doSingleKillAndAdvance(); kills++; safety++; if(state.floor>1e7) break; } if(kills>=2){ toast(`æ•µã‚’${kills}ä½“å€’ã—ãŸï¼`); const gm=gmReact(kills); if(gm) toast(gm); } updateAttackBtn(); refreshFloorButtons(); return; } }
  const {dmg,isCrit}=clickDamage(); let dealt=Math.min(m.hp,dmg);
  // Archboss barrier effect
  if(m.type==='archboss' && m.barrierActive){ m.barrierHits++; const need=m.barrierNeed; ui.archBadge.textContent=`éšœå£ ${Math.min(m.barrierHits,need)}/${need}`; dealt=Math.ceil(dealt*0.2); if(m.barrierHits>=need){ m.barrierActive=false; m.barrierHits=0; m.barrierNextAt=Date.now()+8000; m.barrierEndsAt=0; ui.archBadge.hidden=true; toast('éšœå£ãŒå‰²ã‚ŒãŸï¼'); Sound.play('archBreak'); }
  }
  m.hp-=dealt; ui.monsterHP.style.width=`${(m.hp/m.maxHP)*100}%`; ui.monsterHPText.textContent=`${m.hp} / ${m.maxHP}`; if(isCrit){ pushLog(`<span class="log-num-orange">${dealt}</span>ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚ãŸãˆãŸï¼ <span class="log-crit-red">ã€Œã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ã€</span>`); Sound.play('crit'); } else { pushLog(`<span class="log-num-yellow">${dealt}</span>ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚ãŸãˆãŸï¼`); Sound.play('hit'); }
  if(m.hp<=0){ doSingleKillAndAdvance(); }
  updateAttackBtn(); refreshFloorButtons(); }

function enemyTick(dt){ if(!state.monster||!state.engaged||state.isDown)return; const m=state.monster; if(m.hp<=0)return; const dps=Math.max(0,m.atk-playerDEF()*0.6); const dmg=dps*dt; if(dmg<=0)return; state.playerHP-=dmg; if(state.playerHP<=0&&!state.isDown){ state.playerHP=0; state.isDown=true; state.deaths+=1; state.reviveAt=Date.now()+5000; toast(`æ°—çµ¶ã—ã¾ã—ãŸâ€¦${5}ç§’å¾Œã«å¾©æ´»`); Sound.play('death'); } }
function regenTick(dt){ if(state.playerHP>0){ const mx=recalcMaxHP(); state.playerHP=clamp(state.playerHP+dt*(0.8+state.level*0.02),0,mx); } }
function autoTapTick(dt){ if(state.autoTap<=0||!state.engaged||state.isDown) return; autoTapTick._acc=(autoTapTick._acc||0)+state.autoTap*dt; while(autoTapTick._acc>=1){ autoTapTick._acc-=1; attack(); } }
function timersTick(){ let txt=[]; if(state.reviveAt>0){ const left=Math.max(0,state.reviveAt-Date.now()); txt.push(`${Math.ceil(left/1000)}s`); if(left<=0){ state.reviveAt=0; state.playerHP=recalcMaxHP(); state.isDown=false; state.engaged=false; toast('å¾©æ´»ï¼'); Sound.play('revive'); updateAttackBtn(); } }
  if(state.bossEndsAt>0){ const left=Math.max(0,state.bossEndsAt-Date.now()); const sec=Math.ceil(left/1000); txt.push(`${sec}s`); const isArch=state.monster?.type==='archboss'; if((isArch && sec<=10) || (!isArch && sec<=5)){ Sound.play('bossTick'); }
    if(left<=0){ state.bossEndsAt=0; toast('â€¦'); state.floor=Math.max(1,state.floor-1); spawnMonster(); } }
  // Archboss barrier scheduling
  if(state.engaged && state.monster?.type==='archboss' && state.playerHP>0){ const m=state.monster; const nowT=Date.now(); if(!m.barrierActive && m.barrierNextAt>0 && nowT>=m.barrierNextAt){ m.barrierActive=true; m.barrierHits=0; m.barrierEndsAt=nowT+6000; ui.archBadge.hidden=false; ui.archBadge.textContent=`éšœå£ 0/${m.barrierNeed}`; toast('ãƒœã‚¹ãŒéšœå£ã‚’å±•é–‹ï¼ã‚¿ãƒƒãƒ—ã§å‰²ã‚Œï¼'); Sound.play('archOn'); }
    if(m.barrierActive && nowT>=m.barrierEndsAt){ // timeout ends barrier, reschedule sooner
      m.barrierActive=false; m.barrierHits=0; m.barrierNextAt=nowT+6000; m.barrierEndsAt=0; ui.archBadge.hidden=true; }
  }
  ui.timerAll.textContent=txt.join(' / ');
  if(Date.now()>=_flavorNextAt){ updateFlavor('timer'); }
}

// ===== Save/Load/Export/Import
function defaultDownloadName(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); const ts=`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}`; const uname=(state.username||'User'); return `save-${uname}-${ts}` }
function save(manual=false){ try{ const data=JSON.stringify({state:{...state,bossEndsAt:state.bossEndsAt>0?Date.now()+Math.max(0,state.bossEndsAt-Date.now()):0,reviveAt:state.reviveAt>0?Date.now()+Math.max(0,state.reviveAt-Date.now()):0},prices}); localStorage.setItem(SAVE_KEY,data); if(manual) toast('ä¿å­˜ã—ã¾ã—ãŸ'); }catch(e){ console.warn(e); }}
function load(manual=false){ try{ const raw=localStorage.getItem(SAVE_KEY); if(!raw){ if(manual) toast('ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚»ãƒ¼ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return false } const o=JSON.parse(raw); Object.assign(state,o.state||{}); Object.assign(prices,o.prices||{}); state.upg=state.upg||{atk:0,hp:0,auto:0}; state.unlocks=state.unlocks||{kashiwa:false, strongsword:false}; if(state.unlocks.strongsword===undefined) state.unlocks.strongsword=false; state.relicActive=state.relicActive||{kashiwa:false, strongsword:false}; if(state.relicActive.strongsword===undefined) state.relicActive.strongsword=false; state.soulUp=state.soulUp||{atk:0,hp:0,gold:0}; if(state.soulsSpent===undefined) state.soulsSpent=0; state.themes=state.themes||{}; state.username=state.username||''; state.lastSeenVersion=state.lastSeenVersion||GAME_VERSION; state.playerHP=clamp(state.playerHP,0,recalcMaxHP()); ui.autoEquip&&(ui.autoEquip.checked=!!state.autoEquip); ui.stayCb&&(ui.stayCb.checked=!!state.stay); renderInventory(); updateUI(); if(manual) toast('èª­è¾¼ã—ã¾ã—ãŸ'); return true }catch(e){ console.warn(e); if(manual) toast('èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); return false } }
function importSaveFromText(raw){ try{ JSON.parse(raw); localStorage.setItem(SAVE_KEY, raw); return load(false); }catch(e){ toast('JSONã‚¨ãƒ©ãƒ¼'); return false } }

// ===== Inventory rendering
function rarityCls(r){return `rarity-${(r||'Common')}`} function colored(name,rarity){return `<span class="${rarityCls(rarity)} rarity-Label">${name}</span>`}
function renderEquipped(){ const w=state.eq.weapon,a=state.eq.armor,r=state.eq.ring; ui.eqWeapon.innerHTML=w?colored(w.name,w.rarity):'ãªã—'; ui.eqArmor.innerHTML=a?colored(a.name,a.rarity):'ãªã—'; ui.eqRing.innerHTML=r?colored(r.name,r.rarity):'ãªã—'; }
function renderInventory(){ const box=ui.invList; if(!box) return; box.innerHTML=''; const ft=state.invFilter||'all'; const filtered=state.inv.filter(it=>ft==='all'?true:it.slot===ft); if(ui.invFilterInfo){ const total=state.inv.length,cnt=filtered.length; const labelMap={all:'ã™ã¹ã¦',weapon:'æ­¦å™¨',armor:'é§',ring:'æŒ‡è¼ª'}; ui.invFilterInfo.textContent=`${labelMap[ft]}ï¼š${cnt} ä»¶ / å…¨ ${total} ä»¶`; }
  const tools=document.createElement('div'); tools.className='row'; tools.innerHTML=`<div class="small">ä¸€æ‹¬å£²å´ï¼š</div><div class="wrap" style="gap:.4rem"><button class="btn mini bulk-sell" data-r="Common">ã‚³ãƒ¢ãƒ³</button><button class="btn mini bulk-sell" data-r="Uncommon">ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³</button><button class="btn mini bulk-sell" data-r="Rare">ãƒ¬ã‚¢</button><button class="btn mini bulk-sell" data-r="Epic">ã‚¨ãƒ”ãƒƒã‚¯</button><button class="btn mini bulk-sell" data-r="Legendary">ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰</button></div>`; box.appendChild(tools); tools.querySelectorAll('.bulk-sell').forEach(btn=>{ btn.addEventListener('click',()=>{ const rar=btn.getAttribute('data-r'); const sellable=state.inv.filter(it=>it.rarity===rar); if(sellable.length===0){ toast(`${rar} ã¯æ‰€æŒãªã—`); Sound.play('error'); return } const total=sellable.reduce((s,it)=>s+Math.floor(it.value),0); if(!confirm(`${rar} ã‚’ ${sellable.length}ä»¶ã€åˆè¨ˆ ${total}G ã§å£²å´ã—ã¾ã™ã‹ï¼Ÿ`)) return; state.inv=state.inv.filter(it=>it.rarity!==rar); state.gold+=total; renderInventory(); updateUI(); toast(`+${total}Gï¼ˆ${rar} x${sellable.length}ï¼‰`); Sound.play('buy'); }); });
  for(const it of filtered){ const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div><b class="${rarityCls(it.rarity)}">${it.name}</b></div><div class="small">${renderItemText(it)}</div>`; const row=document.createElement('div'); row.className='row'; const e=document.createElement('button'); e.className='btn'; e.textContent='è£…å‚™'; e.onclick=()=>{ state.eq[it.slot]=it; toast(`è£…å‚™ï¼š${renderItemText(it)}`); Sound.play('buy'); updateUI(); }; const s=document.createElement('button'); s.className='btn gold'; s.textContent=`å£²å´ (+${Math.floor(it.value)}G)`; s.onclick=()=>{ state.gold+=Math.floor(it.value); state.inv=state.inv.filter(x=>x!==it); renderInventory(); updateUI(); Sound.play('buy'); }; row.appendChild(e); row.appendChild(s); div.appendChild(row); box.appendChild(div); }
}

// ===== Footer nav & subtabs
const fTabs=$$('#mainFooter .ftab');
function switchMainTab(tabId){ [ui.tabUpg,ui.tabInv,ui.tabSta,ui.tabAdv,ui.tabSettings].forEach(el=>el.setAttribute('hidden','')); document.getElementById(tabId).removeAttribute('hidden'); fTabs.forEach(btn=>btn.classList.toggle('active', btn.getAttribute('data-tab')===tabId)); Sound.play('ui'); }
fTabs.forEach(btn=>btn.addEventListener('click',()=>switchMainTab(btn.getAttribute('data-tab'))));
ui.advTabs.forEach(btn=>{ btn.addEventListener('click',()=>{ ui.advTabs.forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const id=btn.getAttribute('data-advtab'); ui.advAsc.setAttribute('hidden',''); ui.advRelic.setAttribute('hidden',''); document.getElementById(id).removeAttribute('hidden'); Sound.play('ui'); }); });

// ===== Buttons
let _holding=false,_t=0,_saw=false; function onPD(e){ e.preventDefault(); _saw=true; _t=Date.now(); if(_holding) return; _holding=true; attack(); } function onPU(){ _holding=false }
function bindInput(el){ if(!el) return; if(window.PointerEvent){ el.addEventListener('pointerdown',onPD,{passive:false}); el.addEventListener('pointerup',onPU); el.addEventListener('pointercancel',onPU); el.addEventListener('pointerleave',onPU); } else { el.addEventListener('click',()=>{ if(_saw && Date.now()-_t<200) return; attack(); }); } }
bindInput($('#attackBtn')); bindInput($('#monster'));
document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});
ui.nextBtn.addEventListener('click',()=>{ const canUpByBest=state.floor<state.bestMaxFloor; const dead=state.monster && state.monster.hp<=0; if(!(dead||canUpByBest)){ toast('ã¾ã é€²ã‚ãªã„â€¦'); Sound.play('error'); return } state.floor+=1; state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI(); Sound.play('ui'); });
ui.fleeBtn.addEventListener('click',()=>{ state.floor=Math.max(1,state.floor-1); state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI(); Sound.play('ui'); });
ui.stayCb.addEventListener('change',e=>{ state.stay=e.target.checked; save(false); Sound.play('ui'); });
ui.jumpBtn&&ui.jumpBtn.addEventListener('click',()=>{ const v=parseInt(ui.jumpInput.value||''); if(!v||v<1){ toast('éšå±¤ã‚’å…¥åŠ›'); Sound.play('error'); return } const maxAvail=Math.max(1, state.bestMaxFloor); const to=clamp(v,1,maxAvail); state.floor=to; state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI(); Sound.play('ui'); });

// ===== Ascend & Souls
function ascend(){ const g=Math.floor(state.maxFloor/30); if(g<=0){ toast('â€¦'); Sound.play('error'); return } if(!confirm('è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ'))return; state.souls+=g; state.magicStones+=state.pebbles; state.pebbles=0; const keepBest=Math.max(state.bestMaxFloor,state.maxFloor); const keepSouls=state.souls; const keepSoulUp={...state.soulUp}; const keepSoulsSpent=state.soulsSpent; Object.assign(state,{ gold:0,level:1,exp:0,expToNext:20,floor:1,maxFloor:1,kills:0,deaths:0, baseATK:1,baseHP:10,baseDEF:0,baseCRIT:5, autoTap:0, eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:state.autoEquip, monster:null, playerHP:10,bossEndsAt:0, souls:keepSouls, soulsSpent:keepSoulsSpent, soulUp:keepSoulUp, bestMaxFloor:keepBest, isDown:false, engaged:false, reviveAt:0, stay:state.stay, pebbles:0, magicStones:state.magicStones, upg:state.upg, unlocks:state.unlocks, relicActive:state.relicActive, themes:state.themes, username:state.username, lastSeenVersion:GAME_VERSION }); prices.atk=10; prices.hp=10; prices.auto=25; spawnMonster(); updateUI(); renderInventory(); toast('OK'); Sound.play('level'); }
ui.ascendBtn&&ui.ascendBtn.addEventListener('click',ascend);
function nextSoulCost(level){ return 1 + level }
function tryBuySoul(key){ const lv=state.soulUp[key]||0; const cost=nextSoulCost(lv); if(state.souls<cost){ toast('ã‚½ã‚¦ãƒ«ãŒè¶³ã‚Šãªã„'); Sound.play('error'); return false } state.souls-=cost; state.soulsSpent+=cost; state.soulUp[key]=lv+1; updateUI(); save(false); Sound.play('buy'); return true }
ui.soulBuyAtk&&ui.soulBuyAtk.addEventListener('click',()=>{ if(tryBuySoul('atk')) toast('æ°¸ç¶šATK +2%'); });
ui.soulBuyHP&&ui.soulBuyHP.addEventListener('click',()=>{ if(tryBuySoul('hp')) toast('æ°¸ç¶šHP +2%'); });
ui.soulBuyGold&&ui.soulBuyGold.addEventListener('click',()=>{ if(tryBuySoul('gold')) toast('æ°¸ç¶šGold +2%'); });

// ===== Relics & Codes
ui.codeBtn.addEventListener('click',()=>{ const code=(ui.codeInput.value||'').trim(); if(!code){ ui.codeStatus.textContent='ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›'; Sound.play('error'); return } if(code==='kashiwa060925'){ if(state.unlocks.kashiwa){ ui.codeStatus.textContent='ä½¿ç”¨æ¸ˆã¿'; Sound.play('error'); return } state.unlocks.kashiwa=true; ui.codeStatus.textContent='OKï¼šæŸã®åŠ è­·ã‚’å…¥æ‰‹'; updateUI(); save(false); Sound.play('buy'); return; } if(code==='kashiwa77'){ if(state.unlocks.strongsword){ ui.codeStatus.textContent='ä½¿ç”¨æ¸ˆã¿'; Sound.play('error'); return } state.unlocks.strongsword=true; ui.codeStatus.textContent='OKï¼šãƒ„ãƒ¨ã‚¹ã‚®ãƒ†=ã‚¯ã‚µãƒã‚¨ãƒ«ã‚’å…¥æ‰‹'; updateUI(); save(false); Sound.play('buy'); return; } ui.codeStatus.textContent='NG'; Sound.play('error'); });
ui.relicKashiwa&&ui.relicKashiwa.addEventListener('change',e=>{ state.relicActive.kashiwa=e.target.checked; save(false); Sound.play('ui'); });
ui.relicStrongSword&&ui.relicStrongSword.addEventListener('change',e=>{ state.relicActive.strongsword=e.target.checked; save(false); Sound.play('ui'); });

// ===== Export/Import in Settings
ui.downloadBtn&&ui.downloadBtn.addEventListener('click',()=>{ const name=(ui.exportName.value||defaultDownloadName())+'.json'; const blob=new Blob([localStorage.getItem(SAVE_KEY)||'{}'],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); Sound.play('ui'); });
ui.importFileBtn&&ui.importFileBtn.addEventListener('click',()=>{ openFileInput(ui.fileOpenSettings); Sound.play('ui'); });
function openFileInput(el){ el.value=''; el.click(); }
function readFileAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsText(file,'utf-8'); }); }
ui.fileOpenSettings&&ui.fileOpenSettings.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const txt=await readFileAsText(f); if(importSaveFromText(txt)){ toast('èª­ã¿è¾¼ã¿OK'); updateUI(); renderInventory(); Sound.play('buy'); } }catch(_){ toast('èª­è¾¼ã‚¨ãƒ©ãƒ¼'); Sound.play('error'); } });

// ===== Other settings
ui.wipeBtn&&ui.wipeBtn.addEventListener('click',()=>{ if(!confirm('å…¨ã‚»ãƒ¼ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã€‚OK?')) return; localStorage.removeItem(SAVE_KEY); location.reload(); });
ui.nameSave&&ui.nameSave.addEventListener('click',()=>{ const nm=(ui.nameEdit.value||'').trim(); if(!nm){ toast('åå‰ã‚’å…¥åŠ›'); Sound.play('error'); return } state.username=nm; save(false); toast('OK'); Sound.play('buy'); });

// ===== Start overlay (robust) + unlock audio
function hasSave(){ try{ return !!localStorage.getItem(SAVE_KEY) }catch(e){ return false } }
function setPrimaryButton(){ if(hasSave()){ ui.btnPrimary.setAttribute('data-mode','local'); ui.btnPrimary.textContent='ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼'; } else { ui.btnPrimary.setAttribute('data-mode','new'); ui.btnPrimary.textContent='ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ '; } }
function beginGame(uname){ if(!uname) uname='æ—…äºº'; state.username=uname; state.playerHP=recalcMaxHP(); spawnMonster(); renderInventory(); updateUI(); save(false); ui.startOverlay.hidden=true; startLoop(); Sound.play('ui'); }
function onAnyStartAction(){ seInitOnUserGesture(); }
['click','pointerdown','touchstart','keydown'].forEach(ev=>{ ui.btnPrimary.addEventListener(ev,onAnyStartAction,{passive:true}); ui.btnBegin.addEventListener(ev,onAnyStartAction,{passive:true}); ui.btnStartImportFile.addEventListener(ev,onAnyStartAction,{passive:true}); document.addEventListener(ev,onAnyStartAction,{once:true,passive:true}); });
ui.btnPrimary.addEventListener('click',()=>{ const mode=ui.btnPrimary.getAttribute('data-mode'); if(mode==='local'){ if(load(false)){ beginGame(state.username||'æ—…äºº'); } else { ui.startNote.textContent='ã‚»ãƒ¼ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ â†’ ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™'; setPrimaryButton(); Sound.play('error'); } } else if(mode==='new'){ const nm=(ui.startName.value||'').trim(); beginGame(nm); } else if(mode==='file'){ openFileInput(ui.fileOpenStart); } });
ui.btnStartImportFile.addEventListener('click',()=>openFileInput(ui.fileOpenStart));
ui.fileOpenStart.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const txt=await readFileAsText(f); if(importSaveFromText(txt)){ beginGame(state.username||'æ—…äºº'); Sound.play('buy'); } }catch(_){ ui.startNote.textContent='èª­è¾¼ã‚¨ãƒ©ãƒ¼'; Sound.play('error'); } });
ui.btnBegin.addEventListener('click',()=>{ const nm=(ui.startName.value||'').trim(); beginGame(nm); });
ui.startName.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); ui.btnBegin.click(); } });

// ===== Header collapse toggle & flavor bar link
function applyCollapsed(col){ if(col){ ui.topCollapsed.removeAttribute('hidden'); ui.topExpanded.setAttribute('hidden',''); ui.toggleInfo.setAttribute('aria-expanded','false'); ui.toggleInfo.textContent='â–¼ è©³ç´°'; ui.flavorBar && (ui.flavorBar.hidden=false); } else { ui.topCollapsed.setAttribute('hidden',''); ui.topExpanded.removeAttribute('hidden'); ui.toggleInfo.setAttribute('aria-expanded','true'); ui.toggleInfo.textContent='â–² é–‰ã˜ã‚‹'; ui.flavorBar && (ui.flavorBar.hidden=true); } localStorage.setItem(UI_MODE,col?'1':'0'); if(ui.flavorBar && ui.flavorBar.hidden===false && !_flavorNextAt){ updateFlavor('timer'); } Sound.play('ui'); }
ui.toggleInfo.addEventListener('click',()=>{ const col=ui.toggleInfo.getAttribute('aria-expanded')==='true'; applyCollapsed(col) });

// ===== Loop & UI refresh
let last=performance.now(), _loopStarted=false; function startLoop(){ if(_loopStarted) return; _loopStarted=true; requestAnimationFrame(loop); }
function loop(now){ const dt=Math.min(0.1,(now-last)/1000); last=now; autoTapTick(dt); enemyTick(dt); regenTick(dt); timersTick(); updateUI(); requestAnimationFrame(loop) }
function updateUI(){ ui.c_gold.textContent=Math.floor(state.gold); ui.c_level.textContent=state.level; ui.c_exp.textContent=`${state.exp}/${state.expToNext}`; ui.x_floor.textContent=state.floor; ui.x_level.textContent=state.level; ui.x_exp.textContent=`${state.exp}/${state.expToNext}`; ui.x_atk.textContent=playerATK(); ui.x_gold.textContent=Math.floor(state.gold); ui.x_souls.textContent=state.souls; ui.x_crit.textContent=`${Math.floor(playerCRIT())}%`; const mx=recalcMaxHP(); const pct=clamp(state.playerHP/mx*100,0,100); ui.x_hpbar.style.width=`${pct}%`; ui.x_hptxt.textContent=`${Math.floor(state.playerHP)}/${mx}`; ui.upgGold.textContent=Math.floor(state.gold); ui.lvAtk.textContent=state.upg.atk; ui.lvHP.textContent=state.upg.hp; ui.lvAuto.textContent=state.upg.auto; ui.countAtk.textContent=`è³¼å…¥å›æ•°ï¼š${state.upg.atk}`; ui.countHP.textContent=`è³¼å…¥å›æ•°ï¼š${state.upg.hp}`; ui.countAuto.textContent=`è³¼å…¥å›æ•°ï¼š${state.upg.auto}`; ui.autoRate.textContent=(state.autoTap||0).toFixed(1); ui.costAtk.textContent=prices.atk; ui.costHP.textContent=prices.hp; ui.costAuto.textContent=prices.auto; if(ui.staAtk){ ui.staAtk.textContent=playerATK(); ui.staHP.textContent=recalcMaxHP(); ui.staDef.textContent=playerDEF(); ui.staCrit.textContent=`${Math.floor(playerCRIT())}%`; ui.staGoldB.textContent=`${Math.floor(goldB())}%`; ui.staSatk.textContent=(state.soulUp.atk*2).toFixed(0); ui.staShp.textContent=(state.soulUp.hp*2).toFixed(0); ui.staSgold.textContent=(state.soulUp.gold*2).toFixed(0); ui.staMaxFloor.textContent=state.maxFloor; ui.staKills.textContent=state.kills; ui.staDeaths.textContent=state.deaths; ui.staAutoTap.textContent=(state.autoTap||0).toFixed(1); ui.staItemDrop.textContent=`${(getItemDrop()*100).toFixed(1)}%`; ui.staMimic.textContent='3.00%'; ui.staSuperMimic.textContent='1.20%'; ui.staStoneDrop.textContent='5%'; ui.staStoneAmt.textContent=Math.floor(state.floor/10); }
  ui.bagGold.textContent=Math.floor(state.gold); ui.bagSoul.textContent=state.souls; ui.bagSoulSpent.textContent=state.soulsSpent; ui.bagGem.textContent=state.magicStones; ui.bagPeb.textContent=state.pebbles; ui.bagEq.textContent=state.inv.length; ui.floorBadge && (ui.floorBadge.innerHTML=`éšå±¤ ${state.floor} <span class=\"theme-badge\" id=\"themeBadge\">${themeLabel(state.themes[currentBlockIdx()]||ensureThemeForBlock(currentBlockIdx()))}</span>`); ui.themeBadge=document.getElementById('themeBadge'); if(state.unlocks.kashiwa){ ui.relicLockedCard.setAttribute('hidden',''); ui.relicKashiwaCard.removeAttribute('hidden'); ui.relicKashiwa.checked=!!state.relicActive.kashiwa; } else { ui.relicLockedCard.removeAttribute('hidden'); ui.relicKashiwaCard.setAttribute('hidden',''); } if(state.unlocks.strongsword){ ui.relicStrongSwordLocked && ui.relicStrongSwordLocked.setAttribute('hidden',''); ui.relicStrongSwordCard && ui.relicStrongSwordCard.removeAttribute('hidden'); ui.relicStrongSword && (ui.relicStrongSword.checked=!!state.relicActive.strongsword); } else { ui.relicStrongSwordLocked && ui.relicStrongSwordLocked.removeAttribute('hidden'); ui.relicStrongSwordCard && ui.relicStrongSwordCard.setAttribute('hidden',''); }
  const gain=Math.floor(state.maxFloor/30); ui.soulGain && (ui.soulGain.textContent=gain);
  if(ui.flavorBar && ui.flavorBar.hidden===false && !_flavorNextAt){ updateFlavor('timer'); }
}

const MIMIC_P=0.03, SUPER_MIMIC_P=0.012; function getItemDrop(){ const luck=(state.eq.ring?.goldB??0)*0.2; return 0.20 + luck/100 }

// ===== Init
(function init(){
  // Tabs default
  switchMainTab('tab-upg');
  // Header collapsed default (show flavor bar)
  const saved=localStorage.getItem(UI_MODE); applyCollapsed(saved!=='0');
  // Detect existing save for start overlay
  ui.verText.textContent=GAME_VERSION; const exist=hasSave(); ui.saveDetect.textContent=exist?'OK':'â€”'; setPrimaryButton();
  // Preload username if exists
  try{ const raw=localStorage.getItem(SAVE_KEY); if(raw){ const o=JSON.parse(raw); if(o?.state?.username) state.username=o.state.username; } }catch(_){}
  // Persist on close
  window.addEventListener('beforeunload',()=>save(false));
})();
</script>
</body>
</html>