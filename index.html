<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG</title>
<meta name="theme-color" content="#0f1220">
<style>
  :root{--c-bg:#0b0f1f;--c-panel:#171a2b;--c-text:#e8eefc;--c-sub:#aab6d6;--c-danger:#ff6b6b;--c-gold:#ffd76a;--c-accent:#6eb6ff}
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%;touch-action:manipulation}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f1f,#0a0d1a);color:var(--c-text);-webkit-tap-highlight-color:transparent}
  [hidden]{display:none !important}
  header{position:sticky;top:0;z-index:3;background:#0d1120cc;backdrop-filter:blur(6px);border-bottom:1px solid #1f2440;padding:.6rem .8rem}
  .topbar{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .pill{background:#171a2b;border:1px solid #232742;border-radius:12px;padding:.45rem .6rem;font-size:.92rem;color:var(--c-sub)}
  .bar{width:160px;height:12px;border-radius:8px;background:#101425;border:1px solid #283055;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2ddf7f,#67e3a3);width:100%}
  .small{font-size:.85rem;color:var(--c-sub)}
  .toggle{justify-self:end;background:#121639;border:1px solid #2a2f66;color:#c9d6ff;padding:.45rem .6rem;border-radius:10px}
  .toggle[aria-expanded='true']{background:#1a2053}
  main{max-width:1200px;margin:0 auto;padding:1rem}
  .layout{display:grid;grid-template-columns:1.2fr .9fr;gap:1rem}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:#171a2b;border:1px solid #222647;border-radius:14px;padding:1rem;box-shadow:0 8px 24px #00000045,inset 0 1px #2b3159}
  .monster{position:relative;display:grid;gap:.6rem;justify-items:center;text-align:center;padding:1rem;border-radius:12px;background:radial-gradient(80% 80% at 50% 30%, #141937, #101635);border:1px solid #202554;user-select:none}
  .floor-badge{position:absolute;left:.6rem;top:.6rem;background:#0f1536;border:1px solid #2a2f66;border-radius:10px;padding:.2rem .5rem;font-size:.85rem;color:#cfe0ff}
  .monster-emoji{font-size:76px;line-height:1}
  .hpbar{width:100%;height:18px;background:#0c1026;border:1px solid #2a2f5a;border-radius:10px;overflow:hidden}
  .hpbar>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ff9f6b);width:100%;transition:width .12s ease}
  .monster-info{display:flex;justify-content:space-between;width:100%;color:#aab6d6;font-weight:600}
  .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center}
  .btn{background:#0f1536;color:#cfe0ff;border:1px solid #2a2f66;padding:.8rem 1.1rem;border-radius:12px;cursor:pointer;min-width:44px;min-height:44px}
  .btn:hover{background:#121a43}
  .btn.gold{border-color:#6e5a25;background:#221b08;color:#ffd76a}
  .btn.danger{border-color:#6b2833;background:#2a0d14;color:#ffb0b0}
  .btn:disabled{opacity:.5;filter:grayscale(40%);cursor:not-allowed}
  .grid{display:grid;gap:.6rem}
  .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem}
  .tab{background:#121639;border:1px solid #2a2f66;padding:.7rem 1rem;border-radius:12px;cursor:pointer;color:#c9d6ff}
  .tab.active{background:#1a2053;outline:2px solid #6888ff66}
  .tab-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
  .inv-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.6rem}
  .card{background:#0f1433;border:1px solid #2a2f66;border-radius:10px;padding:.7rem;display:grid;gap:.35rem}
  .row{display:flex;justify-content:space-between;gap:.6rem;align-items:center;flex-wrap:wrap}
  .muted{color:var(--c-sub)}.warn{color:var(--c-danger)}.gold{color:var(--c-gold)}
  .section-title{font-weight:700;margin:.2rem 0}

  /* ===== Fancy Start Overlay (Centralized) ===== */
  #startOverlay{position:fixed;inset:0;z-index:999;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .start-bg{position:absolute;inset:0;background:radial-gradient(1400px 800px at 20% 0%,#12204a22,transparent 60%),radial-gradient(1200px 700px at 80% 100%,#2a144a22,transparent 60%),linear-gradient(180deg,#0c1224,#090e1a 60%,#0b0f1f)}
  .start-stars{position:absolute;inset:-200px;opacity:.25;background-image:radial-gradient(#e8eefc 1px, transparent 1px),radial-gradient(#e8eefc 1px, transparent 1px);background-size:120px 120px, 160px 160px;animation:star-pan 50s linear infinite}
  @keyframes star-pan{from{transform:translate3d(0,0,0)}to{transform:translate3d(-300px,-200px,0)}}
  .start-wrap{position:relative;display:flex;align-items:center;justify-content:center;width:100%;min-height:100dvh;padding:clamp(16px,2.5vw,32px)}
  .start-box{width:min(900px,92vw);display:grid;gap:1rem;justify-items:center;text-align:center;background:#151a2eaa;border:1px solid #262c55;border-radius:14px;backdrop-filter:blur(6px);box-shadow:0 16px 48px #0008;padding:1.2rem}
  .game-title{font-size:clamp(28px,4vw,44px);font-weight:800;letter-spacing:.04em;text-shadow:0 6px 24px #0008}
  .title-logo{font-size:clamp(24px,5.6vw,64px);letter-spacing:.2em;filter:drop-shadow(0 8px 24px #0008)}
  .start-actions{display:grid;gap:.6rem;width:min(540px,92vw)}
  .bigbtn{display:block;width:100%;padding:1rem 1.2rem;border-radius:14px;background:#121639;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer}
  .bigbtn:hover{background:#1a2053}
  .sub{font-size:.9rem;color:#aab6d6}
  /* language bubble on start */
  .lang-fab{position:absolute;top:max(16px,env(safe-area-inset-top));right:max(16px,env(safe-area-inset-right));background:#121639;border:1px solid #2a2f66;border-radius:12px;color:#cfe0ff;cursor:pointer;padding:.45rem .6rem}
  .lang-panel{position:absolute;top:calc(max(16px,env(safe-area-inset-top)) + 40px);right:max(16px,env(safe-area-inset-right));background:#0f1433;border:1px solid #2a2f66;border-radius:12px;padding:.6rem;display:grid;gap:.5rem;min-width:220px;transform-origin:top right;scale:.98;opacity:0;pointer-events:none;transition:opacity .15s ease, scale .15s ease}
  .lang-panel.open{opacity:1;scale:1;pointer-events:auto}
  .lang-row{display:flex;gap:.5rem;align-items:center;justify-content:space-between}
  .input{background:#0b0f25;color:#cfe0ff;border:1px solid #2a2f66;border-radius:8px;padding:.55rem}
  .inline{display:flex;gap:.5rem;align-items:center;justify-content:center}
  .divider{height:1px;background:#2a2f66;width:100%;opacity:.6;margin:.3rem 0}
  .hint{color:#aab6d6;font-size:.85rem}
  .badge{display:inline-block;background:#0f1536;border:1px solid #2a2f66;padding:.2rem .5rem;border-radius:10px;color:#cfe0ff}
  .chooser{display:grid;gap:.5rem;background:#0f1433;border:1px solid #2a2f66;border-radius:12px;padding:.8rem}
  .chooser .btn{min-width:unset}
</style>
</head>
<body>

<!-- ===== Fancy Start Overlay ===== -->
<div id="startOverlay">
  <div class="start-bg"></div>
  <div class="start-stars"></div>
  <button id="startLangFab" class="lang-fab" aria-expanded="false" data-i18n="start.lang_btn">è¨€èª</button>
  <div id="startLangPanel" class="lang-panel" aria-hidden="true">
    <div class="lang-row"><span id="i18n_lang_panel_title">è¨€èª / Language / è¯­è¨€</span></div>
    <div class="inline">
      <select id="startLang" class="input" style="min-width:160px">
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="en">English</option>
        <option value="zh">ç®€ä½“ä¸­æ–‡</option>
      </select>
      <button class="btn" id="startLangApply" data-i18n="common.ok">OK</button>
    </div>
  </div>

  <div class="start-wrap">
    <div class="start-box">
      <div class="game-title" id="startTitle" data-i18n="start.title">ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG</div>
      <div class="title-logo" id="titleLogo">âš”ï¸ ğŸ›¡ï¸ ğŸ’</div>
      <div class="hint"><span data-i18n="start.version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š</span><span id="verText">0.5.0</span> ï¼ <span data-i18n="start.save_detect">ã‚»ãƒ¼ãƒ–æ¤œå‡ºï¼š</span><span id="saveDetect" class="badge">â€¦</span></div>

      <div class="start-actions">
        <button id="btnContinue" class="bigbtn" data-i18n="start.continue">ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼</button>
        <div id="continueChooser" class="chooser" hidden>
          <div class="hint" data-i18n="start.choose_how">ç¶šãæ–¹ã‚’é¸ã‚“ã§ãã ã•ã„</div>
          <div class="inline" style="gap:.6rem">
            <button id="btnFromLocal" class="btn" data-i18n="start.from_local">ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ç¶šã</button>
            <button id="btnFromFile" class="btn" data-i18n="start.from_file">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç¶šã</button>
            <input id="fileOpenStart" type="file" accept="application/json" hidden>
          </div>
        </div>
        <button id="btnNewGame" class="bigbtn" data-i18n="start.new_game">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>

        <div id="newWrap" hidden>
          <div class="divider"></div>
          <div class="inline"><label for="startName" data-i18n="start.username">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label><input id="startName" class="input" maxlength="20" placeholder="åå‰" data-i18n-ph="start.username_ph"></div>
          <div class="hint" data-i18n="start.name_hint">â€»å¾Œã‹ã‚‰è¨­å®šã§å¤‰æ›´ã§ãã¾ã™</div>
          <div class="inline"><button id="btnBegin" class="btn" data-i18n="start.begin">ã¯ã˜ã‚ã‚‹</button><button id="btnCancelNew" class="btn" data-i18n="common.back">æˆ»ã‚‹</button></div>
        </div>

        <div class="inline" style="justify-content:space-between">
          <span class="sub" id="startNote" data-i18n="start.note">ã“ã“ã§ä»•æ§˜ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€é–‹å§‹å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚</span>
        </div>
      </div>
    </div>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="wrap" id="top-collapsed">
      <div class="pill"><span data-i18n="ui.wallet">æ‰€æŒ</span> <span class="gold"><b id="c-gold">0</b> G</span></div>
      <div class="pill">Lv <b id="c-level">1</b></div>
      <div class="pill">EXP <b id="c-exp">0/20</b></div>
    </div>
    <button id="toggleInfo" class="toggle" aria-expanded="false" aria-controls="top-expanded" data-i18n="ui.more">â–¼ è©³ç´°</button>
    <div class="wrap" id="top-expanded" hidden>
      <div class="pill" data-i18n-wrap="ui.floor"><span>éšå±¤</span> <b id="x-floor">1</b></div>
      <div class="pill">Lv <b id="x-level">1</b></div>
      <div class="pill">EXP <b id="x-exp">0/20</b></div>
      <div class="pill" data-i18n-wrap="ui.hp"><span>HP</span> <span class="bar"><span id="x-hpbar" style="width:100%"></span></span> <span class="small" id="x-hptext">10/10</span></div>
      <div class="pill">ATK <b id="x-atk">1</b></div>
      <div class="pill" data-i18n-wrap="ui.wallet"><span>æ‰€æŒ</span> <span class="gold"><b id="x-gold">0</b> G</span></div>
      <div class="pill" data-i18n-wrap="ui.souls"><span>ã‚½ã‚¦ãƒ«</span> <b id="x-souls">0</b></div>
      <div class="pill" data-i18n-wrap="ui.crit"><span>ã‚¯ãƒªç‡</span> <b id="x-crit">5%</b></div>
      <div class="pill"><span class="small" id="timerAll"></span></div>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <section class="panel">
      <div id="monster" class="monster" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ”»æ’ƒ">
        <div class="floor-badge" id="floorBadge" data-i18n-wrap="ui.floor"><span>éšå±¤</span> 1</div>
        <div class="monster-emoji" id="monsterFace" aria-hidden="true">ğŸ‘ï¸</div>
        <div class="hpbar" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info"><span id="monsterName">Lv1 ã‚´ãƒ–ãƒªãƒ³</span><span id="monsterHPText">10 / 10</span></div>
        <div class="actions"><button class="btn" id="attackBtn" data-i18n="battle.start">æˆ¦é—˜é–‹å§‹ï¼</button></div>
        <div class="small" id="logline" aria-live="polite"></div>
      </div>
      <div class="footnote" id="footnoteBoss">10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™30ç§’</span>ï¼‰ã€‚æ­»äº¡ã™ã‚‹ã¨5ç§’ã§è‡ªå‹•å¾©æ´»ï¼ˆå¾©æ´»å¾Œã¯ä¸€åº¦åœæ­¢ï¼‰ã€‚</div>
    </section>

    <section class="panel" id="panel-floor">
      <div class="grid">
        <div class="row"><b data-i18n="floor.move">éšå±¤ç§»å‹•</b><label class="small"><input type="checkbox" id="stayCb"> <span data-i18n="floor.stay">ã“ã®éšå±¤ã«ç•™ã¾ã‚‹</span></label></div>
        <div class="row">
          <button class="btn danger" id="fleeBtn" data-i18n="floor.back1">1éšæˆ»ã‚‹</button>
          <button class="btn gold" id="nextBtn" title="" data-i18n="floor.next">æ¬¡ã®éšå±¤ã¸</button>
        </div>
        <div class="small muted" id="floorHint"></div>
      </div>
    </section>

    <section class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="tab-upg" data-i18n="tabs.upgrade">å¼·åŒ–</button>
        <button class="tab" data-tab="tab-inv" data-i18n="tabs.inventory">è£…å‚™</button>
        <button class="tab" data-tab="tab-sta" data-i18n="tabs.status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
        <button class="tab" data-tab="tab-adv" data-i18n="tabs.adv">è»¢ç”Ÿ/è–éºç‰©</button>
        <button class="tab" data-tab="tab-settings" data-i18n="tabs.settings">è¨­å®š/ã‚»ãƒ¼ãƒ–</button>
      </div>

      <!-- å¼·åŒ– -->
      <div id="tab-upg" class="grid">
        <div class="tab-row"><div class="small muted" data-i18n="upg.menu">å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div><div class="small"><span data-i18n="ui.wallet">æ‰€æŒ</span> <b id="upgGold">0</b> G</div></div>
        <div class="card">
          <div class="row"><div><b data-i18n="upg.atk.title">æ”»æ’ƒåŠ›å¼·åŒ–</b><div class="small muted" data-i18n="upg.atk.desc">ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ </div></div><div class="gold"><b id="costAtk">10</b> G</div></div>
          <button class="btn" id="buyAtk" data-i18n="upg.atk.btn">è³¼å…¥ (+1 ATK) / Lv <b id="lvAtk">0</b></button>
        </div>
        <div class="card">
          <div class="row"><div><b data-i18n="upg.hp.title">æœ€å¤§HPå¼·åŒ–</b><div class="small muted" data-i18n="upg.hp.desc">è€ä¹…ã‚’å¢—åŠ </div></div><div class="gold"><b id="costHP">10</b> G</div></div>
          <button class="btn" id="buyHP" data-i18n="upg.hp.btn">è³¼å…¥ (+5 HP) / Lv <b id="lvHP">0</b></button>
        </div>
        <div class="card">
          <div class="row"><div><b data-i18n="upg.auto.title">è‡ªå‹•ã‚¿ãƒƒãƒ—</b><div class="small muted" data-i18n="upg.auto.desc">æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰</div></div><div class="gold"><b id="costAuto">25</b> G</div></div>
          <button class="btn" id="buyAuto" data-i18n="upg.auto.btn">è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’) / Lv <b id="lvAuto">0</b></button>
          <div class="small muted" data-i18n-wrap="upg.auto.now">ç¾åœ¨ï¼š<b id="autoRate">0.0</b> ã‚¿ãƒƒãƒ—/ç§’</div>
        </div>
      </div>

      <!-- è£…å‚™ -->
      <div id="tab-inv" class="grid" hidden>
        <div class="card"><div><b data-i18n="inv.equipped">è£…å‚™ä¸­</b></div><div class="small" data-i18n-wrap="inv.weapon">æ­¦å™¨ï¼š<span id="eq-weapon">ãªã—</span></div><div class="small" data-i18n-wrap="inv.armor">é§ã€€ï¼š<span id="eq-armor">ãªã—</span></div><div class="small" data-i18n-wrap="inv.ring">æŒ‡è¼ªï¼š<span id="eq-ring">ãªã—</span></div></div>
        <div class="card"><div class="row"><b data-i18n="inv.bag">æ‰€æŒå“</b><label class="small"><input type="checkbox" id="autoEquip" /> <span data-i18n="inv.auto">å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™</span></label></div><div class="inv-list" id="invList"></div></div>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
      <div id="tab-sta" class="grid" hidden>
        <div class="card">
          <div class="section-title" data-i18n="sta.title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div class="small" data-i18n-wrap="sta.atk">ATKï¼š<b id="sta-atk">1</b></div>
          <div class="small" data-i18n-wrap="sta.hp">æœ€å¤§HPï¼š<b id="sta-hp">10</b></div>
          <div class="small" data-i18n-wrap="sta.def">é˜²å¾¡ï¼š<b id="sta-def">0</b></div>
          <div class="small" data-i18n-wrap="sta.crit">ã‚¯ãƒªç‡ï¼ˆãƒ©ãƒƒã‚¯ï¼‰ï¼š<b id="sta-crit">5%</b></div>
          <div class="small" data-i18n-wrap="sta.goldb">ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š<b id="sta-goldb">0%</b></div>
          <div class="small" data-i18n-wrap="sta.soulb">ã‚½ã‚¦ãƒ«è£œæ­£ï¼ˆæ’ä¹…ï¼‰ï¼š<b id="sta-soulb">0%</b></div>
          <div class="small" data-i18n-wrap="sta.autotap">è‡ªå‹•ã‚¿ãƒƒãƒ—ï¼š<b id="sta-autotap">0.0</b> /ç§’</div>
          <div class="small" data-i18n-wrap="sta.itemdrop">è£…å‚™ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼š<b id="sta-itemdrop">20%</b></div>
          <div class="small" data-i18n-wrap="sta.mimic">ãƒŸãƒŸãƒƒã‚¯å‡ºç¾ç‡ï¼š<b id="sta-mimic">5%</b></div>
          <div class="small" data-i18n-wrap="sta.supermimic">è¶…ãƒŸãƒŸãƒƒã‚¯å‡ºç¾ç‡ï¼š<b id="sta-supermimic">2%</b></div>
          <div class="small" data-i18n-wrap="sta.stonedrop">çŸ³ã“ã‚ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼š<b id="sta-stonedrop">5%</b>ï¼ˆ1å›ã‚ãŸã‚Š<b id="sta-stoneamt">0</b>å€‹ï¼‰</div>
        </div>
        <div class="card">
          <div class="section-title" data-i18n="sta.record">æˆ¦ç¸¾</div>
          <div class="small" data-i18n-wrap="sta.maxfloor">æœ€é«˜åˆ°é”éšå±¤ï¼š<b id="sta-maxfloor">1</b></div>
          <div class="small" data-i18n-wrap="sta.kills">è¨ä¼æ•°ï¼š<b id="sta-kills">0</b></div>
          <div class="small" data-i18n-wrap="sta.deaths">æ­»äº¡æ•°ï¼š<b id="sta-deaths">0</b></div>
        </div>
        <div class="card">
          <div class="section-title" data-i18n="bag.title">æ‰€æŒç‰©</div>
          <div class="small" data-i18n-wrap="bag.gold">ã‚´ãƒ¼ãƒ«ãƒ‰ï¼š<b id="bag-gold">0</b> G</div>
          <div class="small" data-i18n-wrap="bag.soul">ã‚½ã‚¦ãƒ«ï¼š<b id="bag-soul">0</b></div>
          <div class="small" data-i18n-wrap="bag.gem">é­”çŸ³ï¼š<b id="bag-gem">0</b></div>
          <div class="small" data-i18n-wrap="bag.peb">è¼ãçŸ³ã“ã‚ï¼š<b id="bag-peb">0</b></div>
          <div class="small" data-i18n-wrap="bag.eq">è£…å‚™æ‰€æŒæ•°ï¼š<b id="bag-eq">0</b></div>
        </div>
      </div>

      <!-- è»¢ç”Ÿ/è–éºç‰©ï¼ˆçµ±åˆï¼‰ -->
      <div id="tab-adv" class="grid" hidden>
        <div class="card">
          <b data-i18n="asc.title">è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰</b>
          <div class="small" data-i18n="asc.desc">è»¢ç”Ÿã§ çŸ³ã“ã‚â†’é­”çŸ³ ã¸å¤‰æ›ã€‚æ’ä¹…å¼·åŒ–ã«ä½¿ç”¨ï¼ˆæº–å‚™ä¸­ï¼‰ã€‚</div>
          <div class="row"><div data-i18n-wrap="asc.gain">ç²å¾—è¦‹è¾¼ã¿ï¼š<b id="soulGain">0</b> ã‚½ã‚¦ãƒ«</div><button class="btn danger" id="ascendBtn" data-i18n="asc.action">è»¢ç”Ÿã™ã‚‹</button></div>
        </div>
        <div class="card" id="relicKashiwaCard" hidden>
          <div class="row"><b data-i18n="relic.kashiwa">æŸã®åŠ è­·</b><label class="small"><input type="checkbox" id="relicKashiwa"> <span data-i18n="relic.enable">æœ‰åŠ¹åŒ–</span></label></div>
          <div class="small" data-i18n="relic.kashiwa_desc">åŠ¹æœï¼šã‚¿ãƒƒãƒ—æ™‚ã€ä¸ãˆãŸä¸€æ’ƒãŒæ•µHPã‚’è¶…ãˆãŸåˆ†ã ã‘è¤‡æ•°ä½“è¨ä¼ï¼ˆATKåŸºæº–ï¼‰ã€‚2ä½“ä»¥ä¸Šå€’ã™ã¨ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
        </div>
        <div class="card" id="relicLockedCard">
          <b data-i18n="relic.locked_title">è–éºç‰©ï¼ˆæœªè§£æ”¾ï¼‰</b>
          <div class="small" data-i18n="relic.locked_hint">è¨­å®šã‚¿ãƒ–ã®ã€Œã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆã€ã§å…¥æ‰‹ã§ãã¾ã™</div>
        </div>
      </div>

      <!-- è¨­å®š/ã‚»ãƒ¼ãƒ–ï¼ˆçµ±åˆï¼‰ -->
      <div id="tab-settings" class="grid" hidden>
        <div class="card">
          <b data-i18n="code.title">ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆ</b>
          <div class="row"><input id="codeInput" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="input" style="flex:1;min-width:160px" data-i18n-ph="code.ph"/><button class="btn" id="codeBtn" data-i18n="code.redeem">å¼•ãæ›ãˆ</button></div>
          <div class="small muted" id="codeStatus"></div>
        </div>
        <div class="card">
          <b data-i18n="save.title">ã‚»ãƒ¼ãƒ–</b>
          <div class="row" style="gap:.4rem;align-items:center">
            <input id="exportName" class="input" placeholder="ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ã¯è‡ªå‹•ã§ .jsonï¼‰" style="flex:1" data-i18n-ph="save.name_ph" />
            <button class="btn" id="downloadBtn" data-i18n="save.download">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
          <div class="small muted" style="margin-top:.3rem" data-i18n="save.note">â€»ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã¯å†…éƒ¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚</div>
        </div>
        <div class="card">
          <b data-i18n="import.title">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>
          <div class="row" style="gap:.6rem;align-items:center">
            <button class="btn" id="importFileBtn" data-i18n="import.from_file">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
            <input id="fileOpenSettings" type="file" accept="application/json" hidden>
          </div>
          <div class="small muted" data-i18n="import.note">JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®å†…å®¹ã‚’ã‚»ãƒ¼ãƒ–ã¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚</div>
        </div>
        <div class="card">
          <b data-i18n="other.title">ãã®ä»–</b>
          <div class="row" style="gap:.6rem"><button class="btn danger" id="wipeBtn" data-i18n="other.wipe">å…¨å‰Šé™¤</button></div>
        </div>
        <div class="card">
          <b data-i18n="langname.title">è¨€èª / åå‰</b>
          <div class="row" style="gap:.6rem;align-items:center">
            <label for="langSelect" data-i18n="langname.lang">è¨€èª</label>
            <select id="langSelect" class="input" style="min-width:200px">
              <option value="ja">æ—¥æœ¬èª</option>
              <option value="en">English</option>
              <option value="zh">ç®€ä½“ä¸­æ–‡</option>
            </select>
            <button class="btn" id="langSave" data-i18n="common.save">ä¿å­˜</button>
          </div>
          <div class="row" style="gap:.6rem;align-items:center;margin-top:.5rem">
            <input id="nameEdit" class="input" maxlength="20" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ " style="flex:1" data-i18n-ph="langname.name_ph">
            <button class="btn" id="nameSave" data-i18n="common.save">ä¿å­˜</button>
          </div>
        </div>
      </div>

    </section>
  </div>
</main>

<script>
const GAME_VERSION='0.5.0';
const SAVE_KEY='tap_hns_save_v5', UI_MODE='ui_top_mode_v7';
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

// ====== i18n Dictionaries
const I18N={
  ja:{
    'common.ok':'OK','common.save':'ä¿å­˜','common.back':'æˆ»ã‚‹',
    'start.lang_btn':'è¨€èª','start.title':'ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG','start.version':'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š','start.save_detect':'ã‚»ãƒ¼ãƒ–æ¤œå‡ºï¼š','start.continue':'ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼','start.choose_how':'ç¶šãæ–¹ã‚’é¸ã‚“ã§ãã ã•ã„','start.from_local':'ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ç¶šã','start.from_file':'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç¶šã','start.new_game':'ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ','start.username':'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ','start.username_ph':'åå‰','start.name_hint':'â€»å¾Œã‹ã‚‰è¨­å®šã§å¤‰æ›´ã§ãã¾ã™','start.begin':'ã¯ã˜ã‚ã‚‹','start.note':'ã“ã“ã§ä»•æ§˜ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€é–‹å§‹å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚',
    'ui.more':'â–¼ è©³ç´°','ui.more_close':'â–² é–‰ã˜ã‚‹','ui.wallet':'æ‰€æŒ','ui.floor':'éšå±¤','ui.hp':'HP','ui.souls':'ã‚½ã‚¦ãƒ«','ui.crit':'ã‚¯ãƒªç‡',
    'tabs.upgrade':'å¼·åŒ–','tabs.inventory':'è£…å‚™','tabs.status':'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','tabs.adv':'è»¢ç”Ÿ/è–éºç‰©','tabs.settings':'è¨­å®š/ã‚»ãƒ¼ãƒ–',
    'battle.start':'æˆ¦é—˜é–‹å§‹ï¼','battle.tap':'æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰','battle.kill':'å€’ã™','battle.attack':'æ”»æ’ƒ',
    'foot.boss':'10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™30ç§’</span>ï¼‰ã€‚æ­»äº¡ã™ã‚‹ã¨5ç§’ã§è‡ªå‹•å¾©æ´»ï¼ˆå¾©æ´»å¾Œã¯ä¸€åº¦åœæ­¢ï¼‰ã€‚',
    'floor.move':'éšå±¤ç§»å‹•','floor.stay':'ã“ã®éšå±¤ã«ç•™ã¾ã‚‹','floor.back1':'1éšæˆ»ã‚‹','floor.next':'æ¬¡ã®éšå±¤ã¸','floor.best':'æœ€é«˜åˆ°é”ï¼š{n} éš',
    'upg.menu':'å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼','upg.atk.title':'æ”»æ’ƒåŠ›å¼·åŒ–','upg.atk.desc':'ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ ','upg.atk.btn':'è³¼å…¥ (+1 ATK) / Lv ','upg.hp.title':'æœ€å¤§HPå¼·åŒ–','upg.hp.desc':'è€ä¹…ã‚’å¢—åŠ ','upg.hp.btn':'è³¼å…¥ (+5 HP) / Lv ','upg.auto.title':'è‡ªå‹•ã‚¿ãƒƒãƒ—','upg.auto.desc':'æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰','upg.auto.btn':'è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’) / Lv ','upg.auto.now':'ç¾åœ¨ï¼š',
    'inv.equipped':'è£…å‚™ä¸­','inv.weapon':'æ­¦å™¨ï¼š','inv.armor':'é§ã€€ï¼š','inv.ring':'æŒ‡è¼ªï¼š','inv.bag':'æ‰€æŒå“','inv.auto':'å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™',
    'sta.title':'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','sta.atk':'ATKï¼š','sta.hp':'æœ€å¤§HPï¼š','sta.def':'é˜²å¾¡ï¼š','sta.crit':'ã‚¯ãƒªç‡ï¼ˆãƒ©ãƒƒã‚¯ï¼‰ï¼š','sta.goldb':'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š','sta.soulb':'ã‚½ã‚¦ãƒ«è£œæ­£ï¼ˆæ’ä¹…ï¼‰ï¼š','sta.autotap':'è‡ªå‹•ã‚¿ãƒƒãƒ—ï¼š','sta.itemdrop':'è£…å‚™ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼š','sta.mimic':'ãƒŸãƒŸãƒƒã‚¯å‡ºç¾ç‡ï¼š','sta.supermimic':'è¶…ãƒŸãƒŸãƒƒã‚¯å‡ºç¾ç‡ï¼š','sta.stonedrop':'çŸ³ã“ã‚ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼š','sta.record':'æˆ¦ç¸¾','sta.maxfloor':'æœ€é«˜åˆ°é”éšå±¤ï¼š','sta.kills':'è¨ä¼æ•°ï¼š','sta.deaths':'æ­»äº¡æ•°ï¼š',
    'bag.title':'æ‰€æŒç‰©','bag.gold':'ã‚´ãƒ¼ãƒ«ãƒ‰ï¼š','bag.soul':'ã‚½ã‚¦ãƒ«ï¼š','bag.gem':'é­”çŸ³ï¼š','bag.peb':'è¼ãçŸ³ã“ã‚ï¼š','bag.eq':'è£…å‚™æ‰€æŒæ•°ï¼š',
    'asc.title':'è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰','asc.desc':'è»¢ç”Ÿã§ çŸ³ã“ã‚â†’é­”çŸ³ ã¸å¤‰æ›ã€‚æ’ä¹…å¼·åŒ–ã«ä½¿ç”¨ï¼ˆæº–å‚™ä¸­ï¼‰ã€‚','asc.gain':'ç²å¾—è¦‹è¾¼ã¿ï¼š','asc.action':'è»¢ç”Ÿã™ã‚‹',
    'relic.kashiwa':'æŸã®åŠ è­·','relic.enable':'æœ‰åŠ¹åŒ–','relic.kashiwa_desc':'åŠ¹æœï¼šã‚¿ãƒƒãƒ—æ™‚ã€ä¸ãˆãŸä¸€æ’ƒãŒæ•µHPã‚’è¶…ãˆãŸåˆ†ã ã‘è¤‡æ•°ä½“è¨ä¼ï¼ˆATKåŸºæº–ï¼‰ã€‚2ä½“ä»¥ä¸Šå€’ã™ã¨ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸','relic.locked_title':'è–éºç‰©ï¼ˆæœªè§£æ”¾ï¼‰','relic.locked_hint':'è¨­å®šã‚¿ãƒ–ã®ã€Œã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆã€ã§å…¥æ‰‹ã§ãã¾ã™',
    'code.title':'ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆ','code.ph':'ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›','code.redeem':'å¼•ãæ›ãˆ',
    'save.title':'ã‚»ãƒ¼ãƒ–','save.name_ph':'ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ã¯è‡ªå‹•ã§ .jsonï¼‰','save.download':'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰','save.note':'â€»ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã¯å†…éƒ¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚',
    'import.title':'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ','import.from_file':'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿','import.note':'JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®å†…å®¹ã‚’ã‚»ãƒ¼ãƒ–ã¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚',
    'other.title':'ãã®ä»–','other.wipe':'å…¨å‰Šé™¤','langname.title':'è¨€èª / åå‰','langname.lang':'è¨€èª','langname.name_ph':'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ',
    'msg.need_name':'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','msg.no_save':'ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚»ãƒ¼ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','msg.saved':'ä¿å­˜ã—ã¾ã—ãŸ','msg.loaded':'èª­è¾¼ã—ã¾ã—ãŸ','msg.save_exported':'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ','msg.money_short':'ãŠé‡‘ãŒè¶³ã‚Šãªã„â€¦','msg.cant_advance':'ã¾ã é€²ã‚ãªã„â€¦','msg.levelup':'ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ATK+1 / HP+2','msg.downed':'æ°—çµ¶ã—ã¾ã—ãŸâ€¦{s}ç§’å¾Œã«å¾©æ´»','msg.revive':'å¾©æ´»ï¼','msg.boss_spawn':'ãƒœã‚¹å‡ºç¾ï¼æœ€åˆã®ä¸€æ’ƒã§æˆ¦é—˜é–‹å§‹','msg.tap_to_start':'ã‚¿ãƒƒãƒ—ã§æˆ¦é—˜é–‹å§‹','msg.killed_many':'æ•µã‚’{n}ä½“å€’ã—ãŸï¼','msg.drop':'ãƒ‰ãƒ­ãƒƒãƒ—ï¼š{text}','msg.special_drop':'ç‰¹åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ï¼š{text}'
  },
  en:{
    'common.ok':'OK','common.save':'Save','common.back':'Back',
    'start.lang_btn':'Language','start.title':'Hack & Slash Tap RPG','start.version':'Version: ','start.save_detect':'Save found: ','start.continue':'Continue','start.choose_how':'Choose how to continue','start.from_local':'Continue from Local','start.from_file':'Continue from File','start.new_game':'New Game','start.username':'Username','start.username_ph':'Name','start.name_hint':'* You can change it later in Settings','start.begin':'Start','start.note':'We check game specs here, then load your data after starting.',
    'ui.more':'â–¼ Details','ui.more_close':'â–² Close','ui.wallet':'Wallet','ui.floor':'Floor','ui.hp':'HP','ui.souls':'Souls','ui.crit':'Crit',
    'tabs.upgrade':'Upgrade','tabs.inventory':'Inventory','tabs.status':'Status','tabs.adv':'Ascend/Relics','tabs.settings':'Settings/Save',
    'battle.start':'Begin Battle!','battle.tap':'Attack (Tap)','battle.kill':'Finish','battle.attack':'Attack',
    'foot.boss':'Boss every 10 floors (<span class="warn">30s limit</span>). When you die, auto revive in 5s (then paused).',
    'floor.move':'Floor Move','floor.stay':'Stay on this floor','floor.back1':'Go back 1 Floor','floor.next':'Next Floor','floor.best':'Best: {n}',
    'upg.menu':'Upgrade Menu','upg.atk.title':'ATK Upgrade','upg.atk.desc':'Increase click damage','upg.atk.btn':'Buy (+1 ATK) / Lv ','upg.hp.title':'Max HP Upgrade','upg.hp.desc':'Increase survivability','upg.hp.btn':'Buy (+5 HP) / Lv ','upg.auto.title':'Auto Tap','upg.auto.desc':'Auto attacks per second (scales with ATK)','upg.auto.btn':'Buy (+0.2 taps/s) / Lv ','upg.auto.now':'Now: ',
    'inv.equipped':'Equipped','inv.weapon':'Weapon:','inv.armor':'Armor:','inv.ring':'Ring:','inv.bag':'Inventory','inv.auto':'Auto equip better items',
    'sta.title':'Status','sta.atk':'ATK:','sta.hp':'Max HP:','sta.def':'DEF:','sta.crit':'Crit (Luck):','sta.goldb':'Gold Bonus:','sta.soulb':'Soul Bonus (perm):','sta.autotap':'Auto Tap:','sta.itemdrop':'Equip Drop Rate:','sta.mimic':'Mimic Rate:','sta.supermimic':'Super Mimic Rate:','sta.stonedrop':'Pebble Drop:','sta.record':'Records','sta.maxfloor':'Max Floor:','sta.kills':'Kills:','sta.deaths':'Deaths:',
    'bag.title':'Bag','bag.gold':'Gold:','bag.soul':'Souls:','bag.gem':'Magic Stones:','bag.peb':'Shiny Pebbles:','bag.eq':'Equip Count:',
    'asc.title':'Ascension (Permanent Boosts)','asc.desc':'Convert Pebbles â†’ Magic Stones on ascend. Used for permanent upgrades (WIP).','asc.gain':'Estimated gain: ','asc.action':'Ascend',
    'relic.kashiwa':'Blessing of Kashiwa','relic.enable':'Enable','relic.kashiwa_desc':'On tap, overkill damage defeats multiple foes (by ATK). Special message for 2+ kills.','relic.locked_title':'Relics (Locked)','relic.locked_hint':'Redeem a code in Settings to unlock',
    'code.title':'Redeem Code','code.ph':'Enter code','code.redeem':'Redeem',
    'save.title':'Save','save.name_ph':'Filename (suffix .json auto)','save.download':'Download','save.note':'Auto-save runs internally. Download a file for backup safety.',
    'import.title':'Import','import.from_file':'Load from File','import.note':'Choose a JSON file to load it as your save.',
    'other.title':'Others','other.wipe':'Wipe All','langname.title':'Language / Name','langname.lang':'Language','langname.name_ph':'Username',
    'msg.need_name':'Please enter a username','msg.no_save':'No local save found','msg.saved':'Saved','msg.loaded':'Loaded','msg.save_exported':'File downloaded','msg.money_short':'Not enough goldâ€¦','msg.cant_advance':'Cannot advance yetâ€¦','msg.levelup':'Level Up! ATK+1 / HP+2','msg.downed':'Downedâ€¦ revive in {s}s','msg.revive':'Revived!','msg.boss_spawn':'Boss appears! First hit starts timer','msg.tap_to_start':'Tap to start battle','msg.killed_many':'Defeated {n} foes!','msg.drop':'Drop: {text}','msg.special_drop':'Special Drop: {text}'
  },
  zh:{
    'common.ok':'ç¡®å®š','common.save':'ä¿å­˜','common.back':'è¿”å›',
    'start.lang_btn':'è¯­è¨€','start.title':'åˆ·åˆ·åˆ·ç‚¹å‡»RPG','start.version':'ç‰ˆæœ¬ï¼š','start.save_detect':'å­˜æ¡£æ£€æµ‹ï¼š','start.continue':'ç»§ç»­æ¸¸æˆ','start.choose_how':'è¯·é€‰æ‹©ç»§ç»­æ–¹å¼','start.from_local':'ä»æœ¬åœ°ç»§ç»­','start.from_file':'ä»æ–‡ä»¶ç»§ç»­','start.new_game':'æ–°æ¸¸æˆ','start.username':'ç”¨æˆ·å','start.username_ph':'åå­—','start.name_hint':'* ä¹‹åå¯åœ¨è®¾ç½®ä¸­ä¿®æ”¹','start.begin':'å¼€å§‹','start.note':'æ­¤å¤„æ£€æŸ¥è§„æ ¼ï¼Œå¼€å§‹åè½½å…¥æ•°æ®ã€‚',
    'ui.more':'â–¼ è¯¦ç»†','ui.more_close':'â–² å…³é—­','ui.wallet':'æŒæœ‰','ui.floor':'æ¥¼å±‚','ui.hp':'ç”Ÿå‘½','ui.souls':'çµé­‚','ui.crit':'æš´å‡»',
    'tabs.upgrade':'å¼ºåŒ–','tabs.inventory':'è£…å¤‡','tabs.status':'çŠ¶æ€','tabs.adv':'è½¬ç”Ÿ/åœ£é—ç‰©','tabs.settings':'è®¾ç½®/ä¿å­˜',
    'battle.start':'å¼€å§‹æˆ˜æ–—ï¼','battle.tap':'æ”»å‡»ï¼ˆç‚¹å‡»ï¼‰','battle.kill':'å‡»æ€','battle.attack':'æ”»å‡»',
    'foot.boss':'æ¯10å±‚é‡åˆ°Bossï¼ˆ<span class="warn">é™æ—¶30ç§’</span>ï¼‰ã€‚æ­»äº¡5ç§’åè‡ªåŠ¨å¤æ´»ï¼ˆå¤æ´»åæš‚åœï¼‰ã€‚',
    'floor.move':'æ¥¼å±‚ç§»åŠ¨','floor.stay':'åœç•™åœ¨æœ¬å±‚','floor.back1':'è¿”å›1å±‚','floor.next':'å‰å¾€ä¸‹ä¸€å±‚','floor.best':'æœ€é«˜ï¼š{n}',
    'upg.menu':'å¼ºåŒ–èœå•','upg.atk.title':'æ”»å‡»åŠ›å¼ºåŒ–','upg.atk.desc':'æå‡ç‚¹å‡»ä¼¤å®³','upg.atk.btn':'è´­ä¹° (+1 ATK) / ç­‰çº§ ','upg.hp.title':'æœ€å¤§ç”Ÿå‘½å¼ºåŒ–','upg.hp.desc':'æå‡ç”Ÿå­˜åŠ›','upg.hp.btn':'è´­ä¹° (+5 HP) / ç­‰çº§ ','upg.auto.title':'è‡ªåŠ¨ç‚¹å‡»','upg.auto.desc':'æ¯ç§’è‡ªåŠ¨æ”»å‡»ï¼ˆä¸ATKç›¸å…³ï¼‰','upg.auto.btn':'è´­ä¹° (+0.2 æ¬¡/ç§’) / ç­‰çº§ ','upg.auto.now':'å½“å‰ï¼š',
    'inv.equipped':'å·²è£…å¤‡','inv.weapon':'æ­¦å™¨ï¼š','inv.armor':'æŠ¤ç”²ï¼š','inv.ring':'æŒ‡ç¯ï¼š','inv.bag':'èƒŒåŒ…','inv.auto':'è‡ªåŠ¨è£…å¤‡æ›´å¼ºç‰©å“',
    'sta.title':'çŠ¶æ€','sta.atk':'ATKï¼š','sta.hp':'æœ€å¤§ç”Ÿå‘½ï¼š','sta.def':'é˜²å¾¡ï¼š','sta.crit':'æš´å‡»ï¼ˆå¹¸è¿ï¼‰ï¼š','sta.goldb':'é‡‘å¸åŠ æˆï¼š','sta.soulb':'çµé­‚åŠ æˆï¼ˆæ°¸ä¹…ï¼‰ï¼š','sta.autotap':'è‡ªåŠ¨ç‚¹å‡»ï¼š','sta.itemdrop':'è£…å¤‡æ‰ç‡ï¼š','sta.mimic':'å®ç®±æ€ªå‡ºç°ç‡ï¼š','sta.supermimic':'è¶…å®ç®±æ€ªå‡ºç°ç‡ï¼š','sta.stonedrop':'å°çŸ³æ‰ç‡ï¼š','sta.record':'æˆ˜ç»©','sta.maxfloor':'æœ€é«˜å±‚ï¼š','sta.kills':'å‡»æ€æ•°ï¼š','sta.deaths':'æ­»äº¡æ•°ï¼š',
    'bag.title':'ç‰©å“','bag.gold':'é‡‘å¸ï¼š','bag.soul':'çµé­‚ï¼š','bag.gem':'é­”çŸ³ï¼š','bag.peb':'é—ªäº®å°çŸ³ï¼š','bag.eq':'è£…å¤‡æ•°é‡ï¼š',
    'asc.title':'è½¬ç”Ÿï¼ˆæ°¸ä¹…å¼ºåŒ–ï¼‰','asc.desc':'è½¬ç”ŸæŠŠå°çŸ³ â†’ é­”çŸ³ï¼Œç”¨äºæ°¸ä¹…å¼ºåŒ–ï¼ˆå¼€å‘ä¸­ï¼‰ã€‚','asc.gain':'é¢„è®¡è·å¾—ï¼š','asc.action':'è½¬ç”Ÿ',
    'relic.kashiwa':'æŸä¹‹åŠ æŠ¤','relic.enable':'å¯ç”¨','relic.kashiwa_desc':'ç‚¹å‡»æ—¶ï¼Œæº¢å‡ºä¼¤å®³å¯å‡»è´¥å¤šä¸ªæ•Œäººï¼ˆæŒ‰ATKè®¡ç®—ï¼‰ã€‚å‡»æ€â‰¥2æ˜¾ç¤ºç‰¹åˆ«ä¿¡æ¯ã€‚','relic.locked_title':'åœ£é—ç‰©ï¼ˆæœªè§£é”ï¼‰','relic.locked_hint':'åœ¨è®¾ç½®ä¸­å…‘æ¢ä»£ç ä»¥è·å¾—',
    'code.title':'å…‘æ¢ä»£ç ','code.ph':'è¾“å…¥ä»£ç ','code.redeem':'å…‘æ¢',
    'save.title':'ä¿å­˜','save.name_ph':'æ–‡ä»¶åï¼ˆè‡ªåŠ¨åŠ  .jsonï¼‰','save.download':'ä¸‹è½½','save.note':'å†…éƒ¨è‡ªåŠ¨ä¿å­˜ã€‚å»ºè®®ä¸‹è½½å¤‡ä»½æ–‡ä»¶ã€‚',
    'import.title':'å¯¼å…¥','import.from_file':'ä»æ–‡ä»¶å¯¼å…¥','import.note':'é€‰æ‹©JSONæ–‡ä»¶å¹¶ä½œä¸ºå­˜æ¡£è½½å…¥ã€‚',
    'other.title':'å…¶ä»–','other.wipe':'å…¨éƒ¨åˆ é™¤','langname.title':'è¯­è¨€ / åç§°','langname.lang':'è¯­è¨€','langname.name_ph':'ç”¨æˆ·å',
    'msg.need_name':'è¯·è¾“å…¥ç”¨æˆ·å','msg.no_save':'æœªæ‰¾åˆ°æœ¬åœ°å­˜æ¡£','msg.saved':'å·²ä¿å­˜','msg.loaded':'å·²è½½å…¥','msg.save_exported':'å·²ä¸‹è½½æ–‡ä»¶','msg.money_short':'é‡‘å¸ä¸è¶³â€¦','msg.cant_advance':'æš‚æ—¶æ— æ³•å‰è¿›â€¦','msg.levelup':'ç­‰çº§æå‡ï¼ATK+1 / HP+2','msg.downed':'å€’ä¸‹â€¦ {s} ç§’åå¤æ´»','msg.revive':'å·²å¤æ´»ï¼','msg.boss_spawn':'Bosså‡ºç°ï¼ç¬¬ä¸€å‡»å¼€å§‹è®¡æ—¶','msg.tap_to_start':'ç‚¹å‡»å¼€å§‹æˆ˜æ–—','msg.killed_many':'å‡»è´¥äº† {n} ä¸ªæ•Œäººï¼','msg.drop':'æ‰è½ï¼š{text}','msg.special_drop':'ç‰¹åˆ«æ‰è½ï¼š{text}'
  }
};

function t(key, params){ const lang=state.lang||'ja'; let s=(I18N[lang]&&I18N[lang][key])||(I18N['ja'][key]||key); if(params){ for(const k in params){ s=s.replace(new RegExp('\\{'+k+'\\}','g'), params[k]); } } return s; }
function applyI18n(){ document.documentElement.lang=state.lang||'ja';
  // Simple text nodes with data-i18n
  $$('[data-i18n]').forEach(el=>{ el.innerHTML=t(el.getAttribute('data-i18n')); });
  // Placeholders
  $$('[data-i18n-ph]').forEach(el=>{ el.setAttribute('placeholder', t(el.getAttribute('data-i18n-ph')) ); });
  // Wraps where key sits on label part
  $$('[data-i18n-wrap]').forEach(el=>{
    const key=el.getAttribute('data-i18n-wrap'); const txt=t(key); // keep inner HTML (values)
    const html=el.innerHTML; // try to replace leading label before value tags
    // Strategy: find first <b> or <span id> and insert label before it
    const child=el.querySelector('b, span[id], input, select, textarea');
    if(child){ const before=txt; // label
      el.innerHTML=''; const label=document.createElement('span'); label.textContent=before; el.appendChild(label); el.appendChild(document.createTextNode(' ')); el.appendChild(child); }
    else { el.textContent=txt+' '+el.textContent; }
  });
  // Toggle button text
  const toggle=ui.toggleInfo; if(toggle){ const open=toggle.getAttribute('aria-expanded')==='true'; toggle.textContent=open?t('ui.more_close'):t('ui.more'); }
  // Footnote
  const foot=$('#footnoteBoss'); if(foot) foot.innerHTML=t('foot.boss');
  // Continue chooser buttons likely already updated
}

// ====== Game State
const state={
  gold:0, level:1, exp:0, expToNext:20,
  floor:1, maxFloor:1, bestMaxFloor:1,
  kills:0, deaths:0,
  baseATK:1, baseHP:10, baseDEF:0, baseCRIT:5,
  autoTap:0,
  eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:false,
  monster:null, playerHP:10, bossEndsAt:0,
  souls:0, isDown:false, engaged:false, reviveAt:0, stay:false,
  pebbles:0, magicStones:0,
  upg:{atk:0,hp:0,auto:0},
  unlocks:{kashiwa:false},
  relicActive:{kashiwa:false},
  flavorIdx:0,
  lang:'ja', username:'', lastSeenVersion:GAME_VERSION
};
const prices={atk:10,hp:10,auto:25};

// ====== UI refs (short)
const ui={
  startOverlay:$('#startOverlay'), verText:$('#verText'), saveDetect:$('#saveDetect'),
  startLangFab:$('#startLangFab'), startLangPanel:$('#startLangPanel'), startLang:$('#startLang'), startLangApply:$('#startLangApply'),
  btnContinue:$('#btnContinue'), continueChooser:$('#continueChooser'), btnFromLocal:$('#btnFromLocal'), btnFromFile:$('#btnFromFile'), fileOpenStart:$('#fileOpenStart'),
  btnNewGame:$('#btnNewGame'), newWrap:$('#newWrap'), startName:$('#startName'), btnBegin:$('#btnBegin'), btnCancelNew:$('#btnCancelNew'), startNote:$('#startNote'),
  c_gold:$('#c-gold'), c_level:$('#c-level'), c_exp:$('#c-exp'), x_floor:$('#x-floor'), x_level:$('#x-level'), x_exp:$('#x-exp'), x_hpbar:$('#x-hpbar'), x_hptext:$('#x-hptext'), x_atk:$('#x-atk'), x_gold:$('#x-gold'), x_souls:$('#x-souls'), x_crit:$('#x-crit'), timerAll:$('#timerAll'), toggleInfo:$('#toggleInfo'), topCollapsed:$('#top-collapsed'), topExpanded:$('#top-expanded'),
  floorBadge:$('#floorBadge'), monsterFace:$('#monsterFace'), monsterHP:$('#monsterHP'), monsterHPText:$('#monsterHPText'), monsterName:$('#monsterName'), attackBtn:$('#attackBtn'), logline:$('#logline'),
  nextBtn:$('#nextBtn'), fleeBtn:$('#fleeBtn'), floorHint:$('#floorHint'), stayCb:$('#stayCb'),
  tabs:$$('.tab'), tabUpg:$('#tab-upg'), tabInv:$('#tab-inv'), tabSta:$('#tab-sta'), tabAdv:$('#tab-adv'), tabSettings:$('#tab-settings'),
  costAtk:$('#costAtk'), costHP:$('#costHP'), costAuto:$('#costAuto'), buyAtk:$('#buyAtk'), buyHP:$('#buyHP'), buyAuto:$('#buyAuto'), autoRate:$('#autoRate'), upgGold:$('#upgGold'), lvAtk:$('#lvAtk'), lvHP:$('#lvHP'), lvAuto:$('#lvAuto'),
  invList:$('#invList'), eqWeapon:$('#eq-weapon'), eqArmor:$('#eq-armor'), eqRing:$('#eq-ring'), autoEquip:$('#autoEquip'),
  staAtk:$('#sta-atk'), staHP:$('#sta-hp'), staDef:$('#sta-def'), staCrit:$('#sta-crit'), staGoldB:$('#sta-goldb'), staSoulB:$('#sta-soulb'), staMaxFloor:$('#sta-maxfloor'), staKills:$('#sta-kills'), staDeaths:$('#sta-deaths'), staAutoTap:$('#sta-autotap'), staItemDrop:$('#sta-itemdrop'), staMimic:$('#sta-mimic'), staSuperMimic:$('#sta-supermimic'), staStoneDrop:$('#sta-stonedrop'), staStoneAmt:$('#sta-stoneamt'),
  bagGold:$('#bag-gold'), bagSoul:$('#bag-soul'), bagGem:$('#bag-gem'), bagPeb:$('#bag-peb'), bagEq:$('#bag-eq'),
  relicLockedCard:$('#relicLockedCard'), relicKashiwaCard:$('#relicKashiwaCard'), relicKashiwa:$('#relicKashiwa'),
  ascendBtn:$('#ascendBtn'), soulGain:$('#soulGain'),
  codeInput:$('#codeInput'), codeBtn:$('#codeBtn'), codeStatus:$('#codeStatus'),
  exportName:$('#exportName'), downloadBtn:$('#downloadBtn'),
  importFileBtn:$('#importFileBtn'), fileOpenSettings:$('#fileOpenSettings'),
  wipeBtn:$('#wipeBtn'), langSelect:$('#langSelect'), langSave:$('#langSave'), nameEdit:$('#nameEdit'), nameSave:$('#nameSave')
};

// ====== Utils
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function choice(a){return a[randInt(0,a.length-1)]}
function weightedPick(items){const t=items.reduce((s,i)=>s+i.weight,0);let r=Math.random()*t;for(const it of items){r-=it.weight;if(r<=0)return it}return items[items.length-1]}
function soulMG(){return 1+state.souls*0.02}
function recalcMaxHP(){const armorHP=state.eq.armor?.hp??0;return Math.max(1,state.baseHP+armorHP)}
function playerATK(){const w=state.eq.weapon?.atk??0,r=state.eq.ring?.atk??0;return Math.max(1,Math.floor((state.baseATK+w+r)*soulMG()))}
function playerDEF(){return state.baseDEF+(state.eq.armor?.def??0)}
function playerCRIT(){return clamp(state.baseCRIT+(state.eq.ring?.crit??0),0,100)}
function goldB(){const rg=state.eq.ring?.goldB??0;return rg+(soulMG()-1)*100}
function clickDamage(){const c=Math.random()*100<playerCRIT();let d=playerATK();if(c)d=Math.floor(d*1.8);return{dmg:d,isCrit:c}}
function eHP(f,b){return Math.floor((14*Math.pow(f,1.18)+6)*(b?6:1))}
function eGold(f,b){return Math.floor((4*Math.pow(f,1.10)+2)*(b?4:1))}
function eATK(f,b){return Math.floor((1.2*Math.pow(f,1.05)+0.6)*(b?2:1))}
function cryptoId(){const a=new Uint32Array(2);(window.crypto||window.msCrypto).getRandomValues?.(a);return[...a].map(x=>x.toString(16)).join('')}

// ====== Items
const RARITIES=[{name:'Common',color:'rar-Common',weight:60,mult:1},{name:'Uncommon',color:'rar-Uncommon',weight:25,mult:1.4},{name:'Rare',color:'rar-Rare',weight:10,mult:2},{name:'Epic',color:'rar-Epic',weight:4,mult:3},{name:'Legendary',color:'rar-Legendary',weight:1,mult:4.5}];
function makeItem(f, minRarity){
  const kinds=['weapon','armor','ring']; const k=choice(kinds); const rar=weightedPick(RARITIES);
  const order={'Common':0,'Uncommon':1,'Rare':2,'Epic':3,'Legendary':4};
  let rarName=rar.name; if(minRarity && order[rarName]<order[minRarity]) rarName=minRarity;
  const mult=RARITIES.find(r=>r.name===rarName).mult; const bp=Math.max(1,Math.floor((Math.pow(f,1.12)+randInt(0,f))*0.5*mult));
  const it={id:cryptoId(),name:'',slot:k,rarity:rarName,color:RARITIES.find(r=>r.name===rarName).color,lvl:f,value:Math.max(1,Math.floor(bp*1.2))};
  if(k==='weapon'){it.atk=Math.max(1,Math.floor(bp)); if(rarName!=='Common'&&Math.random()<0.35) it.crit=2+Math.floor(mult*2); it.name=`æ­¦å™¨ +${it.atk}`}
  else if(k==='armor'){it.hp=4*Math.max(1,Math.floor(bp*0.9)); if(rarName!=='Common'&&Math.random()<0.3) it.def=Math.floor(mult*1.2); it.name=`é§ +${it.hp}HP`}
  else{const r=Math.random(); if(r<0.45){it.crit=3+Math.floor(mult*2); it.name=`æŒ‡è¼ª ã‚¯ãƒª+${it.crit}%`} else if(r<0.9){it.atk=Math.max(1,Math.floor(bp*0.6)); it.name=`æŒ‡è¼ª ATK+${it.atk}`} else{it.goldB=5+Math.floor(mult*4); it.name=`æŒ‡è¼ª Gold+${it.goldB}%`}}
  it.name+=` (${rarName})`; return it;
}
function renderItemText(it){const p=[];if(it.atk)p.push(`ATK+${it.atk}`);if(it.hp)p.push(`HP+${it.hp}`);if(it.def)p.push(`é˜²å¾¡+${it.def}`);if(it.crit)p.push(`ã‚¯ãƒª+${it.crit}%`);if(it.goldB)p.push(`Gold+${it.goldB}%`);return `${it.name} [${p.join(', ')}]`}
function scoreItem(it){if(!it)return-1e9;let s=0;s+=(it.atk??0)*3+(it.hp??0)*0.4+(it.def??0)*2+(it.crit??0)*1.5+(it.goldB??0)*0.8;s+=(it.lvl??0)*0.2;const rar=RARITIES.find(r=>r.name===it.rarity);s*=rar?.mult??1;return s}
function tryAutoEquip(it){const s=it.slot,cur=state.eq[s];if(scoreItem(it)>scoreItem(cur)){state.eq[s]=it;toast(tr('msg.drop',{text:renderItemText(it)}))}}

// ====== Monsters
const MONSTER_POOL=[{name:'ã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸ‘¹'},{name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',emoji:'ğŸ’€'},{name:'ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸ¦‡'},{name:'ã‚ªã‚ªã‚«ãƒŸ',emoji:'ğŸº'},{name:'ã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸ«§'},{name:'ãƒŸã‚¤ãƒ©',emoji:'ğŸ§»'},{name:'é­”å°æ›¸',emoji:'ğŸ“•'},{name:'ç›®ç‰',emoji:'ğŸ‘ï¸'},{name:'ã‚µã‚½ãƒª',emoji:'ğŸ¦‚'}];
const BOSS_POOL=[{name:'ã‚ªãƒ¼ã‚¬',emoji:'ğŸ‘º'},{name:'ãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ²'},{name:'ãƒªãƒƒãƒ',emoji:'ğŸª¦'},{name:'ã‚±ãƒ«ãƒ™ãƒ­ã‚¹',emoji:'ğŸ¶'}];
function spawnMonster(){
  const f=state.floor,boss=(f%10===0),pool=boss?BOSS_POOL:MONSTER_POOL,base=choice(pool);
  const crit=playerCRIT(); const mimicP=Math.min(0.15,0.05+crit*0.0005); const superP=Math.min(0.05,0.02+crit*0.0003);
  let kind='normal'; const r=Math.random(); if(r<superP) kind='supermimic'; else if(r<superP+mimicP) kind='mimic';
  const hp0=eHP(f,boss), gold0=eGold(f,boss), atk0=eATK(f,boss);
  let mult=1, namePrefix='', emoji=base.emoji; if(kind==='mimic'){mult=1.05; namePrefix='ã€ãƒŸãƒŸãƒƒã‚¯ã€‘'; emoji='ğŸ§°'} if(kind==='supermimic'){mult=1.20; namePrefix='ã€è¶…ãƒŸãƒŸãƒƒã‚¯ã€‘'; emoji='âœ¨ğŸ§°'}
  const hp=Math.floor(hp0*mult), gold=gold0, atk=Math.floor(atk0*mult);
  state.monster={name:`${namePrefix}${boss?'ã€BOSSã€‘':''}Lv${f} ${base.name}`, emoji, hp, maxHP:hp, gold, atk, isBoss:boss, kind};
  state.engaged=false; state.isDown=false; state.reviveAt=0; state.bossEndsAt=0;
  ui.monsterFace.textContent=emoji; ui.monsterName.textContent=state.monster.name; ui.monsterHPText.textContent=`${hp} / ${hp}`; ui.monsterHP.style.width='100%'; ui.floorBadge.innerHTML=`${t('ui.floor')} ${state.floor}`;
  ui.logline.innerHTML=boss?t('msg.boss_spawn'):t('msg.tap_to_start');
  refreshFloorButtons(); updateAttackBtn();
}

// ====== Rewards
function awardKill(){
  const m=state.monster;
  if(Math.random()<0.05){ const k=Math.floor(state.floor/10); if(k>0){ state.pebbles+=k; toast(`+${k}`); }}
  const goldMult=(m.kind==='mimic')?10:(m.kind==='supermimic')?100:1;
  const expBase=Math.max(1,Math.floor(3+state.floor*0.6)); const expGain=expBase*goldMult;
  const goldGain=Math.floor(m.gold*goldMult*(1+goldB()/100));
  state.gold+=goldGain; state.kills+=1; state.exp+=expGain;
  while(state.exp>=state.expToNext){ state.exp-=state.expToNext; state.level+=1; state.expToNext=Math.floor(state.expToNext*1.25+8); state.baseATK+=1; state.baseHP+=2; ui.logline.textContent=t('msg.levelup'); }
  if(m.kind==='mimic'||m.kind==='supermimic'){
    const minR=(m.kind==='mimic')?'Rare':'Epic'; const it=makeItem(state.floor,minR); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); toast(t('msg.special_drop',{text:renderItemText(it)}));
  }else{
    const luck=(state.eq.ring?.goldB??0)*0.2; const drop=0.20+luck/100; if(Math.random()<drop){ const it=makeItem(state.floor); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); toast(t('msg.drop',{text:renderItemText(it)})); } else { toast(`+${goldGain}G / +${expGain}EXP`); }
  }
  if(state.floor>state.maxFloor)state.maxFloor=state.floor; if(state.maxFloor>state.bestMaxFloor)state.bestMaxFloor=state.maxFloor;
}

// ====== Messages
function postKillFlavor(kills){ if(kills>=2){ ui.logline.textContent = t('msg.killed_many',{n:kills}); } }
function toast(m){ ui.logline.textContent=m }

// ====== Combat
function updateAttackBtn(){const m=state.monster;if(!m){ui.attackBtn.textContent=t('battle.attack');return}const expected=playerATK();if(!state.engaged){ ui.attackBtn.textContent=(expected>=m.hp)?t('battle.kill'):t('battle.start'); return } ui.attackBtn.textContent=(expected>=m.hp)?t('battle.kill'):t('battle.tap'); }
function refreshFloorButtons(){const canUpByBest=state.floor<state.bestMaxFloor;const dead=state.monster&&state.monster.hp<=0; ui.nextBtn.disabled=!(dead||canUpByBest); ui.floorHint.textContent=t('floor.best',{n:state.bestMaxFloor}); }
function beginEngage(){ if(!state.engaged){ state.engaged=true; if(state.monster.isBoss&&state.bossEndsAt===0){ state.bossEndsAt=Date.now()+30000; } } }
function doSingleKillAndAdvance(){ awardKill(); if(state.stay){ spawnMonster(); } else { state.floor+=1; spawnMonster(); } }
function attack(){ if(!state.monster) return; if(state.playerHP<=0){ toast('â€¦'); return; } beginEngage(); const m=state.monster; if(m.hp<=0) return; if(state.relicActive.kashiwa){ const atk=playerATK(); if(atk>m.hp){ let kills=0,remaining=atk,curHP=m.hp; if(remaining>=curHP){remaining-=curHP;kills+=1} const unit=m.maxHP; if(unit>0&&remaining>0){ kills+=Math.floor(remaining/unit); } for(let i=0;i<kills;i++){ doSingleKillAndAdvance(); } postKillFlavor(kills); updateAttackBtn(); refreshFloorButtons(); return; }} const {dmg,isCrit}=clickDamage(); const dealt=Math.min(m.hp,dmg); m.hp-=dealt; ui.monsterHP.style.width=`${(m.hp/m.maxHP)*100}%`; ui.monsterHPText.textContent=`${m.hp} / ${m.maxHP}`; ui.logline.textContent=isCrit?`CRIT! -${dealt}`:`-${dealt}`; if(m.hp<=0){ doSingleKillAndAdvance(); } updateAttackBtn(); refreshFloorButtons(); }
function enemyTick(dt){ if(!state.monster||!state.engaged||state.isDown)return; const m=state.monster; if(m.hp<=0)return; const dps=Math.max(0,m.atk-playerDEF()*0.6); const dmg=dps*dt; if(dmg<=0)return; state.playerHP-=dmg; if(state.playerHP<=0&&!state.isDown){ state.playerHP=0; state.isDown=true; state.deaths+=1; state.reviveAt=Date.now()+5000; ui.logline.textContent=t('msg.downed',{s:5}); } }
function regenTick(dt){ if(state.playerHP>0){ const mx=recalcMaxHP(); state.playerHP=clamp(state.playerHP+dt*(0.8+state.level*0.02),0,mx); } }
function autoTapTick(dt){ if(state.autoTap<=0||!state.engaged||state.isDown) return; autoTapTick._acc=(autoTapTick._acc||0)+state.autoTap*dt; while(autoTapTick._acc>=1){ autoTapTick._acc-=1; attack(); } }
function timersTick(){ let txt=[]; if(state.reviveAt>0){ const left=Math.max(0,state.reviveAt-Date.now()); txt.push(t('msg.revive_in')||t('msg.downed',{s:Math.ceil(left/1000)})); if(left<=0){ state.reviveAt=0; state.playerHP=recalcMaxHP(); state.isDown=false; state.engaged=false; ui.logline.textContent=t('msg.revive'); updateAttackBtn(); } } if(state.bossEndsAt>0){ const left=Math.max(0,state.bossEndsAt-Date.now()); txt.push(`${Math.ceil(left/1000)}s`); if(left<=0){ state.bossEndsAt=0; toast('â€¦'); state.floor=Math.max(1,state.floor-1); spawnMonster(); } } ui.timerAll.textContent=txt.join(' / '); }

// ====== Save / Load
function save(manual=false){ const data=JSON.stringify({state:{...state,bossEndsAt:state.bossEndsAt>0?Date.now()+Math.max(0,state.bossEndsAt-Date.now()):0,reviveAt:state.reviveAt>0?Date.now()+Math.max(0,state.reviveAt-Date.now()):0},prices}); localStorage.setItem(SAVE_KEY,data); if(manual) toast(t('msg.saved')); }
function load(manual=false){ const raw=localStorage.getItem(SAVE_KEY); if(!raw){ if(manual) toast(t('msg.no_save')); return false } try{ const o=JSON.parse(raw); Object.assign(state,o.state); Object.assign(prices,o.prices||{}); state.upg=state.upg||{atk:0,hp:0,auto:0}; state.unlocks=state.unlocks||{kashiwa:false}; state.relicActive=state.relicActive||{kashiwa:false}; state.lang=state.lang||'ja'; state.username=state.username||''; state.lastSeenVersion=state.lastSeenVersion||GAME_VERSION; state.playerHP=clamp(state.playerHP,0,recalcMaxHP()); ui.autoEquip&&(ui.autoEquip.checked=!!state.autoEquip); ui.stayCb&&(ui.stayCb.checked=!!state.stay); renderInventory(); updateUI(); if(manual) toast(t('msg.loaded')); return true }catch(e){ console.error(e); toast('Load failed'); return false } }
function importSaveFromText(raw){ try{ JSON.parse(raw); localStorage.setItem(SAVE_KEY, raw); return load(false); }catch(e){ toast('JSON error'); return false } }

// ====== Inventory render
function renderInventory(){ const box=ui.invList; if(!box) return; box.innerHTML=''; for(const it of state.inv){ const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div><b class="${it.color}">${it.name}</b></div><div class="small">${renderItemText(it)}</div>`; const row=document.createElement('div'); row.className='row'; const e=document.createElement('button'); e.className='btn'; e.textContent='è£…å‚™'; e.onclick=()=>{ state.eq[it.slot]=it; toast(`è£…å‚™ï¼š${renderItemText(it)}`); updateUI(); }; const s=document.createElement('button'); s.className='btn gold'; s.textContent=`å£²å´ (+${Math.floor(it.value)}G)`; s.onclick=()=>{ state.gold+=Math.floor(it.value); state.inv=state.inv.filter(x=>x!==it); renderInventory(); updateUI(); }; row.appendChild(e); row.appendChild(s); div.appendChild(row); box.appendChild(div); } }

// ====== File import helpers
function openFileInput(el){ el.value=''; el.click(); }
function readFileAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsText(file,'utf-8'); }); }
async function handleFileChosen(file){ if(!file) return; try{ const txt=await readFileAsText(file); if(importSaveFromText(txt)){ ui.startOverlay.hidden=true; requestAnimationFrame(loop); } }catch(e){ toast('IO error'); }}

// ====== Persistence actions
function wipeAll(){ if(!confirm('OK?'))return; localStorage.removeItem(SAVE_KEY); resetStateToDefault(); showStart(true); }
function resetStateToDefault(){ Object.assign(state,{ gold:0, level:1, exp:0, expToNext:20, floor:1, maxFloor:1, bestMaxFloor:1, kills:0, deaths:0, baseATK:1, baseHP:10, baseDEF:0, baseCRIT:5, autoTap:0, eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:false, monster:null, playerHP:10, bossEndsAt:0, souls:0, isDown:false, engaged:false, reviveAt:0, stay:false, pebbles:0, magicStones:0, upg:{atk:0,hp:0,auto:0}, unlocks:{kashiwa:false}, relicActive:{kashiwa:false}, flavorIdx:0, lang:state.lang||'ja', username:'', lastSeenVersion:GAME_VERSION }); renderInventory(); updateUI(); }

function ascend(){ const g=Math.floor(state.maxFloor/30); if(g<=0){ toast('â€¦'); return } if(!confirm('Ascend?'))return; state.souls+=g; state.magicStones+=state.pebbles; state.pebbles=0; const keepBest=Math.max(state.bestMaxFloor,state.maxFloor), keepSouls=state.souls; Object.assign(state,{ gold:0,level:1,exp:0,expToNext:20,floor:1,maxFloor:1,kills:0,deaths:0, baseATK:1,baseHP:10,baseDEF:0,baseCRIT:5, autoTap:0, eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:state.autoEquip, monster:null, playerHP:10,bossEndsAt:0, souls:keepSouls, bestMaxFloor:keepBest, isDown:false, engaged:false, reviveAt:0, stay:state.stay, pebbles:0, magicStones:state.magicStones, upg:state.upg, unlocks:state.unlocks, relicActive:state.relicActive, lang:state.lang, username:state.username, lastSeenVersion:GAME_VERSION }); prices.atk=10; prices.hp=10; prices.auto=25; spawnMonster(); updateUI(); renderInventory(); toast('OK'); }

// ====== Code redemption
ui.codeBtn.addEventListener('click',()=>{ const code=(ui.codeInput.value||'').trim(); if(!code){ ui.codeStatus.textContent=t('code.ph'); return } if(code==='kashiwa060925'){ if(state.unlocks.kashiwa){ ui.codeStatus.textContent='USED'; return } state.unlocks.kashiwa=true; ui.codeStatus.textContent='OK'; updateUI(); save(false) } else { ui.codeStatus.textContent='NG'; } });
ui.relicKashiwa&&ui.relicKashiwa.addEventListener('change',e=>{ state.relicActive.kashiwa=e.target.checked; save(false) });

// ====== Tabs
ui.tabs.forEach(t=>{ t.addEventListener('click',()=>{ ui.tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const id=t.dataset.tab; [ui.tabUpg,ui.tabInv,ui.tabSta,ui.tabAdv,ui.tabSettings].forEach(el=>el.setAttribute('hidden','')); document.getElementById(id).removeAttribute('hidden') }) });

// ====== Buttons & Inputs
let _holding=false,_t=0,_saw=false; function onPD(e){ e.preventDefault(); _saw=true; _t=Date.now(); if(_holding) return; _holding=true; attack(); } function onPU(){ _holding=false }
function bindInput(el){ if(window.PointerEvent){ el.addEventListener('pointerdown',onPD,{passive:false}); el.addEventListener('pointerup',onPU); el.addEventListener('pointercancel',onPU); el.addEventListener('pointerleave',onPU); } else { el.addEventListener('click',()=>{ if(_saw && Date.now()-_t<200) return; attack(); }); } }
bindInput($('#attackBtn')); bindInput($('#monster'));
document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});
ui.nextBtn.addEventListener('click',()=>{ const canUpByBest=state.floor<state.bestMaxFloor; const dead=state.monster && state.monster.hp<=0; if(!(dead||canUpByBest)){ toast(t('msg.cant_advance')); return } state.floor+=1; state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI() });
ui.fleeBtn.addEventListener('click',()=>{ state.floor=Math.max(1,state.floor-1); state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI() });
ui.stayCb.addEventListener('change',e=>{ state.stay=e.target.checked; save(false) });
ui.buyAtk.addEventListener('click',()=>buy('atk',()=>{ state.baseATK+=1; state.upg.atk++; updateAttackBtn() }));
ui.buyHP.addEventListener('click',()=>buy('hp',()=>{ state.baseHP+=5; state.upg.hp++; state.playerHP=recalcMaxHP() }));
ui.buyAuto.addEventListener('click',()=>buy('auto',()=>{ state.autoTap=parseFloat((state.autoTap+0.2).toFixed(1)); state.upg.auto++; }));
ui.autoEquip&&ui.autoEquip.addEventListener('change',e=>{ state.autoEquip=e.target.checked; save(false) });

ui.downloadBtn&&ui.downloadBtn.addEventListener('click',()=>{ save(false); const raw=localStorage.getItem(SAVE_KEY)||''; const name=((ui.exportName.value||defaultDownloadName())+'.json').replace(/\s+/g,'_'); const blob=new Blob([raw],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); toast(t('msg.save_exported')); });
ui.importFileBtn&&ui.importFileBtn.addEventListener('click',()=>openFileInput(ui.fileOpenSettings));
ui.fileOpenSettings&&ui.fileOpenSettings.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) handleFileChosen(f); });
ui.wipeBtn&&ui.wipeBtn.addEventListener('click',wipeAll);
ui.langSave&&ui.langSave.addEventListener('click',()=>{ state.lang=ui.langSelect.value||'ja'; save(true); applyI18n(); updateUI(); });
ui.nameSave&&ui.nameSave.addEventListener('click',()=>{ const v=(ui.nameEdit.value||'').trim(); if(!v){ ui.startNote.textContent=t('msg.need_name'); return } state.username=v; save(true); });

// Start overlay events
ui.startLangFab.addEventListener('click',()=>{ const open=ui.startLangPanel.classList.toggle('open'); ui.startLangFab.setAttribute('aria-expanded', String(open)); ui.startLangPanel.setAttribute('aria-hidden', String(!open)); });
ui.startLangApply.addEventListener('click',()=>{ const v=ui.startLang.value||'ja'; state.lang=v; save(false); applyI18n(); });
ui.btnContinue.addEventListener('click',()=>{ ui.continueChooser.hidden = !ui.continueChooser.hidden; });
ui.btnFromLocal.addEventListener('click',()=>{ if(!load(false)){ ui.startNote.textContent=t('msg.no_save'); return } ui.startOverlay.hidden=true; requestAnimationFrame(loop); });
ui.btnFromFile.addEventListener('click',()=>openFileInput(ui.fileOpenStart));
ui.fileOpenStart.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) handleFileChosen(f); });
ui.btnNewGame.addEventListener('click',()=>{ ui.newWrap.hidden=false; ui.startName.focus(); });
ui.btnCancelNew.addEventListener('click',()=>{ ui.newWrap.hidden=true; });
ui.btnBegin.addEventListener('click',()=>{ const lang=ui.startLang.value||'ja'; const uname=(ui.startName.value||'').trim(); if(!uname){ ui.startNote.textContent=t('msg.need_name'); return } Object.assign(state,{lang,username:uname,lastSeenVersion:GAME_VERSION}); spawnMonster(); renderInventory(); updateUI(); save(false); applyI18n(); ui.startOverlay.hidden=true; requestAnimationFrame(loop); });

// ====== Helpers
function defaultDownloadName(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); const ts=`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}`; const uname=(state.username||'User'); return `save-${uname}-${ts}` }
function showStart(){ ui.verText.textContent=GAME_VERSION; const exist=!!localStorage.getItem(SAVE_KEY); ui.saveDetect.textContent=exist?t('common.ok'):'â€”'; ui.startOverlay.hidden=false; }
function applyCollapsed(col){ if(col){ ui.topCollapsed.removeAttribute('hidden'); ui.topExpanded.setAttribute('hidden',''); ui.toggleInfo.setAttribute('aria-expanded','false'); ui.toggleInfo.textContent=t('ui.more'); } else { ui.topCollapsed.setAttribute('hidden',''); ui.topExpanded.removeAttribute('hidden'); ui.toggleInfo.setAttribute('aria-expanded','true'); ui.toggleInfo.textContent=t('ui.more_close'); } localStorage.setItem(UI_MODE,col?'1':'0') }
ui.toggleInfo.addEventListener('click',()=>{ const col=ui.toggleInfo.getAttribute('aria-expanded')==='true'; applyCollapsed(col) });

// ====== Loop & init
let last=performance.now(); function loop(now){ const dt=Math.min(0.1,(now-last)/1000); last=now; autoTapTick(dt); enemyTick(dt); regenTick(dt); timersTick(); updateUI(); requestAnimationFrame(loop) }
function updateUI(){ ui.c_gold.textContent=Math.floor(state.gold); ui.c_level.textContent=state.level; ui.c_exp.textContent=`${state.exp}/${state.expToNext}`; ui.x_floor.textContent=state.floor; ui.x_level.textContent=state.level; ui.x_exp.textContent=`${state.exp}/${state.expToNext}`; ui.x_atk.textContent=playerATK(); ui.x_gold.textContent=Math.floor(state.gold); ui.x_souls.textContent=state.souls; ui.x_crit.textContent=`${Math.floor(playerCRIT())}%`; const mx=recalcMaxHP(); const pct=clamp(state.playerHP/mx*100,0,100); ui.x_hpbar.style.width=`${pct}%`; ui.x_hptext.textContent=`${Math.floor(state.playerHP)}/${mx}`; ui.upgGold.textContent=Math.floor(state.gold); ui.lvAtk.textContent=state.upg.atk; ui.lvHP.textContent=state.upg.hp; ui.lvAuto.textContent=state.upg.auto; ui.autoRate.textContent=state.autoTap.toFixed(1); ui.costAtk.textContent=prices.atk; ui.costHP.textContent=prices.hp; ui.costAuto.textContent=prices.auto; if(ui.staAtk){ ui.staAtk.textContent=playerATK(); ui.staHP.textContent=recalcMaxHP(); ui.staDef.textContent=playerDEF(); ui.staCrit.textContent=`${Math.floor(playerCRIT())}%`; ui.staGoldB.textContent=`${Math.floor(goldB())}%`; ui.staSoulB.textContent=`${Math.floor((soulMG()-1)*100)}%`; ui.staMaxFloor.textContent=state.maxFloor; ui.staKills.textContent=state.kills; ui.staDeaths.textContent=state.deaths; ui.staAutoTap.textContent=state.autoTap.toFixed(1); ui.staItemDrop.textContent=`${(getItemDrop()*100).toFixed(1)}%`; ui.staMimic.textContent=`${(getMimicP()*100).toFixed(2)}%`; ui.staSuperMimic.textContent=`${(getSuperMimicP()*100).toFixed(2)}%`; ui.staStoneDrop.textContent='5%'; ui.staStoneAmt.textContent=Math.floor(state.floor/10); }
  ui.bagGold.textContent=Math.floor(state.gold); ui.bagSoul.textContent=state.souls; ui.bagGem.textContent=state.magicStones; ui.bagPeb.textContent=state.pebbles; ui.bagEq.textContent=state.inv.length; ui.floorBadge.innerHTML=`${t('ui.floor')} ${state.floor}`; if(state.unlocks.kashiwa){ ui.relicLockedCard.setAttribute('hidden',''); ui.relicKashiwaCard.removeAttribute('hidden'); ui.relicKashiwa.checked=!!state.relicActive.kashiwa; } else { ui.relicLockedCard.removeAttribute('hidden'); ui.relicKashiwaCard.setAttribute('hidden',''); } const gain=Math.floor(state.maxFloor/30); ui.soulGain && (ui.soulGain.textContent=gain); ui.langSelect && (ui.langSelect.value=state.lang); ui.nameEdit && (ui.nameEdit.value=state.username||''); }
function getItemDrop(){ const luck=(state.eq.ring?.goldB??0)*0.2; return 0.20 + luck/100 }
function getMimicP(){ const crit=playerCRIT(); return Math.min(0.15, 0.05 + crit*0.0005) }
function getSuperMimicP(){ const crit=playerCRIT(); return Math.min(0.05, 0.02 + crit*0.0003) }

(function init(){ applyCollapsed(localStorage.getItem(UI_MODE)!=='0'); // always title first
  // attempt to load language from save
  try{ const raw=localStorage.getItem(SAVE_KEY); if(raw){ const o=JSON.parse(raw); if(o?.state?.lang) state.lang=o.state.lang; if(o?.state?.username) state.username=o.state.username; } }catch(e){}
  applyI18n(); updateUI(); showStart(); window.addEventListener('beforeunload',()=>save(false)); })();
</script>
</body>
</html>