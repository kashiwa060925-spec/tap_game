<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPGï¼ˆHTMLä¸€æšï¼ã‚¿ãƒƒãƒ—å°‚ç”¨ï¼‰</title>
<style>
  :root{--c-bg:#0f1220;--c-panel:#171a2b;--c-accent:#7cd2ff;--c-text:#e8eefc;--c-sub:#aab6d6;--c-danger:#ff6b6b;--c-gold:#ffd76a}
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%;touch-action:manipulation}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0d1120,#0b1021 50%,#0e0f1a);color:var(--c-text);-webkit-tap-highlight-color:transparent}
  [hidden]{display:none !important}
  header{position:sticky;top:0;z-index:3;background:#0d1120cc;backdrop-filter:blur(6px);border-bottom:1px solid #1f2440;padding:.6rem .8rem}
  .topbar{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .pill{background:var(--c-panel);border:1px solid #232742;border-radius:12px;padding:.45rem .6rem;font-size:.92rem;color:var(--c-sub)}
  .bar{width:160px;height:12px;border-radius:8px;background:#101425;border:1px solid #283055;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2ddf7f,#67e3a3);width:100%}
  .small{font-size:.85rem;color:var(--c-sub)}
  .toggle{justify-self:end;background:#121639;border:1px solid #2a2f66;color:#c9d6ff;padding:.45rem .6rem;border-radius:10px}
  .toggle[aria-expanded='true']{background:#1a2053}
  main{max-width:1200px;margin:0 auto;padding:1rem}
  .layout{display:grid;grid-template-columns:1.2fr .9fr;gap:1rem}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:#171a2b;border:1px solid #222647;border-radius:14px;padding:1rem;box-shadow:0 8px 24px #00000045,inset 0 1px #2b3159}
  .monster{position:relative;display:grid;gap:.6rem;justify-items:center;text-align:center;padding:1rem;border-radius:12px;background:radial-gradient(80% 80% at 50% 30%, #141937, #101635);border:1px solid #202554;user-select:none}
  .floor-badge{position:absolute;left:.6rem;top:.6rem;background:#0f1536;border:1px solid #2a2f66;border-radius:10px;padding:.2rem .5rem;font-size:.85rem;color:#cfe0ff}
  .monster-emoji{font-size:76px;line-height:1}
  .hpbar{width:100%;height:18px;background:#0c1026;border:1px solid #2a2f5a;border-radius:10px;overflow:hidden}
  .hpbar>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ff9f6b);width:100%;transition:width .12s ease}
  .monster-info{display:flex;justify-content:space-between;width:100%;color:#aab6d6;font-weight:600}
  .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center}
  .btn{background:#0f1536;color:#cfe0ff;border:1px solid #2a2f66;padding:.8rem 1.1rem;border-radius:12px;cursor:pointer;min-width:44px;min-height:44px}
  .btn:hover{background:#121a43}
  .btn.gold{border-color:#6e5a25;background:#221b08;color:#ffd76a}
  .btn.danger{border-color:#6b2833;background:#2a0d14;color:#ffb0b0}
  .btn:disabled{opacity:.5;filter:grayscale(40%);cursor:not-allowed}
  .grid{display:grid;gap:.6rem}
  .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem}
  .tab{background:#121639;border:1px solid #2a2f66;padding:.7rem 1rem;border-radius:12px;cursor:pointer;color:#c9d6ff}
  .tab.active{background:#1a2053;outline:2px solid #6888ff66}
  .tab-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
  .inv-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.6rem}
  .card{background:#0f1433;border:1px solid #2a2f66;border-radius:10px;padding:.7rem;display:grid;gap:.35rem}
  .row{display:flex;justify-content:space-between;gap:.6rem;align-items:center;flex-wrap:wrap}
  .muted{color:var(--c-sub)}.warn{color:var(--c-danger)}.gold{color:var(--c-gold)}
  .footnote{margin-top:.8rem;color:#98a2c9;font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="wrap" id="top-collapsed">
      <div class="pill">ğŸ’° æ‰€æŒ <span class="gold"><b id="c-gold">0</b> G</span></div>
      <div class="pill">ğŸ§ Lv <b id="c-level">1</b></div>
      <div class="pill">ğŸ“ˆ EXP <b id="c-exp">0/20</b></div>
    </div>
    <button id="toggleInfo" class="toggle" aria-expanded="false" aria-controls="top-expanded">â–¼ è©³ç´°</button>
    <div class="wrap" id="top-expanded" hidden>
      <div class="pill">ğŸ§­ éšå±¤ <b id="x-floor">1</b></div>
      <div class="pill">ğŸ§ Lv <b id="x-level">1</b></div>
      <div class="pill">ğŸ“ˆ EXP <b id="x-exp">0/20</b></div>
      <div class="pill">â¤ï¸ HP <span class="bar"><span id="x-hpbar" style="width:100%"></span></span> <span class="small" id="x-hptext">10/10</span></div>
      <div class="pill">âš”ï¸ ATK <b id="x-atk">1</b></div>
      <div class="pill">ğŸ’° æ‰€æŒ <span class="gold"><b id="x-gold">0</b> G</span></div>
      <div class="pill">ğŸ”® ã‚½ã‚¦ãƒ« <b id="x-souls">0</b></div>
      <div class="pill">ğŸ¯ ã‚¯ãƒªç‡ <b id="x-crit">5%</b></div>
      <div class="pill"><span class="small" id="timerAll"></span></div>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <section class="panel">
      <div id="monster" class="monster" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ”»æ’ƒ">
        <div class="floor-badge" id="floorBadge">éšå±¤ 1</div>
        <div class="monster-emoji" id="monsterFace" aria-hidden="true">ğŸ‘ï¸</div>
        <div class="hpbar" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info"><span id="monsterName">Lv1 ã‚´ãƒ–ãƒªãƒ³</span><span id="monsterHPText">10 / 10</span></div>
        <div class="actions"><button class="btn" id="attackBtn">æˆ¦é—˜é–‹å§‹ï¼</button></div>
        <div class="small" id="logline" aria-live="polite"></div>
      </div>
      <div class="footnote">10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™30ç§’</span>ï¼‰ã€‚æ­»äº¡ã™ã‚‹ã¨5ç§’ã§è‡ªå‹•å¾©æ´»ï¼ˆå¾©æ´»å¾Œã¯ä¸€åº¦åœæ­¢ï¼‰ã€‚</div>
    </section>

    <section class="panel" id="panel-floor">
      <div class="grid">
        <div class="row"><b>ğŸ§­ éšå±¤ç§»å‹•</b><label class="small"><input type="checkbox" id="stayCb"> ã“ã®éšå±¤ã«ç•™ã¾ã‚‹</label></div>
        <div class="row">
          <button class="btn danger" id="fleeBtn">1éšæˆ»ã‚‹</button>
          <button class="btn gold" id="nextBtn" title="æœ€é«˜åˆ°é”éšå±¤ã¾ã§ã¯ä¸ŠãŒã‚Œã¾ã™">æ¬¡ã®éšå±¤ã¸</button>
        </div>
        <div class="small muted" id="floorHint"></div>
      </div>
    </section>

    <section class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="tab-upg">âš’ï¸ å¼·åŒ–</button>
        <button class="tab" data-tab="tab-inv">ğŸ›¡ï¸ è£…å‚™</button>
        <button class="tab" data-tab="tab-sta">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
        <button class="tab" data-tab="tab-relics">ğŸ”® è–éºç‰©</button>
        <button class="tab" data-tab="tab-sys">âš™ï¸ è¨­å®š/è»¢ç”Ÿ</button>
      </div>

      <div id="tab-upg" class="grid">
        <div class="tab-row"><div class="small muted">âš’ï¸ å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div><div class="small">ğŸ’° <b id="upgGold">0</b> G</div></div>
        <div class="card">
          <div class="row"><div><b>âš”ï¸ æ”»æ’ƒåŠ›å¼·åŒ–</b><div class="small muted">ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ </div></div><div class="gold"><b id="costAtk">10</b> G</div></div>
          <button class="btn" id="buyAtk">è³¼å…¥ (+1 ATK) / Lv <b id="lvAtk">0</b></button>
        </div>
        <div class="card">
          <div class="row"><div><b>â¤ï¸ æœ€å¤§HPå¼·åŒ–</b><div class="small muted">è€ä¹…ã‚’å¢—åŠ </div></div><div class="gold"><b id="costHP">10</b> G</div></div>
          <button class="btn" id="buyHP">è³¼å…¥ (+5 HP) / Lv <b id="lvHP">0</b></button>
        </div>
        <div class="card">
          <div class="row"><div><b>ğŸ¤– è‡ªå‹•ã‚¿ãƒƒãƒ—</b><div class="small muted">æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰</div></div><div class="gold"><b id="costAuto">25</b> G</div></div>
          <button class="btn" id="buyAuto">è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’) / Lv <b id="lvAuto">0</b></button>
          <div class="small muted">ç¾åœ¨ï¼š<b id="autoRate">0.0</b> ã‚¿ãƒƒãƒ—/ç§’</div>
        </div>
      </div>

      <div id="tab-inv" class="grid" hidden>
        <div class="card"><div><b>ğŸ›¡ï¸ è£…å‚™ä¸­</b></div><div class="small">æ­¦å™¨ï¼š<span id="eq-weapon">ãªã—</span></div><div class="small">é§ã€€ï¼š<span id="eq-armor">ãªã—</span></div><div class="small">æŒ‡è¼ªï¼š<span id="eq-ring">ãªã—</span></div></div>
        <div class="card"><div class="row"><b>ğŸ’ æ‰€æŒå“</b><label class="small"><input type="checkbox" id="autoEquip" /> å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™</label></div><div class="inv-list" id="invList"></div></div>
      </div>

      <div id="tab-sta" class="grid" hidden>
        <div class="card">
          <b>ğŸ“Š åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</b>
          <div class="small">ATKï¼š<b id="sta-atk">1</b></div>
          <div class="small">æœ€å¤§HPï¼š<b id="sta-hp">10</b></div>
          <div class="small">é˜²å¾¡ï¼š<b id="sta-def">0</b></div>
          <div class="small">ã‚¯ãƒªç‡ï¼š<b id="sta-crit">5%</b></div>
          <div class="small">ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š<b id="sta-goldb">0%</b></div>
          <div class="small">ã‚½ã‚¦ãƒ«è£œæ­£ï¼ˆæ’ä¹…ï¼‰ï¼š<b id="sta-soulb">0%</b></div>
          <div class="small">ğŸ”¹ è¼ãçŸ³ã“ã‚ï¼š<b id="sta-peb">0</b></div>
          <div class="small">ğŸ”® é­”çŸ³ï¼š<b id="sta-gem">0</b></div>
        </div>
        <div class="card"><b>ğŸ† æˆ¦ç¸¾</b><div class="small">æœ€é«˜åˆ°é”éšå±¤ï¼š<b id="sta-maxfloor">1</b></div><div class="small">è¨ä¼æ•°ï¼š<b id="sta-kills">0</b></div><div class="small">æ­»äº¡æ•°ï¼š<b id="sta-deaths">0</b></div></div>
      </div>

      <div id="tab-relics" class="grid" hidden>
        <div class="card" id="relicKashiwaCard" hidden>
          <div class="row"><b>ğŸƒ æŸã®åŠ è­·</b><label class="small"><input type="checkbox" id="relicKashiwa"> æœ‰åŠ¹åŒ–</label></div>
          <div class="small">åŠ¹æœï¼šã‚¿ãƒƒãƒ—æ™‚ã€ä¸ãˆãŸä¸€æ’ƒãŒæ•µHPã‚’è¶…ãˆãŸåˆ†ã ã‘<strong>è¤‡æ•°ä½“</strong>è¨ä¼ï¼ˆATKåŸºæº–ï¼‰ã€‚2ä½“ä»¥ä¸Šå€’ã™ã¨ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
        </div>
        <div class="card" id="relicLockedCard">
          <b>ğŸ”’ è–éºç‰©ï¼ˆæœªè§£æ”¾ï¼‰</b>
          <div class="small">è¨­å®šã‚¿ãƒ–ã®ã€ŒğŸŸï¸ ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆã€ã§å…¥æ‰‹ã§ãã¾ã™</div>
        </div>
      </div>

      <div id="tab-sys" class="grid" hidden>
        <div class="card">
          <b>ğŸŸï¸ ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆ</b>
          <div class="row"><input id="codeInput" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="flex:1;min-width:160px;background:#0b0f25;color:#cfe0ff;border:1px solid #2a2f66;border-radius:8px;padding:.5rem"/><button class="btn" id="codeBtn">å¼•ãæ›ãˆ</button></div>
          <div class="small muted" id="codeStatus"></div>
        </div>
        <div class="card">
          <b>ğŸ’¾ ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰</b>
          <div class="row"><button class="btn" id="saveBtn">ä¿å­˜</button><button class="btn" id="loadBtn">èª­è¾¼</button><button class="btn" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button><button class="btn" id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button><button class="btn danger" id="wipeBtn">å…¨å‰Šé™¤</button></div>
          <textarea id="ioArea" rows="4" style="width:100%; background:#0b0f25; color:#cfe0ff; border:1px solid #2a2f66; border-radius:8px; margin-top:.5rem" placeholder="ã“ã“ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™ï¼ˆæ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰"></textarea>
        </div>
        <div class="card"><b>ğŸŒ€ è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰</b><div class="small">è»¢ç”Ÿã§ <b>ğŸ”¹çŸ³ã“ã‚â†’ğŸ”®é­”çŸ³</b> ã¸å¤‰æ›ã€‚æ’ä¹…å¼·åŒ–ã«ä½¿ç”¨ï¼ˆæº–å‚™ä¸­ï¼‰ã€‚</div><div class="row"><div>ç²å¾—è¦‹è¾¼ã¿ï¼š<b id="soulGain">0</b> ã‚½ã‚¦ãƒ«</div><button class="btn danger" id="ascendBtn">è»¢ç”Ÿã™ã‚‹</button></div></div>
      </div>
    </section>
  </div>
</main>

<script>
// ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & å®šæ•°
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const RARITIES=[{name:'Common',color:'rar-Common',weight:60,mult:1},{name:'Uncommon',color:'rar-Uncommon',weight:25,mult:1.4},{name:'Rare',color:'rar-Rare',weight:10,mult:2},{name:'Epic',color:'rar-Epic',weight:4,mult:3},{name:'Legendary',color:'rar-Legendary',weight:1,mult:4.5}];
const MONSTER_POOL=[{name:'ã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸ‘¹'},{name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',emoji:'ğŸ’€'},{name:'ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸ¦‡'},{name:'ã‚ªã‚ªã‚«ãƒŸ',emoji:'ğŸº'},{name:'ã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸ«§'},{name:'ãƒŸã‚¤ãƒ©',emoji:'ğŸ§»'},{name:'é­”å°æ›¸',emoji:'ğŸ“•'},{name:'ç›®ç‰',emoji:'ğŸ‘ï¸'},{name:'ã‚µã‚½ãƒª',emoji:'ğŸ¦‚'}];
const BOSS_POOL=[{name:'ã‚ªãƒ¼ã‚¬',emoji:'ğŸ‘º'},{name:'ãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ²'},{name:'ãƒªãƒƒãƒ',emoji:'ğŸª¦'},{name:'ã‚±ãƒ«ãƒ™ãƒ­ã‚¹',emoji:'ğŸ¶'}];
const SAVE_KEY='tap_hns_save_v3', UI_MODE='ui_top_mode_v5';

// ====== çŠ¶æ…‹
const state={
  gold:0, level:1, exp:0, expToNext:20,
  floor:1, maxFloor:1, bestMaxFloor:1,
  kills:0, deaths:0,
  baseATK:1, baseHP:10, baseDEF:0, baseCRIT:5,
  autoTap:0,
  eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:false,
  monster:null, playerHP:10, bossEndsAt:0,
  souls:0, isDown:false, engaged:false, reviveAt:0, stay:false,
  pebbles:0, magicStones:0,
  upg:{atk:0,hp:0,auto:0},
  unlocks:{kashiwa:false},
  relicActive:{kashiwa:false},
  flavorIdx:0
};
const prices={atk:10,hp:10,auto:25};

// ====== UIå‚ç…§
const ui={
  c_gold:$('#c-gold'), c_level:$('#c-level'), c_exp:$('#c-exp'),
  x_floor:$('#x-floor'), x_level:$('#x-level'), x_exp:$('#x-exp'), x_hpbar:$('#x-hpbar'), x_hptext:$('#x-hptext'), x_atk:$('#x-atk'), x_gold:$('#x-gold'), x_souls:$('#x-souls'), x_crit:$('#x-crit'), timerAll:$('#timerAll'),
  toggleInfo:$('#toggleInfo'), topCollapsed:$('#top-collapsed'), topExpanded:$('#top-expanded'),
  floorBadge:$('#floorBadge'),
  monsterFace:$('#monsterFace'), monsterHP:$('#monsterHP'), monsterHPText:$('#monsterHPText'), monsterName:$('#monsterName'),
  attackBtn:$('#attackBtn'), nextBtn:$('#nextBtn'), fleeBtn:$('#fleeBtn'), logline:$('#logline'), floorHint:$('#floorHint'), stayCb:$('#stayCb'),
  tabs:$$('.tab'), tabUpg:$('#tab-upg'), tabInv:$('#tab-inv'), tabSta:$('#tab-sta'), tabRel:$('#tab-relics'), tabSys:$('#tab-sys'),
  costAtk:$('#costAtk'), costHP:$('#costHP'), costAuto:$('#costAuto'), buyAtk:$('#buyAtk'), buyHP:$('#buyHP'), buyAuto:$('#buyAuto'), autoRate:$('#autoRate'), upgGold:$('#upgGold'), lvAtk:$('#lvAtk'), lvHP:$('#lvHP'), lvAuto:$('#lvAuto'),
  invList:$('#invList'), eqWeapon:$('#eq-weapon'), eqArmor:$('#eq-armor'), eqRing:$('#eq-ring'), autoEquip:$('#autoEquip'),
  staAtk:$('#sta-atk'), staHP:$('#sta-hp'), staDef:$('#sta-def'), staCrit:$('#sta-crit'), staGoldB:$('#sta-goldb'), staSoulB:$('#sta-soulb'), staMaxFloor:$('#sta-maxfloor'), staKills:$('#sta-kills'), staDeaths:$('#sta-deaths'),
  staPeb:$('#sta-peb'), staGem:$('#sta-gem'), gemCount:$('#gemCount'),
  relicLockedCard:$('#relicLockedCard'), relicKashiwaCard:$('#relicKashiwaCard'), relicKashiwa:$('#relicKashiwa'),
  codeInput:$('#codeInput'), codeBtn:$('#codeBtn'), codeStatus:$('#codeStatus'),
  saveBtn:$('#saveBtn'), loadBtn:$('#loadBtn'), exportBtn:$('#exportBtn'), importBtn:$('#importBtn'), wipeBtn:$('#wipeBtn'), ioArea:$('#ioArea'), soulGain:$('#soulGain'), ascendBtn:$('#ascendBtn')
};

// ====== åŸºæœ¬é–¢æ•°
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function choice(a){return a[randInt(0,a.length-1)]}
function weightedPick(items){const t=items.reduce((s,i)=>s+i.weight,0);let r=Math.random()*t;for(const it of items){r-=it.weight; if(r<=0) return it;} return items[items.length-1];}
function soulMG(){return 1+state.souls*0.02}
function recalcMaxHP(){const armorHP=state.eq.armor?.hp??0;return Math.max(1,state.baseHP+armorHP)}
function playerATK(){const w=state.eq.weapon?.atk??0, r=state.eq.ring?.atk??0; return Math.max(1, Math.floor((state.baseATK+w+r)*soulMG()))}
function playerDEF(){return state.baseDEF+(state.eq.armor?.def??0)}
function playerCRIT(){return clamp(state.baseCRIT+(state.eq.ring?.crit??0),0,100)}
function goldB(){const rg=state.eq.ring?.goldB??0;return rg+(soulMG()-1)*100}
function clickDamage(){const c=Math.random()*100<playerCRIT(); let d=playerATK(); if(c)d=Math.floor(d*1.8); return {dmg:d,isCrit:c}}
function eHP(f,b){return Math.floor((14*Math.pow(f,1.18)+6)*(b?6:1))}
function eGold(f,b){return Math.floor((4*Math.pow(f,1.10)+2)*(b?4:1))}
function eATK(f,b){return Math.floor((1.2*Math.pow(f,1.05)+0.6)*(b?2:1))}
function cryptoId(){const a=new Uint32Array(2);(window.crypto||window.msCrypto).getRandomValues?.(a);return[...a].map(x=>x.toString(16)).join('')}

// ====== ã‚¢ã‚¤ãƒ†ãƒ 
function makeItem(f, minRarity){
  const kinds=['weapon','armor','ring']; const k=choice(kinds);
  const rar=weightedPick(RARITIES); const order={'Common':0,'Uncommon':1,'Rare':2,'Epic':3,'Legendary':4};
  let rarName=rar.name; if(minRarity && order[rarName]<order[minRarity]) rarName=minRarity;
  const mult=RARITIES.find(r=>r.name===rarName).mult; const bp=Math.max(1,Math.floor((Math.pow(f,1.12)+randInt(0,f))*0.5*mult));
  const it={id:cryptoId(),name:'',slot:k,rarity:rarName,color:RARITIES.find(r=>r.name===rarName).color,lvl:f,value:Math.max(1,Math.floor(bp*1.2))};
  if(k==='weapon'){ it.atk=Math.max(1,Math.floor(bp)); if(rarName!=='Common'&&Math.random()<0.35) it.crit=2+Math.floor(mult*2); it.name=`æ­¦å™¨ +${it.atk}`; }
  else if(k==='armor'){ it.hp=4*Math.max(1,Math.floor(bp*0.9)); if(rarName!=='Common'&&Math.random()<0.3) it.def=Math.floor(mult*1.2); it.name=`é§ +${it.hp}HP`; }
  else { const r=Math.random(); if(r<0.45){ it.crit=3+Math.floor(mult*2); it.name=`æŒ‡è¼ª ã‚¯ãƒª+${it.crit}%`; } else if(r<0.9){ it.atk=Math.max(1,Math.floor(bp*0.6)); it.name=`æŒ‡è¼ª ATK+${it.atk}`; } else { it.goldB=5+Math.floor(mult*4); it.name=`æŒ‡è¼ª Gold+${it.goldB}%`; } }
  it.name+=` (${rarName})`; return it;
}
function renderItemText(it){ const p=[]; if(it.atk)p.push(`ATK+${it.atk}`); if(it.hp)p.push(`HP+${it.hp}`); if(it.def)p.push(`é˜²å¾¡+${it.def}`); if(it.crit)p.push(`ã‚¯ãƒª+${it.crit}%`); if(it.goldB)p.push(`Gold+${it.goldB}%`); return `${it.name} [${p.join(', ')}]`; }
function scoreItem(it){ if(!it) return -1e9; let s=0; s+=(it.atk??0)*3+(it.hp??0)*0.4+(it.def??0)*2+(it.crit??0)*1.5+(it.goldB??0)*0.8; s+=(it.lvl??0)*0.2; const rar=RARITIES.find(r=>r.name===it.rarity); s*=rar?.mult??1; return s; }
function tryAutoEquip(it){ const s=it.slot,cur=state.eq[s]; if(scoreItem(it)>scoreItem(cur)){ state.eq[s]=it; toast(`è‡ªå‹•è£…å‚™ï¼š${renderItemText(it)}`); }}

// ====== ç”Ÿæˆ
function spawnMonster(){
  const f=state.floor, boss=(f%10===0); const pool=boss?BOSS_POOL:MONSTER_POOL; const base=choice(pool);
  // ãƒŸãƒŸãƒƒã‚¯æŠ½é¸
  const crit=playerCRIT(); const mimicP=Math.min(0.15,0.05+crit*0.0005); const superP=Math.min(0.05,0.02+crit*0.0003);
  let kind='normal'; const r=Math.random(); if(r<superP) kind='supermimic'; else if(r<superP+mimicP) kind='mimic';
  const hp0=eHP(f,boss), gold0=eGold(f,boss), atk0=eATK(f,boss);
  let mult=1, namePrefix='', emoji=base.emoji; if(kind==='mimic'){mult=1.05; namePrefix='ã€ãƒŸãƒŸãƒƒã‚¯ã€‘'; emoji='ğŸ§°';} if(kind==='supermimic'){mult=1.20; namePrefix='ã€è¶…ãƒŸãƒŸãƒƒã‚¯ã€‘'; emoji='âœ¨ğŸ§°';}
  const hp=Math.floor(hp0*mult), gold=gold0, atk=Math.floor(atk0*mult);
  state.monster={name:`${namePrefix}${boss?'ã€BOSSã€‘':''}Lv${f} ${base.name}`, emoji, hp, maxHP:hp, gold, atk, isBoss:boss, kind};
  state.engaged=false; state.isDown=false; state.reviveAt=0; state.bossEndsAt=0;
  ui.monsterFace.textContent=emoji; ui.monsterName.textContent=state.monster.name; ui.monsterHPText.textContent=`${hp} / ${hp}`; ui.monsterHP.style.width='100%'; ui.floorBadge.textContent=`éšå±¤ ${state.floor}`;
  ui.logline.textContent=boss?'ãƒœã‚¹å‡ºç¾ï¼æœ€åˆã®ä¸€æ’ƒã§æˆ¦é—˜é–‹å§‹':'ã‚¿ãƒƒãƒ—ã§æˆ¦é—˜é–‹å§‹';
  refreshFloorButtons(); updateAttackBtn();
}

// ====== å ±é…¬
function awardKill(){
  const m=state.monster;
  // ğŸ”¹çŸ³ã“ã‚ï¼ˆ5%ï¼‰ï¼šfloor//10 å€‹
  if(Math.random()<0.05){ const k=Math.floor(state.floor/10); if(k>0){ state.pebbles+=k; toast(`ğŸ”¹ è¼ãçŸ³ã“ã‚ +${k}`); }}
  const goldMult=(m.kind==='mimic')?10:(m.kind==='supermimic')?100:1;
  const expBase=Math.max(1,Math.floor(3+state.floor*0.6)); const expGain=expBase*goldMult;
  const goldGain=Math.floor(m.gold*goldMult*(1+goldB()/100));
  state.gold+=goldGain; state.kills+=1; state.exp+=expGain;
  while(state.exp>=state.expToNext){ state.exp-=state.expToNext; state.level+=1; state.expToNext=Math.floor(state.expToNext*1.25+8); state.baseATK+=1; state.baseHP+=2; ui.logline.textContent='ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ATK+1 / HP+2'; }
  // è£…å‚™
  if(m.kind==='mimic'||m.kind==='supermimic'){
    const minR=(m.kind==='mimic')?'Rare':'Epic'; const it=makeItem(state.floor,minR); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); toast(`ğŸ ${m.kind==='mimic'?'ãƒŸãƒŸãƒƒã‚¯':'è¶…ãƒŸãƒŸãƒƒã‚¯'}ï¼š${renderItemText(it)}`);
  }else{
    const luck=(state.eq.ring?.goldB??0)*0.2; const dropChance=0.20+luck/100; if(Math.random()<dropChance){ const it=makeItem(state.floor); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); toast(`ãƒ‰ãƒ­ãƒƒãƒ—ï¼š${renderItemText(it)}`);} else { toast(`+${goldGain}G / +${expGain}EXP`); }
  }
  if(state.floor>state.maxFloor) state.maxFloor=state.floor; if(state.maxFloor>state.bestMaxFloor) state.bestMaxFloor=state.maxFloor;
}

// ====== ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼ˆéª¨çµ„ã¿ï¼‰
function postKillFlavor(kills){
  if(kills>=2){
    // ã“ã“ã«ä»Šå¾Œãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¢—ã‚„ã™ï¼ˆstate.flavorIdx ãªã©ã§åˆ‡æ›¿ï¼‰
    ui.logline.textContent = `æ•µã‚’${kills}ä½“å€’ã—ãŸï¼`;
  }
}

// ====== æˆ¦é—˜
function updateAttackBtn(){ const m=state.monster; if(!m){ui.attackBtn.textContent='æ”»æ’ƒ'; return;} const expected=playerATK(); if(!state.engaged){ ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æˆ¦é—˜é–‹å§‹ï¼'; return;} ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰'; }
function refreshFloorButtons(){ const canUpByBest=state.floor<state.bestMaxFloor; const dead=state.monster && state.monster.hp<=0; ui.nextBtn.disabled=!(dead||canUpByBest); ui.floorHint.textContent=`æœ€é«˜åˆ°é”ï¼š${state.bestMaxFloor} éš`; }
function beginEngage(){ if(!state.engaged){ state.engaged=true; if(state.monster.isBoss&&state.bossEndsAt===0){ state.bossEndsAt=Date.now()+30000; } } }

function doSingleKillAndAdvance(){ awardKill(); if(state.stay){ spawnMonster(); } else { state.floor+=1; spawnMonster(); } }

function attack(){
  if(!state.monster) return; if(state.playerHP<=0){ toast('æ°—çµ¶ä¸­â€¦'); return; }
  beginEngage(); const m=state.monster; if(m.hp<=0) return;

  // === æŸã®åŠ è­·ï¼ˆã‚³ãƒ¼ãƒ‰ç‰¹å…¸ï¼‰ã®å‡¦ç†ï¼šã‚ªãƒ¼ãƒãƒ¼ã‚­ãƒ«ã§è¤‡æ•°ä½“è¨ä¼ ===
  if(state.relicActive.kashiwa){
    const atk = playerATK();
    if(atk > m.hp){
      let kills=0; let remaining = atk; let curHP = m.hp; // ã¾ãšç¾è¡Œå€‹ä½“
      if(remaining >= curHP){ remaining -= curHP; kills += 1; }
      // ä»¥é™ã¯åŒä¸€ãƒ•ãƒ­ã‚¢åŸºæº–HPã§å‰²ã‚‹
      const unit = m.maxHP; if(unit>0 && remaining>0){ kills += Math.floor(remaining / unit); }
      // å®Ÿè¡Œ
      for(let i=0;i<kills;i++){ doSingleKillAndAdvance(); }
      postKillFlavor(kills);
      updateAttackBtn(); refreshFloorButtons(); return;
    }
  }

  // === é€šå¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸ ===
  const {dmg,isCrit}=clickDamage(); const dealt=Math.min(m.hp,dmg); m.hp-=dealt; ui.monsterHP.style.width=`${(m.hp/m.maxHP)*100}%`; ui.monsterHPText.textContent=`${m.hp} / ${m.maxHP}`; ui.logline.textContent=isCrit?`ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ -${dealt}`:`-${dealt}`;
  if(m.hp<=0){ doSingleKillAndAdvance(); }
  updateAttackBtn(); refreshFloorButtons();
}

function enemyTick(dt){ if(!state.monster||!state.engaged||state.isDown) return; const m=state.monster; if(m.hp<=0) return; const dps=Math.max(0,m.atk-playerDEF()*0.6); const dmg=dps*dt; if(dmg<=0) return; state.playerHP-=dmg; if(state.playerHP<=0&&!state.isDown){ state.playerHP=0; state.isDown=true; state.deaths+=1; state.reviveAt=Date.now()+5000; ui.logline.textContent='æ°—çµ¶ã—ã¾ã—ãŸâ€¦5ç§’å¾Œã«å¾©æ´»'; } }
function regenTick(dt){ if(state.playerHP>0){ const mx=recalcMaxHP(); state.playerHP=clamp(state.playerHP+dt*(0.8+state.level*0.02),0,mx); } }
function autoTapTick(dt){ if(state.autoTap<=0||!state.engaged||state.isDown) return; autoTapTick._acc=(autoTapTick._acc||0)+state.autoTap*dt; while(autoTapTick._acc>=1){ autoTapTick._acc-=1; attack(); } }
function timersTick(){ let txt=[]; if(state.reviveAt>0){ const left=Math.max(0,state.reviveAt-Date.now()); txt.push(`å¾©æ´»ã¾ã§ ${Math.ceil(left/1000)}s`); if(left<=0){ state.reviveAt=0; state.playerHP=recalcMaxHP(); state.isDown=false; state.engaged=false; ui.logline.textContent='å¾©æ´»ï¼'; updateAttackBtn(); } } if(state.bossEndsAt>0){ const left=Math.max(0,state.bossEndsAt-Date.now()); txt.push(`ãƒœã‚¹æ®‹ã‚Š ${Math.ceil(left/1000)}s`); if(left<=0){ state.bossEndsAt=0; toast('ãƒœã‚¹è¨ä¼å¤±æ•—â€¦1éšæˆ»ã‚‹'); state.floor=Math.max(1,state.floor-1); spawnMonster(); } } ui.timerAll.textContent=txt.join(' / '); }
function toast(m){ ui.logline.textContent=m }

// ====== UIæ›´æ–°
function updateUI(){ ui.c_gold.textContent=Math.floor(state.gold); ui.c_level.textContent=state.level; ui.c_exp.textContent=`${state.exp}/${state.expToNext}`; ui.x_floor.textContent=state.floor; ui.x_level.textContent=state.level; ui.x_exp.textContent=`${state.exp}/${state.expToNext}`; ui.x_atk.textContent=playerATK(); ui.x_gold.textContent=Math.floor(state.gold); ui.x_souls.textContent=state.souls; ui.x_crit.textContent=`${Math.floor(playerCRIT())}%`;
  const mx=recalcMaxHP(); const pct=clamp(state.playerHP/mx*100,0,100); ui.x_hpbar.style.width=`${pct}%`; ui.x_hptext.textContent=`${Math.floor(state.playerHP)}/${mx}`;
  ui.upgGold.textContent=Math.floor(state.gold); ui.lvAtk.textContent=state.upg.atk; ui.lvHP.textContent=state.upg.hp; ui.lvAuto.textContent=state.upg.auto;
  if(ui.staAtk){ ui.staAtk.textContent=playerATK(); ui.staHP.textContent=recalcMaxHP(); ui.staDef.textContent=playerDEF(); ui.staCrit.textContent=`${Math.floor(playerCRIT())}%`; ui.staGoldB.textContent=`${Math.floor(goldB())}%`; ui.staSoulB.textContent=`${Math.floor((soulMG()-1)*100)}%`; ui.staMaxFloor.textContent=state.maxFloor; ui.staKills.textContent=state.kills; ui.staDeaths.textContent=state.deaths; ui.staPeb.textContent=state.pebbles; ui.staGem.textContent=state.magicStones; }
  if(ui.gemCount) ui.gemCount.textContent=state.magicStones;
  ui.costAtk.textContent=prices.atk; ui.costHP.textContent=prices.hp; ui.costAuto.textContent=prices.auto; ui.autoRate.textContent=state.autoTap.toFixed(1);
  ui.floorBadge.textContent=`éšå±¤ ${state.floor}`; updateAttackBtn(); refreshFloorButtons();
  // è–éºç‰©è¡¨ç¤ºåˆ‡æ›¿
  if(state.unlocks.kashiwa){ ui.relicLockedCard.setAttribute('hidden',''); ui.relicKashiwaCard.removeAttribute('hidden'); ui.relicKashiwa.checked=!!state.relicActive.kashiwa; }
  else{ ui.relicLockedCard.removeAttribute('hidden'); ui.relicKashiwaCard.setAttribute('hidden',''); }
}

function renderInventory(){ const box=ui.invList; if(!box) return; box.innerHTML=''; for(const it of state.inv){ const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div><b class="${it.color}">${it.name}</b></div><div class="small">${renderItemText(it)}</div>`; const row=document.createElement('div'); row.className='row'; const e=document.createElement('button'); e.className='btn'; e.textContent='è£…å‚™'; e.onclick=()=>{ state.eq[it.slot]=it; toast(`è£…å‚™ï¼š${renderItemText(it)}`); updateUI(); }; const s=document.createElement('button'); s.className='btn gold'; s.textContent=`å£²å´ (+${Math.floor(it.value)}G)`; s.onclick=()=>{ state.gold+=Math.floor(it.value); state.inv=state.inv.filter(x=>x!==it); renderInventory(); updateUI(); }; row.appendChild(e); row.appendChild(s); div.appendChild(row); box.appendChild(div); } }

// ====== è³¼å…¥ãƒ»ä¿å­˜
function buy(k,cb){ const c=prices[k]; if(state.gold<c){ toast('ãŠé‡‘ãŒè¶³ã‚Šãªã„â€¦'); return; } state.gold-=c; cb(); prices[k]=Math.floor(prices[k]*1.35+2); updateUI(); }
function save(manual=false){ const data=JSON.stringify({state:{...state,bossEndsAt:state.bossEndsAt>0?Date.now()+Math.max(0,state.bossEndsAt-Date.now()):0,reviveAt:state.reviveAt>0?Date.now()+Math.max(0,state.reviveAt-Date.now()):0},prices}); localStorage.setItem(SAVE_KEY,data); if(manual) toast('ä¿å­˜ã—ã¾ã—ãŸ'); if(ui.ioArea) ui.ioArea.value=data; }
function load(manual=false){ const raw=localStorage.getItem(SAVE_KEY); if(!raw){ if(manual) toast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; } try{ const o=JSON.parse(raw); Object.assign(state,o.state); Object.assign(prices,o.prices||{}); state.upg=state.upg||{atk:0,hp:0,auto:0}; state.unlocks=state.unlocks||{kashiwa:false}; state.relicActive=state.relicActive||{kashiwa:false}; state.playerHP=clamp(state.playerHP,0,recalcMaxHP()); ui.autoEquip&&(ui.autoEquip.checked=!!state.autoEquip); ui.stayCb&&(ui.stayCb.checked=!!state.stay); spawnMonster(); renderInventory(); updateUI(); if(manual) toast('èª­è¾¼ã—ã¾ã—ãŸ'); }catch(e){ console.error(e); toast('èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); } }
function exportSave(){ save(false); const raw=localStorage.getItem(SAVE_KEY); if(ui.ioArea) ui.ioArea.value=raw||''; toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ¬„ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ'); }
function importSave(){ const raw=ui.ioArea?.value.trim(); if(!raw){ toast('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™'); return; } try{ JSON.parse(raw); localStorage.setItem(SAVE_KEY,raw); load(false); toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼†èª­è¾¼ã—ã¾ã—ãŸ'); }catch(e){ toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONãŒä¸æ­£ã§ã™'); } }
function wipeAll(){ if(!confirm('æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return; localStorage.removeItem(SAVE_KEY); location.reload(); }
function ascend(){ const g=Math.floor(state.maxFloor/30); if(g<=0){ toast('è»¢ç”Ÿã§ãã‚‹ã»ã©é€²ã‚“ã§ã„ã¾ã›ã‚“'); return; } if(!confirm(`è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿç²å¾—ã‚½ã‚¦ãƒ«ï¼š${g}`)) return; state.souls+=g; state.magicStones+=state.pebbles; state.pebbles=0; const keepBest=Math.max(state.bestMaxFloor,state.maxFloor), keepSouls=state.souls; Object.assign(state,{ gold:0,level:1,exp:0,expToNext:20,floor:1,maxFloor:1,kills:0,deaths:0, baseATK:1,baseHP:10,baseDEF:0,baseCRIT:5, autoTap:0, eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:state.autoEquip, monster:null, playerHP:10,bossEndsAt:0, souls:keepSouls, bestMaxFloor:keepBest, isDown:false, engaged:false, reviveAt:0, stay:state.stay, pebbles:0, magicStones:state.magicStones, upg:state.upg, unlocks:state.unlocks, relicActive:state.relicActive }); prices.atk=10; prices.hp=10; prices.auto=25; spawnMonster(); updateUI(); renderInventory(); toast('è»¢ç”Ÿï¼ğŸ”¹â†’ğŸ”® å¤‰æ›å®Œäº† & æ’ä¹…ãƒœãƒ¼ãƒŠã‚¹UP'); }

// ====== å…¥åŠ›ç³»ï¼ˆé€£æ‰“OKï¼é•·æŠ¼ã—ä¸€ç™ºï¼‰
let _holding=false,_t=0,_saw=false; function onPD(e){ e.preventDefault(); _saw=true; _t=Date.now(); if(_holding) return; _holding=true; attack(); } function onPU(){ _holding=false; }
function bindInput(el){ if(window.PointerEvent){ el.addEventListener('pointerdown',onPD,{passive:false}); el.addEventListener('pointerup',onPU); el.addEventListener('pointercancel',onPU); el.addEventListener('pointerleave',onPU);} else { el.addEventListener('click',()=>{ if(_saw && Date.now()-_t<200) return; attack(); }); } }

bindInput(ui.attackBtn); bindInput($('#monster'));
document.addEventListener('dblclick',e=>e.preventDefault(),{passive:false});

// ====== ãƒ•ãƒ­ã‚¢ç§»å‹•
ui.nextBtn.addEventListener('click',()=>{ const canUpByBest=state.floor<state.bestMaxFloor; const dead=state.monster && state.monster.hp<=0; if(!(dead||canUpByBest)){ toast('ã¾ã é€²ã‚ãªã„â€¦'); return; } state.floor+=1; state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI(); });
ui.fleeBtn.addEventListener('click',()=>{ state.floor=Math.max(1,state.floor-1); state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; state.bossEndsAt=0; spawnMonster(); updateUI(); });
ui.stayCb.addEventListener('change',e=>{ state.stay=e.target.checked; });

// ====== å¼·åŒ–
ui.buyAtk.addEventListener('click',()=>buy('atk',()=>{ state.baseATK+=1; state.upg.atk++; updateAttackBtn(); }));
ui.buyHP.addEventListener('click',()=>buy('hp',()=>{ state.baseHP+=5; state.upg.hp++; state.playerHP=recalcMaxHP(); }));
ui.buyAuto.addEventListener('click',()=>buy('auto',()=>{ state.autoTap=parseFloat((state.autoTap+0.2).toFixed(1)); state.upg.auto++; }));
ui.autoEquip&&ui.autoEquip.addEventListener('change',e=>{ state.autoEquip=e.target.checked; });

// ====== è–éºç‰©ãƒ»ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆ
ui.codeBtn.addEventListener('click',()=>{
  const code=(ui.codeInput.value||'').trim(); if(!code){ ui.codeStatus.textContent='ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  if(code==='kashiwa060925'){
    if(state.unlocks.kashiwa){ ui.codeStatus.textContent='ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨æ¸ˆã¿ã§ã™'; return; }
    state.unlocks.kashiwa=true; ui.codeStatus.textContent='ğŸƒ æŸã®åŠ è­·ã‚’ç²å¾—ï¼ è–éºç‰©ã‚¿ãƒ–ã§æœ‰åŠ¹åŒ–ã§ãã¾ã™'; updateUI(); save(false);
  }else{ ui.codeStatus.textContent='ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™'; }
});
ui.relicKashiwa&&ui.relicKashiwa.addEventListener('change',e=>{ state.relicActive.kashiwa=e.target.checked; });

// ====== ä¿å­˜ç³»
ui.saveBtn&&ui.saveBtn.addEventListener('click',()=>save(true)); ui.loadBtn&&ui.loadBtn.addEventListener('click',()=>load(true)); ui.exportBtn&&ui.exportBtn.addEventListener('click',exportSave); ui.importBtn&&ui.importBtn.addEventListener('click',importSave); ui.wipeBtn&&ui.wipeBtn.addEventListener('click',wipeAll); ui.ascendBtn&&ui.ascendBtn.addEventListener('click',ascend);

// ====== ã‚¿ãƒ–
ui.tabs.forEach(t=>{ t.addEventListener('click',()=>{ ui.tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const id=t.dataset.tab; [ui.tabUpg,ui.tabInv,ui.tabSta,ui.tabRel,ui.tabSys].forEach(el=>el.setAttribute('hidden','')); document.getElementById(id).removeAttribute('hidden'); }); });

// ====== ãƒ«ãƒ¼ãƒ— & èµ·å‹•
function applyCollapsed(col){ if(col){ ui.topCollapsed.removeAttribute('hidden'); ui.topExpanded.setAttribute('hidden',''); ui.toggleInfo.setAttribute('aria-expanded','false'); ui.toggleInfo.textContent='â–¼ è©³ç´°'; } else { ui.topCollapsed.setAttribute('hidden',''); ui.topExpanded.removeAttribute('hidden'); ui.toggleInfo.setAttribute('aria-expanded','true'); ui.toggleInfo.textContent='â–² é–‰ã˜ã‚‹'; } localStorage.setItem(UI_MODE,col?'1':'0'); }
ui.toggleInfo.addEventListener('click',()=>{ const col=ui.toggleInfo.getAttribute('aria-expanded')==='true'; applyCollapsed(col); });
let last=performance.now(); function loop(now){ const dt=Math.min(0.1,(now-last)/1000); last=now; autoTapTick(dt); enemyTick(dt); regenTick(dt); timersTick(); updateUI(); requestAnimationFrame(loop); }
(function init(){ applyCollapsed(localStorage.getItem(UI_MODE)!=='0'); if(localStorage.getItem(SAVE_KEY)) load(false); else spawnMonster(); ui.stayCb.checked=state.stay; renderInventory(); updateUI(); requestAnimationFrame(loop); setInterval(()=>save(false),10000); window.addEventListener('beforeunload',()=>save(false)); })();
</script>
</body>
</html>